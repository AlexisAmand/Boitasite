<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Exemples avec deux tables</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="sdodasrel.examples.one-table.html">« Exemples avec une table</a></li>
      <li style="float: right;"><a href="sdodasrel.examples.three-table.html">Exemple avec trois tables »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="sdodasrel.examples.html">Exemples</a></li>
    <li>Exemples avec deux tables</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="sdodasrel.examples.two-table" class="section">
  <h2 class="title">Exemples avec deux tables</h2>
  <p class="para">
   Les exemples suivants utilisent tous deux tables de la base de données
   compagnie : les tables compagnie et departement. Ces exemples montrent
   plus le fonctionnement de DAS Relationnel.
  </p>
  <p class="para">
   Dans cette série d&#039;exemples, une compagnie et un département son créé,
   récupéré, mis à jour et finalement supprimé. Ceci montre le cycle de vie
   pour un graphique de données contenant plus d&#039;un objet. Notez que cet
   exemple vide les tables compagnie et departement au démarrage, ainsi
   les résultats exacts des requêtes peuvent être connus.
  </p>
  <p class="para">
   Vous pouvez trouvez ces exemples combinés dans un script appelé
   <var class="filename">1cd-CRUD</var> dans le répertoire <var class="filename">Scenarios</var>
   du paquetage DAS Relationnel.
  </p>

  <p class="para">
   <div class="example" id="example-6099">
    <p><strong>Exemple #1 Une compagnie, un département - Création</strong></p>
    <div class="example-contents"><p>
     Comme dans l&#039;exemple précédent où l&#039;on créait juste un objet de données
     de compagnie, la première action après la construction du DAS
     Relationnel est d&#039;appeler <span class="function"><strong>createRootDataObject()</strong></span>
     pour obtenir l&#039;objet racine spécial du graphique de données vide.
     L&#039;objet compagnie est alors créé en tant que fils de cet objet racine,
     et l&#039;objet departement en tant que fils de l&#039;objet compagnie.
    </p></div>
    <div class="example-contents"><p>
     Lorsqu&#039;il est venu le temps d&#039;appliquer les changements, le DAS Relationnel doit
     effectuer des traitements spéciaux pour maintenir la clé étrangère qui
     supporte les relations contenues, en particulier si une clé
     primaire générée automatiquement est en jeu. Dans cet exemple, les
     relations entre la clé primaire générée automatiquement
     <var class="varname">id</var> dans la table compagnie et la colonne
     <var class="varname">co_id</var> dans la table departement doivent être maintenues.
     Lors de l&#039;insertion de la compagnie et du département pour la première
     fois, le DAS Relationnel doit premièrement insérer une ligne de compagnie,
     ensuite appeler la méthode de PDO <span class="function"><strong>getLastInsertId()</strong></span>
     pour obtenir la clé primaire générée automatiquement, et ensuite
     ajouter la valeur à la colonne <var class="varname">co_id</var>
     lors de l&#039;insertion de la ligne departement.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">require_once&nbsp;</span><span style="color: #DD0000">'SDO/DAS/Relational.php'</span><span style="color: #007700">;<br />require_once&nbsp;</span><span style="color: #DD0000">'company_metadata.inc.php'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*************************************************************************************<br />*&nbsp;Vidage&nbsp;des&nbsp;deux&nbsp;tables<br />*************************************************************************************/<br /></span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO_DSN</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_USER</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_PASSWORD</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$pdo_stmt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'DELETE&nbsp;FROM&nbsp;COMPAGNIE;'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$rows_affected&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$pdo_stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$pdo_stmt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">'DELETE&nbsp;FROM&nbsp;DEPARTEMENT;'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$rows_affected&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$pdo_stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">/**************************************************************<br />*&nbsp;Crée&nbsp;une&nbsp;compagnie&nbsp;avec&nbsp;le&nbsp;nom&nbsp;Acme&nbsp;et&nbsp;un&nbsp;département,&nbsp;département&nbsp;de&nbsp;Chaussure<br />***************************************************************/<br /></span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO_DSN</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_USER</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_PASSWORD</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">SDO_DAS_Relational&nbsp;</span><span style="color: #007700">(</span><span style="color: #0000BB">$database_metadata</span><span style="color: #007700">,</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">,</span><span style="color: #0000BB">$SDO_containment_metadata</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$root&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">createRootDataObject</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$acme&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$root&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">createDataObject</span><span style="color: #007700">(</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$acme&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">nom&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"Acme"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$chaussure&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$acme</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">createDataObject</span><span style="color: #007700">(</span><span style="color: #DD0000">'departement'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$chaussure</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">nom&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'Chaussure'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">applyChanges</span><span style="color: #007700">(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$root</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>

  <p class="para">
   <div class="example" id="example-6100">
    <p><strong>Exemple #2 Une compagnie, un département - Récupération et Mise à jour</strong></p>

    <div class="example-contents"><p>
     Dans ce cas, la requête SQL passé à
     <span class="function"><strong>executeQuery()</strong></span>
     exécute un inner join pour joindre les données des tables compagnie et
     departement. Les clés primaires pour les tables compagnie et
     departement doivent être incluses dans la requête. Le jeu de résultats
     est normalisé de nouveau pour former un graphique de données normalisé. Notez
     que le spécificateur de colonne est passé en troisième argument de
     l&#039;appel
     <span class="function"><strong>executeQuery()</strong></span>
     qui autorise DAS Relationnel de savoir quelle colonne est laquelle dans
     le jeu de résultats.
    </p></div>
    <div class="example-contents"><p>
     Notez que la colonne
     <var class="varname">co_id</var>
     bien qu&#039;utilisée dans la requête n&#039;est pas requis dans le jeu de
     résultats. Afin de comprendre que fait DAS Relationnel lorsqu&#039;il
     construit le graphique de données, il peut être utile de visualiser
     à quoi ressemble les jeu de résultats. Bien que les données dans la
     base de données sont normalisée, alors plusieurs lignes de département
     peuvent pointer vers la clé étrangère d&#039;une ligne de compagnie, les
     données dans le jeu de résultats sont non-normalisée : c&#039;est, s&#039;il y a
     une compagnie et de multiples département, les valeurs pour la
     compagnie qui sont répétées à chaque ligne. Le DAS Relationnel doit
     renverser ce processus et retourner le jeu de résultats dans un graphique
     normalisé, avec seulement un objet compagnie.
    </p></div>
    <div class="example-contents"><p>
     Dans cet exemple, le DAS Relationnel examine le jeu de résultats et le
     spécificateur de colonne, trouve les données pour les tables compagnie
     et departement, trouve les clés primaires pour les deux et interprète
     chaque ligne comme contenant des données d&#039;un département et comme
     parent compagnie. S&#039;il n&#039;a pas vue de données de la compagnie
     auparavant (il utilise la clé primaire pour vérifier), il crée un objet
     compagnie et ensuite l&#039;objet compagnie sous lui. S&#039;il a vu des données
     pour la compagnie avant et a déjà créé l&#039;objet compagnie, il crée
     simplement l&#039;objet departement sous lui.
    </p></div>

    <div class="example-contents"><p>
     De cette manière, le DAS Relationnel peut récupérer et normaliser de
     nouveau les données pour de multiples compagnies et de multiples
     départements sous ceux-ci.
    </p></div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">require_once&nbsp;</span><span style="color: #DD0000">'SDO/DAS/Relational.php'</span><span style="color: #007700">;<br />require_once&nbsp;</span><span style="color: #DD0000">'company_metadata.inc.php'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/**************************************************************<br />&nbsp;*&nbsp;Récupération&nbsp;de&nbsp;la&nbsp;compagnie&nbsp;et&nbsp;du&nbsp;département&nbsp;de&nbsp;Chaussure,&nbsp;ensuite<br />&nbsp;*&nbsp;supprime&nbsp;Chaussure&nbsp;et&nbsp;ajoute&nbsp;IT<br />&nbsp;***************************************************************/<br /></span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO_DSN</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_USER</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_PASSWORD</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">SDO_DAS_Relational&nbsp;</span><span style="color: #007700">(</span><span style="color: #0000BB">$database_metadata</span><span style="color: #007700">,</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">,</span><span style="color: #0000BB">$SDO_containment_metadata</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$root&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$das</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">executeQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">,<br /></span><span style="color: #DD0000">'select&nbsp;c.id,&nbsp;c.nom,&nbsp;d.id,&nbsp;d.nom&nbsp;from&nbsp;compagnie&nbsp;Â«c,&nbsp;departement&nbsp;d&nbsp;where&nbsp;d.co_id&nbsp;=&nbsp;c.id'</span><span style="color: #007700">,<br />array(</span><span style="color: #DD0000">'compagnie.id'</span><span style="color: #007700">,</span><span style="color: #DD0000">'compagnie.nom'</span><span style="color: #007700">,</span><span style="color: #DD0000">'departement.id'</span><span style="color: #007700">,</span><span style="color: #DD0000">'departement.nom'</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">$acme&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$root</span><span style="color: #007700">[</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;récupère&nbsp;la&nbsp;première&nbsp;compagnie&nbsp;-&nbsp;sera&nbsp;'Acme'<br /></span><span style="color: #0000BB">$chaussure&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$acme</span><span style="color: #007700">[</span><span style="color: #DD0000">'departement'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;récupère&nbsp;le&nbsp;premier&nbsp;département&nbsp;en&nbsp;dessous&nbsp;-&nbsp;sera&nbsp;'Chaussure'<br /><br /></span><span style="color: #007700">unset(</span><span style="color: #0000BB">$acme</span><span style="color: #007700">[</span><span style="color: #DD0000">'departement'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /><br /></span><span style="color: #0000BB">$it&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$acme</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">createDataObject</span><span style="color: #007700">(</span><span style="color: #DD0000">'departement'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$it</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'IT'</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">applyChanges</span><span style="color: #007700">(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$root</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>

  <p class="para">
   <div class="example" id="example-6101">
    <p><strong>Exemple #3 Une compagnie, deux départements - Récupération et Suppression</strong></p>
    <div class="example-contents"><p>
     Dans cet exemple, la compagnie et le département sont récupérés et
     ensuite supprimés. Il n&#039;est pas nécessaire de les supprimer
     individuellement (bien que cela est possible) - la suppression de
     l&#039;objet compagnie du graphique de données supprime aussi tous les
     départements sous lui.
    </p></div>
    <div class="example-contents"><p>
     Notez le moyen de l&#039;objet compagnie est actuellement supprimé en
     utilisant l&#039;appel unset de PHP. La suppression doit être effectuée
     sur la propriété qui est dans ce cas la propriété de compagnie sur
     l&#039;objet racine spécial. Vous devez utiliser :
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">unset(</span><span style="color: #0000BB">$root</span><span style="color: #007700">[</span><span style="color: #DD0000">'company'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     et non pas :
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">unset(</span><span style="color: #0000BB">$acme</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//FAUX<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     La suppression de <var class="varname">$acme</var>
     détruira simplement la variable mais laissera les données dans le
     graphique intacte.
    </p></div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">require_once&nbsp;</span><span style="color: #DD0000">'SDO/DAS/Relational.php'</span><span style="color: #007700">;<br />require_once&nbsp;</span><span style="color: #DD0000">'company_metadata.inc.php'</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/**************************************************************<br />&nbsp;*&nbsp;Récupération&nbsp;de&nbsp;la&nbsp;compagnie&nbsp;et&nbsp;du&nbsp;département&nbsp;IT,&nbsp;ensuite&nbsp;supprime&nbsp;la<br />&nbsp;*&nbsp;compagnie&nbsp;entière<br />&nbsp;***************************************************************/<br /></span><span style="color: #0000BB">$dbh&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO_DSN</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_USER</span><span style="color: #007700">,</span><span style="color: #0000BB">DATABASE_PASSWORD</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">SDO_DAS_Relational&nbsp;</span><span style="color: #007700">(</span><span style="color: #0000BB">$database_metadata</span><span style="color: #007700">,</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">,</span><span style="color: #0000BB">$SDO_containment_metadata</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$root&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$das</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">executeQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">,<br /></span><span style="color: #DD0000">'select&nbsp;c.id,&nbsp;c.nom,&nbsp;d.id,&nbsp;d.nom&nbsp;from&nbsp;compagnie&nbsp;c,&nbsp;departement&nbsp;d&nbsp;where&nbsp;d.co_id&nbsp;=&nbsp;c.id'</span><span style="color: #007700">,<br />array(</span><span style="color: #DD0000">'compagnie.id'</span><span style="color: #007700">,</span><span style="color: #DD0000">'compagnie.nom'</span><span style="color: #007700">,</span><span style="color: #DD0000">'departement.id'</span><span style="color: #007700">,</span><span style="color: #DD0000">'departement.nom'</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">$acme&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$root</span><span style="color: #007700">[</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$it&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$acme</span><span style="color: #007700">[</span><span style="color: #DD0000">'departement'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br /><br />unset(</span><span style="color: #0000BB">$root</span><span style="color: #007700">[</span><span style="color: #DD0000">'compagnie'</span><span style="color: #007700">][</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /><br /></span><span style="color: #0000BB">$das&nbsp;</span><span style="color: #007700">-&gt;&nbsp;</span><span style="color: #0000BB">applyChanges</span><span style="color: #007700">(</span><span style="color: #0000BB">$dbh</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$root</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div></div></div></body></html>