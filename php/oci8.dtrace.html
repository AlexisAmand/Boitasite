<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>OCI8 et le suivi dynamique DTrace</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="oci8.taf.html">« OCI8 Transparent Application Failover (TAF) Support</a></li>
      <li style="float: right;"><a href="oci8.datatypes.html">Types de donn&eacute;es support&eacute;es par le driver »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.oci8.html">OCI8</a></li>
    <li>OCI8 et le suivi dynamique DTrace</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="oci8.dtrace" class="chapter">
 <h1>OCI8 et le suivi dynamique DTrace</h1>

 <div class="section">
  <p class="para">
   OCI8 2.0 introduit DTrace qui peut être utilisé sur les systèmes qui
   supporte DTrace. Voir le <a href="features.dtrace.html" class="link">suivi dynamique
   DTrace</a> pour un aperçu de PHP et DTrace.
  </p>
 </div>

<div class="section">
 <h2 class="title">Installation d&#039;OCI8 avec le support DTrace</h2>
  <p class="para">
   Pour activer le support DTrace en PHP OCI8, vous devez compiler
   OCI8 comme extension partagée, après avoir configuré
   <code class="literal">PHP_DTRACE</code>.
  </p>
  <p class="para">
   <div class="informalexample">
    <div class="example-contents screen">
<div class="cdata"><pre>
$ export PHP_DTRACE=yes
$ pecl install oci8
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Editez php.ini, définissez l&#039;option
   <a href="ini.core.html#ini.extension-dir" class="link">extension_dir</a> pour correspondre
   au dossier contenant le fichier <var class="filename">oci8.so</var> créé,
   et activez l&#039;extension en ajoutant :
  </p>
  <p class="para">
   <div class="informalexample">
    <div class="example-contents screen">
<div class="cdata"><pre>
extension=oci8.so
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Si vous installez PHP OCI8 2.0 depuis PECL en utilisant
   <var class="filename">phpize</var> et
   <var class="filename">configure</var> (au lieu de <var class="filename">pecl</var>),
   vous devez définir <code class="literal">PHP_DTRACE=yes</code>. Ceci en raison
   du fait que l&#039;option <code class="literal">--enable-dtrace</code> sera ignoré par
   une limitation du script <var class="filename">configure</var> du paquet PECL.
  </p>

  <p class="para">
   Voir <a href="install.pecl.html" class="link">l&#039;installation d&#039;une extension PECL</a>
   pour les instructions générales d&#039;installation PECL.
  </p>
 </div>

 <div class="section">
  <h2 class="title">Découverte statique DTrace en PHP OCI8</h2>
  <table class="doctable table">
   <caption><strong>Les découvertes statiques suivantes sont disponibles en PHP OCI8</strong></caption>
   
    <thead>
     <tr>
      <th>Nom de la découverte</th>
      <th>Description de la découverte</th>
      <th>Arguments de la découverte</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td><code class="literal">oci8-connect-entry</code></td>
      <td>Initialisé par oci_connect(), oci_pconnect() et oci_new_connect().
       Lancé avant que la connexion à la base de données ne soit établie.</td>
      <td>char *<var class="varname">username</var>, char *<var class="varname">dbname</var>,
       char *<var class="varname">charset</var>, long <var class="varname">session_mode</var>,
       int <var class="varname">persistent</var>, int <var class="varname">exclusive</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connect-return</code></td>
      <td>Lancé à la fin de la connexion.</td>
      <td>void *<var class="varname">connection</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-check-connection</code></td>
      <td>Lancé si une erreur Oracle a fait que la connexion est devenue invalide.</td>
      <td>void *<var class="varname">connection</var>, char *<var class="varname">client_id</var>, int <var class="varname">is_open</var>, long <var class="varname">errcode</var>, unsigned long <var class="varname">server_status</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-sqltext</code></td>
      <td>Lancé lorsque oci_parse() est exécuté.</td>
      <td>void *<var class="varname">connection</var>, char *<var class="varname">client_id</var>, void *<var class="varname">statement</var>, char *<var class="varname">sql</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connection-close</code></td>
      <td>Lancé lorsque la connexion à la base de données est totalement détruite.</td>
      <td>void *<var class="varname">connection</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-error</code></td>
      <td>Lancé si une erreur Oracle survient.</td>
      <td>int <var class="varname">status</var>, long <var class="varname">errcode</var></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-execute-mode</code></td>
      <td>Lancé lors d&#039;un appel à <span class="function"><a href="function.oci-execute.html" class="function">oci_execute()</a></span> pour afficher le mode d&#039;exécution.</td>
      <td>void *<var class="varname">connection</var>, char *<var class="varname">client_id</var>, void *<var class="varname">statement</var>, unsigned int <var class="varname">mode</var></td>
     </tr>

    </tbody>
   
  </table>

  <p class="para">
   Ces découvertes sont utiles pour suivre les scripts OCI8.
  </p>

  <p class="para">
   Les variables <var class="varname">connection</var> et <var class="varname">statement</var>
   sont des pointeurs vers les structures internes utilisées pour suivre les connexions
   PHP et les requêtes exécutées.
  </p>

  <p class="para">
    La variable <var class="varname">client_id</var> est la valeur définie par
    <span class="function"><a href="function.oci-set-client-identifier.html" class="function">oci_set_client_identifier()</a></span>.
  </p>

  <p class="para">
  </p>

  <p class="para">
  </p>

  <p class="para">
  </p>


  <p class="para">
   Le coeur de PHP a aussi des découvertes statiques.
   Voir <a href="features.dtrace.dtrace.html#features.dtrace.static-probes" class="link">les découvertes statiques DTrace
   dans le coeur PHP</a>.
  </p>

  <table class="doctable table">
   <caption><strong>Découvertes DTrace pour le débogage interne en OCI8</strong></caption>
   
    <thead>
     <tr>
      <th>Nom de la découverte</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td><code class="literal">oci8-connect-expiry</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connect-lookup</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connect-p-dtor-close</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connect-p-dtor-release</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-connect-type</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-sesspool-create</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-sesspool-stats</code></td>
     </tr>

     <tr>
      <td><code class="literal">oci8-sesspool-type</code></td>
     </tr>

    </tbody>
   
  </table>

  <p class="para">
   Ces découvertes sont utiles pour les mainteneurs OCI8. Référez-vous
   au code source d&#039;OCI8 pour les arguments et pour voir quand elles sont
   lancées.
  </p>
 </div>

 <div class="section">
  <h2 class="title">Liste des découvertes statiques DTraceen PHP OCI8</h2>
  <p class="para">
   Pour lister toutes les découvertes disponibles, démarrez un processus PHP et exécutez :
   <div class="informalexample">
    <div class="example-contents">
<div class="cdata"><pre>
# dtrace -l
</pre></div>
    </div>

   </div>
  </p>
  
  <p class="para">
   L&#039;affiche sera similaire à :
   <div class="informalexample">
    <div class="example-contents">
<div class="cdata"><pre>
   ID   PROVIDER            MODULE                          FUNCTION NAME
   [ . . . ]
   17 phpoci22116           oci8.so   php_oci_dtrace_check_connection oci8-check-connection
   18 phpoci22116           oci8.so                php_oci_do_connect oci8-connect-entry
   19 phpoci22116           oci8.so         php_oci_persistent_helper oci8-connect-expiry
   20 phpoci22116           oci8.so             php_oci_do_connect_ex oci8-connect-lookup
   21 phpoci22116           oci8.so  php_oci_pconnection_list_np_dtor oci8-connect-p-dtor-close
   22 phpoci22116           oci8.so  php_oci_pconnection_list_np_dtor oci8-connect-p-dtor-release
   23 phpoci22116           oci8.so                php_oci_do_connect oci8-connect-return
   24 phpoci22116           oci8.so             php_oci_do_connect_ex oci8-connect-type
   25 phpoci22116           oci8.so          php_oci_connection_close oci8-connection-close
   26 phpoci22116           oci8.so                     php_oci_error oci8-error
   27 phpoci22116           oci8.so         php_oci_statement_execute oci8-execute-mode
   28 phpoci22116           oci8.so              php_oci_create_spool oci8-sesspool-create
   29 phpoci22116           oci8.so            php_oci_create_session oci8-sesspool-stats
   30 phpoci22116           oci8.so            php_oci_create_session oci8-sesspool-type
   31 phpoci22116           oci8.so          php_oci_statement_create oci8-sqltext
</pre></div>
    </div>

   </div>
  </p>

   <p class="para">
    Les valeurs de la colonne &quot;Provider&quot; affichent <code class="literal">phpoci</code>
    suivi de l&#039;identifiant du processus actuellement exécuté par PHP.
   </p>

   <p class="para">
    La colonne &quot;Function&quot; affiche les noms des fonctions C interne à PHP
    où chaque fournisseur est situé.
   </p>

   <p class="para">
    Si un processus PHP n&#039;est pas en cours d&#039;exécution, alors aucune
    découverte PHP ne sera affichée.
   </p>
 </div>

 <div class="section">
  <h2 class="title">Exemple de DTrace avec PHP OCI8</h2>
  <p class="para">
   Cet exemple montre les bases du langue de script DTrace D.
   <div class="example" id="example-2360">
    <p><strong>Exemple #1 <var class="filename">user_oci8_probes.d</var> pour suivre toutes les découvertes statiques 
     au niveau utilisation PHP OCI8 avec DTrace</strong></p>
    <div class="example-contents">
<div class="cdata"><pre>
#!/usr/sbin/dtrace -Zs

#pragma D option quiet

php*:::oci8-connect-entry
{
    printf(&quot;%lld: PHP connect-entry\n&quot;, walltimestamp);
    printf(&quot;  credentials=\&quot;%s@%s\&quot;\n&quot;, arg0 ? copyinstr(arg0) : &quot;&quot;, arg1 ? copyinstr(arg1) : &quot;&quot;);
    printf(&quot;  charset=\&quot;%s\&quot;\n&quot;, arg2 ? copyinstr(arg2) : &quot;&quot;);
    printf(&quot;  session_mode=%ld\n&quot;, (long)arg3);
    printf(&quot;  persistent=%d\n&quot;, (int)arg4);
    printf(&quot;  exclusive=%d\n&quot;, (int)arg5);
}

php*:::oci8-connect-return
{
    printf(&quot;%lld: PHP oci8-connect-return\n&quot;, walltimestamp);
    printf(&quot;  connection=0x%p\n&quot;, (void *)arg0);
}

php*:::oci8-connection-close
{
    printf(&quot;%lld: PHP oci8-connect-close\n&quot;, walltimestamp);
    printf(&quot;  connection=0x%p\n&quot;, (void *)arg0);
}

php*:::oci8-error
{
    printf(&quot;%lld: PHP oci8-error\n&quot;, walltimestamp);
    printf(&quot;  status=%d\n&quot;, (int)arg0);
    printf(&quot;  errcode=%ld\n&quot;, (long)arg1);
}

php*:::oci8-check-connection
{
    printf(&quot;%lld: PHP oci8-check-connection\n&quot;, walltimestamp);
    printf(&quot;  connection=0x%p\n&quot;, (void *)arg0);
    printf(&quot;  client_id=\&quot;%s\&quot;\n&quot;, arg1 ? copyinstr(arg1) : &quot;&quot;);
    printf(&quot;  is_open=%d\n&quot;, arg2);
    printf(&quot;  errcode=%ld\n&quot;, (long)arg3);
    printf(&quot;  server_status=%lu\n&quot;, (unsigned long)arg4);
}

php*:::oci8-sqltext
{
    printf(&quot;%lld: PHP oci8-sqltext\n&quot;, walltimestamp);
    printf(&quot;  connection=0x%p\n&quot;, (void *)arg0);
    printf(&quot;  client_id=\&quot;%s\&quot;\n&quot;, arg1 ? copyinstr(arg1) : &quot;&quot;);
    printf(&quot;  statement=0x%p\n&quot;, (void *)arg2);
    printf(&quot;  sql=\&quot;%s\&quot;\n&quot;, arg3 ? copyinstr(arg3) : &quot;&quot;);
}

php*:::oci8-execute-mode
{
    printf(&quot;%lld: PHP oci8-execute-mode\n&quot;, walltimestamp);
    printf(&quot;  connection=0x%p\n&quot;, (void *)arg0);
    printf(&quot;  client_id=\&quot;%s\&quot;\n&quot;, arg1 ? copyinstr(arg1) : &quot;&quot;);
    printf(&quot;  statement=0x%p\n&quot;, (void *)arg2);
    printf(&quot;  mode=0x%x\n&quot;, arg3);
}
</pre></div>
    </div>

   </div>
  </p>

  <p class="para">
   Ce script utilise l&#039;option <code class="literal">-Z</code> de <var class="filename">dtrace</var>,
   lui permettant d&#039;être exécutée lorsqu&#039;il n&#039;y a aucun processus
   PHP en cours d&#039;exécution. Si cette option est omis, le script
   va vouloir se terminer immédiatement lorsqu&#039;aucun exécutable PHP
   n&#039;est en cours de fonctionnement.
  </p>

  <p class="para">
   Sur les machines avec plusieurs CPU, l&#039;ordre des découvertes semble
   ne pas être séquentiel. Ceci dépend du CPU qui exécute les découvertes,
   et le nombre de threads qui migrent des CPUs. L&#039;affichage des
   timestamps des découvertes peut aider à éviter toute confusion.
  </p>

  <p class="para">
   Le script suit tous les points de découvertes statiques niveau utilisateur
   PHP OCI8 pendant la durée de l&#039;exécution du script PHP. Exécution du script D :
   <div class="informalexample">
    <div class="example-contents">
<div class="cdata"><pre>
# ./user_oci8_probes.d
</pre></div>
    </div>

   </div>
  </p>

  <p class="para">
   Exécutez un script PHP ou une application. Le script de surveillance D
   affiche chaque argument de découvertes lancé. Par exemple, un simple
   script PHP qui requête une table va produire les traces suivantes :
   <div class="informalexample">
    <div class="example-contents">
<div class="cdata"><pre>
1381794982092854582: PHP connect-entry
  credentials=&quot;hr@localhost/pdborcl&quot;
  charset=&quot;&quot;
  session_mode=0
  persistent=0
  exclusive=0
1381794982183158766: PHP oci8-connect-return
  connection=0x7f4a7907bfb8
1381794982183594576: PHP oci8-sqltext
  connection=0x7f4a7907bfb8
  client_id=&quot;Chris&quot;
  statement=0x7f4a7907c2a0
  sql=&quot;select * from employees&quot;
1381794982183783706: PHP oci8-execute-mode
  connection=0x7f4a7907bfb8
  client_id=&quot;Chris&quot;
  statement=0x7f4a7907c2a0
  mode=0x20
1381794982444344390: PHP oci8-connect-close
  connection=0x7f4a7907bfb8
</pre></div>
    </div>

   </div>
  </p>
  
  <p class="para">
   Lorsque la surveillance se termine, le script D peut s&#039;arrêter avec la
   combinaison <code class="literal">^C</code>.
  </p>

 </div>

 <div class="section">
 <h2 class="title">Voir aussi</h2>
 <ul class="simplelist">
  <li class="member"><a href="features.dtrace.html" class="link">Le suivi dynamique DTrace</a></li>
 </ul>
</div>

</div>
</div></div></body></html>