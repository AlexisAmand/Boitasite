<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>D&eacute;finition du TTL</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-qc.quickstart.caching.html">« Mise en cache des requ&ecirc;tes</a></li>
      <li style="float: right;"><a href="mysqlnd-qc.pattern-based-caching.html">Mise en cache bas&eacute;e sur un masque »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-qc.quickstart.html">D&eacute;marrage rapide et quelques exemples</a></li>
    <li>D&eacute;finition du TTL</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-qc.per-query-ttl" class="section">
  <h2 class="title">Définition du TTL</h2>
  <p class="para">
   La stratégie d&#039;invalidation par défaut du plugin d&#039;une requête du cache est
   Time to Live (<code class="literal">TTL</code>). Le gestionnaire de stockage interne
   utilisera le <code class="literal">TTL</code> par défaut, défini par la valeur de
   la directive de configuration
   <code class="literal"><a href="mysqlnd-qc.configuration.html" class="link">mysqlnd_qc.ttl</a></code>
   à moins qu&#039;une chaîne de requête ne contienne une astuce pour configurer
   un <code class="literal">TTL</code> différent. Le <code class="literal">TTL</code> est spécifié
   en seconde. Par défaut, une entrée du cache expire après
   <code class="literal">30</code> secondes.
  </p>
  <p class="para">
   L&#039;exemple définit <code class="literal">mysqlnd_qc.ttl=3</code> pour mettre en cache les requêtes
   pour 3 secondes par défaut. Chaque seconde, il met à jour un enregistrement
   d&#039;une table de la base de données pour enregistrer l&#039;heure courant et exécute
   une requête de type <code class="literal">SELECT</code> pour récupérer l&#039;enregistrement
   depuis la base de données. La requête <code class="literal">SELECT</code> est mise en cache pour
   3 secondes, car elle est préfixée d&#039;une astuce SQL activant la mise en cache.
   La sortie vérifie que les résultats de la requête sont prises depuis le cache
   pour la durée de ces 3 secondes avant d&#039;être mis à jour.
  </p>
  <p class="para">
   <div class="example" id="example-2266">
    <p><strong>Exemple #1 Définir un TTL avec l&#039;option de configuration ini
     <code class="literal">mysqlnd_qc.ttl</code></strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_qc.enable_qc=1
mysqlnd_qc.ttl=3</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Connexion,&nbsp;création&nbsp;et&nbsp;peuplement&nbsp;de&nbsp;la&nbsp;table&nbsp;test&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"host"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"schema"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"port"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"socket"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;test(id&nbsp;VARCHAR(255))"</span><span style="color: #007700">);<br /><br />for&nbsp;(</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">7</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i</span><span style="color: #007700">++)&nbsp;{<br /><br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Mise&nbsp;à&nbsp;jour&nbsp;de&nbsp;la&nbsp;ligne&nbsp;de&nbsp;la&nbsp;base&nbsp;de&nbsp;données&nbsp;&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE&nbsp;FROM&nbsp;test"</span><span style="color: #007700">)&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(NOW())"</span><span style="color: #007700">))<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;sûr,&nbsp;un&nbsp;vrai&nbsp;script&nbsp;devrait&nbsp;avoir&nbsp;un&nbsp;gestionnaire&nbsp;d'erreurs&nbsp;meileur&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">));<br /><br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Sélection&nbsp;de&nbsp;la&nbsp;dernière&nbsp;ligne&nbsp;mais&nbsp;met&nbsp;en&nbsp;cache&nbsp;les&nbsp;résultats&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$query&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/*"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">MYSQLND_QC_ENABLE_SWITCH&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"*/"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$query&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #DD0000">"SELECT&nbsp;id&nbsp;AS&nbsp;_time&nbsp;FROM&nbsp;test"</span><span style="color: #007700">;<br />&nbsp;&nbsp;if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">))&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!(</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">()))<br />&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Heure&nbsp;:&nbsp;%s&nbsp;-&nbsp;Heure&nbsp;de&nbsp;la&nbsp;ligne&nbsp;dans&nbsp;la&nbsp;base&nbsp;de&nbsp;données&nbsp;:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">"H:i:s"</span><span style="color: #007700">),&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_time'</span><span style="color: #007700">]);<br /><br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Pause&nbsp;d'une&nbsp;seconde&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>Les exemples ci-dessus vont afficher :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Heure : 14:55:59 - Heure de la ligne dans la base de données : 2012-01-11 14:55:59
Heure : 14:56:00 - Heure de la ligne dans la base de données : 2012-01-11 14:55:59
Heure : 14:56:01 - Heure de la ligne dans la base de données : 2012-01-11 14:55:59
Heure : 14:56:02 - Heure de la ligne dans la base de données : 2012-01-11 14:56:02
Heure : 14:56:03 - Heure de la ligne dans la base de données : 2012-01-11 14:56:02
Heure : 14:56:04 - Heure de la ligne dans la base de données : 2012-01-11 14:56:02
Heure : 14:56:05 - Heure de la ligne dans la base de données : 2012-01-11 14:56:05
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Comme vous pouvez le voir dans cet exemple, n&#039;importe quelle entrée du cache
   basée sur un <code class="literal">TTL</code> peut servir des données non mises à jour.
   Les entrées du cache ne sont pas automatiquement invalidées si les données
   ont été modifiées. Les applications utilisant la stratégie <code class="literal">TTL</code>
   par défaut d&#039;invalidation doivent être capables de fonctionner correctement
   avec des données non mises à jour.
  </p>
  <p class="para">
   Un gestionnaire de stockage défini par l&#039;utilisateur peut implémenter n&#039;importe
   quelle stratégie d&#039;invalidation pour permettre de s&#039;affranchir de cette limitation.
  </p>
  <p class="para">
   Le <code class="literal">TTL</code> par défaut peut être écrasé en utilisant l&#039;astuce SQL
   <code class="literal">/*qc_tt=seconds*/</code>. L&#039;astuce SQL doit apparaître immédiatement
   après l&#039;astuce SQL qui active la mise en cache. Il est recommandé d&#039;utiliser la constante
   PHP <code class="literal"><a href="mysqlnd-qc.constants.html" class="link">MYSQLND_QC_TTL_SWITCH</a></code>
   au lieu d&#039;utiliser la valeur litérale.
  </p>
  <p class="para">
   <div class="example" id="example-2267">
    <p><strong>Exemple #2 Définir un TTL avec des astuces SQL</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$start&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">microtime</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion,&nbsp;création&nbsp;et&nbsp;peuplement&nbsp;de&nbsp;la&nbsp;table&nbsp;test&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"host"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"schema"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"port"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"socket"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT)"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1),&nbsp;(2)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"TTL&nbsp;par&nbsp;défaut&nbsp;\t:&nbsp;%d&nbsp;seconds\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">ini_get</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_qc.ttl"</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Sera&nbsp;mise&nbsp;en&nbsp;cache&nbsp;pendant&nbsp;2&nbsp;secondes&nbsp;*/<br /></span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"/*%s*//*%s%d*/SELECT&nbsp;id&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;1"</span><span style="color: #007700">,<br />&nbsp;</span><span style="color: #0000BB">MYSQLND_QC_ENABLE_SWITCH</span><span style="color: #007700">,<br />&nbsp;</span><span style="color: #0000BB">MYSQLND_QC_TTL_SWITCH</span><span style="color: #007700">,<br />&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DELETE&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Récupération&nbsp;depuis&nbsp;le&nbsp;cache&nbsp;-&nbsp;aucune&nbsp;invalidation&nbsp;automatique&nbsp;et&nbsp;donc,&nbsp;toujours&nbsp;valide&nbsp;!&nbsp;*/<br /></span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Non&nbsp;présente&nbsp;en&nbsp;cache&nbsp;-&nbsp;l'entrée&nbsp;du&nbsp;cache&nbsp;a&nbsp;expiré&nbsp;*/<br /></span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">free</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Temps&nbsp;d'exécution&nbsp;du&nbsp;script\t:&nbsp;%d&nbsp;seconds\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">microtime</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">)&nbsp;-&nbsp;</span><span style="color: #0000BB">$start</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>Les exemples ci-dessus vont afficher :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
TTL par défaut     : 30 seconds
array(1) {
  [&quot;id&quot;]=&gt;
  string(1) &quot;1&quot;
}
array(1) {
  [&quot;id&quot;]=&gt;
  string(1) &quot;1&quot;
}
NULL
Temps d&#039;exécution du script  : 3 seconds
</pre></div>
    </div>
    
   </div>
  </p>
 </div></div></div></body></html>