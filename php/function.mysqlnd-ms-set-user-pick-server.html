<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>D&eacute;finit une fonction de rappel utilisateur pour la s&eacute;paration lecture/&eacute;criture</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mysqlnd-ms-set-qos.html">« mysqlnd_ms_set_qos</a></li>
      <li style="float: right;"><a href="function.mysqlnd-ms-xa-begin.html">mysqlnd_ms_xa_begin »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mysqlnd-ms.html">Fonctions Mysqlnd_ms</a></li>
    <li>D&eacute;finit une fonction de rappel utilisateur pour la s&eacute;paration lecture/&eacute;criture</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mysqlnd-ms-set-user-pick-server" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqlnd_ms_set_user_pick_server</h1>
  <p class="verinfo">(PECL mysqlnd_ms &lt; 1.1.0)</p><p class="refpurpose"><span class="refname">mysqlnd_ms_set_user_pick_server</span> &mdash; <span class="dc-title">Définit une fonction de rappel utilisateur pour la séparation lecture/écriture</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.mysqlnd-ms-set-user-pick-server-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   
   <span class="methodname"><strong>mysqlnd_ms_set_user_pick_server</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$function</code></span>
   ) : <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   Définit une fonction de rappel utilisateur pour la séparation lecture/écriture.
   Le plugin appellera cette fonction uniquement si <code class="literal">pick[]=user</code>
   est la règle par défaut pour la sélection de serveur dans la section révélante
   du fichier de configuration du plugins.
  </p>
  <p class="para">
   Le mécanisme interne de décision sur la séparation lecture/écriture du
   plugin peut être écrasé de 2 façons. La plus simple est d&#039;ajouter en début
   de requête SQL l&#039;astuce <strong><code>MYSQLND_MS_MASTER_SWITCH</code></strong>,
   <strong><code>MYSQLND_MS_SLAVE_SWITCH</code></strong> ou
   <strong><code>MYSQLND_MS_LAST_USED_SWITCH</code></strong>. L&#039;utilisation d&#039;astuces SQL
   permet de contrôler, par exemple, si la requête doit être envoyée au serveur
   MySQL maître de réplication ou à un des serveurs esclaves. Avec l&#039;aide des astuces
   SQL, il n&#039;est pas possible de sélectionner un serveur esclave particulier
   pour l&#039;exécution de la requête.
  </p>
  <p class="para">
   Le contrôle total sur la sélection de serveur peut être atteint en utilisant
   une fonction de rappel. Son utilisation est recommandée par les utilisateurs
   expérimentés uniquement par le fait que la fonction de rappel couvre tous les
   cas pouvant être gérés par le plugin.
  </p>
  <p class="para">
   Le plugin invoquera la fonction de rappel pour sélectionner un serveur depuis
   la liste des serveurs maîtres et esclaves configurés. La fonction de rappel
   inspecte la requête à exécuter, et sélectionne un serveur utilisé pour l&#039;exécution
   de la requête en retournant l&#039;URI de l&#039;hôte, tel que trouvé dans la liste
   des serveurs maîtres et esclaves.
  </p>
  <p class="para">
   Si les connexions paresseuses sont activées, si la fonction de rappel choisit
   un serveur esclave pour lequel aucune connexion n&#039;a été établie, et que la connexion
   échoue, le plugin retournera une erreur lors de la prochaine action sur la
   connexion ayant échouée, par exemple, lors de l&#039;exécution d&#039;une requête..
   Il en est de la responsabilité de l&#039;application de gérer cette erreur.
   Par exemple, l&#039;application peut ré-exécuter la requête pour forcer la
   sélection d&#039;un nouveau serveur et ainsi provoquer l&#039;invocation de la fonction
   de rappel. Si c&#039;est le cas, la fonction de rappel doit s&#039;assurer de
   sélectionner un esclave différent, ou vérifier la disponibilité de
   l&#039;esclave choisi, avant de retourner le résultat au plugin, et ce, afin
   d&#039;éviter une boucle infinie.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.mysqlnd-ms-set-user-pick-server-parameters">
  <h3 class="title">Liste de paramètres</h3>
  <dl>

   
    <dt>
<code class="parameter">function</code></dt>

    <dd>

     <p class="para">
      La fonction à appeler. Les méthodes de la classe peuvent aussi
      être invoquées statiquement en utilisant cette fonction en
      passant <code class="literal">array($classname, $methodname)</code> dans ce
      paramètre. De plus, les méthodes de la classe d&#039;une instance d&#039;objet
      peuvent être appelées en passant
      <code class="literal">array($objectinstance, $methodname)</code> dans ce paramètre.
     </p>
    </dd>

   
  </dl>

 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.mysqlnd-ms-set-user-pick-server-returnvalues">
  <h3 class="title">Valeurs de retour</h3>
  <p class="para">
   Hôte sur lequel la requête sera exécutée. L&#039;URI de l&#039;hôte sera issue
   de la liste des connexions maîtres et esclaves passée à la fonction
   de rappel. Si la fonction de rappel retourne une valeur ni trouvée dans
   le maître, ni dans les esclaves de la liste, le plugin se retournera
   sur la seconde méthode de sélection configurée via la configuration
   <code class="literal">pick[]</code> du fichier de configuration du plugin.
   Si aucune seconde méthode de sélection n&#039;est fournie, le plugin se
   retournera alors vers la méthode de sélection interne.
  </p>
 </div>


 <div class="refsect1 unknown-returnvaluet" id="refsect1-function.mysqlnd-ms-set-user-pick-server-unknown-returnvaluet">
  <h3 class="title">Notes</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    <span class="function"><strong>mysqlnd_ms_set_user_pick_server()</strong></span> est disponible
    avec PECL mysqlnd_ms &lt; 1.1.0. La fonction a été remplacée par 
    un filtre utilisateur. Reportez-vous aux
    <a href="mysqlnd-ms.changes-one-one.html" class="link">modifications de versions</a>.
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 examples" id="refsect1-function.mysqlnd-ms-set-user-pick-server-examples">
  <h3 class="title">Exemples</h3>
  <p class="para">
   <div class="example" id="example-2260">
    <p><strong>Exemple #1 Exemple avec <span class="function"><strong>mysqlnd_ms_set_user_pick_server()</strong></span></strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">[myapp]
master[] = localhost
slave[] = 192.168.2.27:3306
slave[] = 192.168.78.136:3306
pick[] = user</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$master</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used</span><span style="color: #007700">)<br />{<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$slave_idx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br />&nbsp;if&nbsp;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">))<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;défaut&nbsp;:&nbsp;retour&nbsp;à&nbsp;la&nbsp;logique&nbsp;interne&nbsp;du&nbsp;plugin&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"L'utilisateur&nbsp;est&nbsp;connecté&nbsp;sur&nbsp;'%s'...\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$connected</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;décision&nbsp;du&nbsp;serveur&nbsp;pour&nbsp;l'exécution&nbsp;de&nbsp;la&nbsp;requête&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #0000BB">$where&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_query_is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;switch&nbsp;(</span><span style="color: #0000BB">$where</span><span style="color: #007700">)<br />&nbsp;{<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_MASTER</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;utilisation&nbsp;du&nbsp;maître\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$master</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_SLAVE</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;SELECT&nbsp;ou&nbsp;astuce&nbsp;SQL&nbsp;pour&nbsp;l'utilisation&nbsp;d'un&nbsp;esclave&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">stristr</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">))<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;une&nbsp;table&nbsp;qui&nbsp;n'est&nbsp;configuré&nbsp;que&nbsp;sur&nbsp;le&nbsp;premier&nbsp;esclave&nbsp;configuré&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;accès&nbsp;à&nbsp;une&nbsp;table&nbsp;disponible&nbsp;que&nbsp;sur&nbsp;l'esclave&nbsp;A&nbsp;détecté\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;tentative&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;quelques&nbsp;requêtes&nbsp;en&nbsp;lectures&nbsp;seules&nbsp;pour&nbsp;un&nbsp;esclave\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">$slave_idx</span><span style="color: #007700">++&nbsp;%&nbsp;</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_LAST_USED</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;utilisation&nbsp;du&nbsp;dernier&nbsp;serveur&nbsp;utilisé\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$last_used</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;}<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;ret&nbsp;=&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">);<br />&nbsp;return&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">mysqlnd_ms_set_user_pick_server</span><span style="color: #007700">(</span><span style="color: #DD0000">"pick_server"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;2&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
L&#039;utilisateur est connecté sur &#039;myapp&#039;...
... décision du serveur pour l&#039;exécution de la requête &#039;SELECT 1 FROM DUAL&#039;
... quelques requêtes en lectures seules pour un esclave
... ret = &#039;tcp://192.168.2.27:3306&#039;
L&#039;utilisateur est connecté sur &#039;myapp&#039;...
... décision du serveur pour l&#039;exécution de la requête &#039;SELECT 2 FROM DUAL&#039;
... quelques requêtes en lectures seules pour un esclave
... ret = &#039;tcp://192.168.78.136:3306&#039;
L&#039;utilisateur est connecté sur &#039;myapp&#039;...
... décision du serveur pour l&#039;exécution de la requête &#039;SELECT * FROM table_on_slave_a_only&#039;
... accès à une table disponible que sur l&#039;esclave A détecté
... ret = &#039;tcp://192.168.2.27:3306&#039;
</pre></div>
    </div>
   </div>
  </p>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.mysqlnd-ms-set-user-pick-server-seealso">
  <h3 class="title">Voir aussi</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member">
     <span class="function"><a href="function.mysqlnd-ms-query-is-select.html" class="function" rel="rdfs-seeAlso">mysqlnd_ms_query_is_select()</a> - V&eacute;rifie quel serveur est s&eacute;lectionn&eacute; pour l'envoi de la requ&ecirc;te</span>
    </li>
    <li class="member">
     <a href="mysqlnd-ms.filter.html" class="link">Notion sur les filtres</a>
    </li>
    <li class="member">
     <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.filter-user" class="link">Les filtres utilisateurs</a>
    </li>  
   </ul>
  </p>
 </div>

 
</div></div></div></body></html>