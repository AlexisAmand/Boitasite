<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Securit&eacute;</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mongo.updates.html">« Mises &agrave; jour</a></li>
      <li style="float: right;"><a href="mongo.trouble.html">D&eacute;pannage »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mongo.manual.html">Manuel</a></li>
    <li>Securit&eacute;</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mongo.security" class="chapter">
 <h1>Securité</h1>


 <div class="section">
  <h2 class="title">Attaque par injection dans la requête</h2>
  <p class="para">
   Si vous passez des paramètres <code class="literal">$_GET</code> (ou <code class="literal">$_POST</code>)
   dans vos requêtes, assurez-vous de les transtyper en chaînes de caractères avant.
   Les utilisateurs peuvent insérer des tableaux associatifs dans leurs requêtes GET
   et POST, qui deviendront des requêtes non désirées.
  </p>

  <p class="para">
   Voici un exemple relativement inoffensif : supposez que vous récupérez
   les informations d&#039;un utilisateur avec la requête
   <em class="emphasis">http://www.example.com?username=bob</em>. Votre application
   exécute la requête suivante :
   <code class="literal">$collection-&gt;find(array(&quot;username&quot; =&gt; $_GET[&#039;username&#039;]))</code>. 
  </p>

  <p class="para">
   Quelqu&#039;un peut détourner ce comportement en appelant l&#039;URL suivante :
   <em class="emphasis">http://www.example.com?username[$ne]=foo</em>, que PHP transformera
   automatiquement en un tableau associatif, exécutant ainsi la requête suivante :
   <code class="literal">$collection-&gt;find(array(&quot;username&quot; =&gt; array(&#039;$ne&#039; =&gt; &quot;foo&quot;)))</code>,
   qui retournera tous les utilisateurs qui ne se nomment pas &quot;foo&quot; (tous vos utilisateurs, probablement).
  </p>

  <p class="para">
   Ceci est une attaque simple qui se contre tout aussi facilement : assurez-vous
   que les paramètres $_GET et $_POST sont du type que vous attendez avant de les
   envoyer à la base de données (transtypez les en chaînes de caractères, dans ce cas).
  </p>

  <p class="para">
   Notez que ce type d&#039;attaque peut être utilisée avec chaque itération de bases de
   données qui tente de localiser un document, y compris les mises à jour, les
   recherches/remplacements, et les effacement.
  </p>

  <p class="para">
   Merci à <a href="https://www.idontplaydarts.com/2010/07/mongodb-is-vulnerable-to-sql-injection-in-php-at-least/" class="link external">&raquo;&nbsp;Phil</a> d&#039;avoir mis le doigt sur ces possibilités.
  </p>

  <p class="para">
   Reportez-vous à <a href="https://docs.mongodb.com/manual/security/" class="link external">&raquo;&nbsp;la documentation
   principale</a> pour plus d&#039;informations sur les injections SQL avec MongoDB.
  </p>
 </div>

 <div class="section">
  <h2 class="title">Attaques par injection</h2>
  <p class="para">
   Si vous utilisez Javascript, assurez-vous que toutes les variables qui
   passent par le lien PHP-vers-Javascript sont passées dans le champ
   <code class="literal">scope</code> de la classe <a href="class.mongocode.html" class="classname">MongoCode</a>
   sans être interpolées dans la chaîne Javascript. Ceci peut survenir lors
   de l&#039;utilisation de la méthode <span class="function"><a href="mongodb.execute.html" class="function">MongoDB::execute()</a></span>,
   des clauses <code class="literal">$where</code>, MapReduces, group-bys, et à chaque
   fois que vous pouvez passer du Javascript dans la base de données.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    MapReduce ignore le champ <code class="literal">scope</code> de la méthode
    <a href="class.mongocode.html" class="classname">MongoCode</a>, mais il y a une option <code class="literal">scope</code>
    sur la commande qui peut être utilisée à la place.
   </p>
  </p></blockquote>
  <p class="para">
   Par exemple, supposons que nous avons du Javascript qui salut un
   utilisateur dans la base de données. Nous pouvons faire :
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;Ne&nbsp;faîtes&nbsp;pas&nbsp;ceci&nbsp;!<br /><br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'username'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Cependant, que se passe-t-il si un utilisateur passe le Javascript suivant ?
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;Ne&nbsp;faîtes&nbsp;pas&nbsp;ceci&nbsp;!<br /><br />//&nbsp;$username&nbsp;vaut&nbsp;:&nbsp;"');&nbsp;db.users.drop();&nbsp;print('"<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">!');"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Maintenant, MongoDB exécute le chaîne Javascript
   <code class="literal">&quot;print(&#039;Hello, &#039;); db.users.drop(); print(&#039;!&#039;);&quot;</code>.
   Ce type d&#039;attaque est facile à contrer : utilisez
   <code class="literal">scope</code> pour passe les variables de PHP à Javascript :
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$scope&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"user"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$username</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">MongoCode</span><span style="color: #007700">(</span><span style="color: #DD0000">"print('Hello,&nbsp;'+user+'!');"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$scope</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Ceci permet d&#039;ajout une variable <code class="literal">user</code> au scope JavaScript.
   Maintenant, si quelqu&#039;un tente d&#039;envoyer du code malicieux, MongoDB
   affichera <code class="literal">Hello, &#039;); db.dropDatabase(); print(&#039;!</code>.
  </p>

  <p class="para">
   L&#039;utilisation de <code class="literal">scope</code> permet de prévenir d&#039;exécution de
   code malicieux dans la base de données. Cependant, vous devez vous assurer
   que votre code ne tourne pas en rond et finisse par, au final, exécuter l&#039;entrée
   utilisateur ! Par exemple, n&#039;utilisez jamais la fonction Javascript
   <code class="literal">eval</code> sur des entrées utilisateurs :
  </p>
  <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;Ne&nbsp;faîtes&nbsp;pas&nbsp;ceci&nbsp;!<br /><br />//&nbsp;$jsShellInput&nbsp;vaut&nbsp;:&nbsp;"db.users.drop();"<br /></span><span style="color: #0000BB">$scope&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"input"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$jsShellInput</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(new&nbsp;</span><span style="color: #0000BB">MongoCode</span><span style="color: #007700">(</span><span style="color: #DD0000">"eval(input);"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$scope</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
  </div>

  <p class="para">
   Utilisez toujours <code class="literal">scope</code> et n&#039;autorisez jamais
   la base de données à exécuter des entrées utilisateurs sous forme de
   code.
  </p>
 </div>
</div>
</div></div></body></html>