<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>D&eacute;finit la qualit&eacute; de service d&eacute;sir&eacute;e pour le cluster</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mysqlnd-ms-query-is-select.html">« mysqlnd_ms_query_is_select</a></li>
      <li style="float: right;"><a href="function.mysqlnd-ms-set-user-pick-server.html">mysqlnd_ms_set_user_pick_server »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.mysqlnd-ms.html">Fonctions Mysqlnd_ms</a></li>
    <li>D&eacute;finit la qualit&eacute; de service d&eacute;sir&eacute;e pour le cluster</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.mysqlnd-ms-set-qos" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqlnd_ms_set_qos</h1>
  <p class="verinfo">(PECL mysqlnd_ms &lt; 1.2.0)</p><p class="refpurpose"><span class="refname">mysqlnd_ms_set_qos</span> &mdash; <span class="dc-title">Définit la qualité de service désirée pour le cluster</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.mysqlnd-ms-set-qos-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   
   <span class="methodname"><strong>mysqlnd_ms_set_qos</strong></span>
    ( <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$connection</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$service_level</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$service_level_option</code></span>
   [, <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$option_value</code></span>
  ]] ) : <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   Définit la qualité de service désirée pour le cluster. Un cluster de base
   de données délivre une certaine qualité de service à l&#039;utilisateur suivant
   son architecture. Un aspect majeur de la qualité de service est le niveau
   de consistence pouvant être offert par le cluster. Un cluster de réplication
   MySQL asynchrone a, par défaut, une consistence éventuelle pour les esclaves
   en lecture : un esclave peut servir des données non-mises à jour, des données
   courantes, ou il peut ne pas avoir du tout les données, car il n&#039;est pas
   synchrone avec le maître. Dans un cluster de réplication MySQL, seul le maître
   peut fournir une consistence forte, garantissant à tous les clients de voir les
   modifications.
  </p>
  <p class="para">
   PECL/mysqlnd_ms cache le choix des noeuds appropriés pour arriver à un
   certain niveau de service depuis le cluster. Le filtre
   &quot;Quality of Service&quot; implémente la logique nécessaire. Ce filtre peut
   être soit configuré dans le fichier de configuration du plugin, soit
   au moment de l&#039;exécution en utilisant la fonction
   <span class="function"><strong>mysqlnd_ms_set_qos()</strong></span>.
  </p>
  <p class="para">
   Des résultats similaires peuvent être obtenus avec PECL mysqlnd_ms &lt; 1.2.0,
   en utilisant des astuces SQL pour forcer l&#039;utilisation d&#039;un certain noeud,
   ou en utilisant l&#039;option de configuration <code class="literal">master_on_write</code>
   du plugin. La première nécessite plus de code et plus de travaux côté
   applicatif. La dernière est moins raffinée que d&#039;utiliser le filtre de qualité
   de service. La configuration via l&#039;appel à la fonction peut être réservée,
   comme dans l&#039;exemple ci-dessous. L&#039;exemple switche temporairement vers
   un niveau de service supérieur (consistence de session, lecture de vos écritures)
   et retourne vers le cluster par défaut après avoir effectué toutes les
   opérations nécessitant un service meilleur. De cette façon, la charge en lecture
   sur le maître peut être optimisée par rapport à l&#039;utilisation de
   <code class="literal">master_on_write</code>, qui fait que le maître continue d&#039;être utilisé
   après la première écriture.
  </p>
  <p class="para">
   Depuis 1.5.0, les appels échoueront lorsqu&#039;éffectués au milieu d&#039;une
   transaction si la direction de configuration sur la
   <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.trx-stickiness" class="link">rigidité des transactions</a>
   est activée et que les limites de la transaction ont été détectées.
   properly.
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.mysqlnd-ms-set-qos-parameters">
  <h3 class="title">Liste de paramètres</h3>
  <dl>

   
    <dt>
<code class="parameter">connection</code></dt>

    <dd>

     <p class="para">
      Un gestionnaire de connexion PECL/mysqlnd_ms vers un serveur MySQL de type
      <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a>,
      <a href="book.mysqli.html" class="link">mysqli</a> ou
      <a href="book.mysql.html" class="link">ext/mysql</a> pour lequel un niveau de service
      doit être défini. Le gestionnaire de connexion est obtenu lors de l&#039;ouverture
      d&#039;une connexion avec un nom d&#039;hôte qui correspond à l&#039;entrée du fichier
      de configuration mysqlnd_ms, en utilisant n&#039;importe laquelle des extensions
      MySQL ci-dessus.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">service_level</code></dt>

    <dd>

     <p class="para">
      Le niveau de service demandé : <strong><code>MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code></strong>,
      <strong><code>MYSQLND_MS_QOS_CONSISTENCY_SESSION</code></strong> ou
      <strong><code>MYSQLND_MS_QOS_CONSISTENCY_STRONG</code></strong>.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">service_level_option</code></dt>

    <dd>

     <p class="para">
      Une option pour paramétrer le niveau de service demdandé.
      Cette option peut être <strong><code>MYSQLND_MS_QOS_OPTION_GTID</code></strong>
      ou <strong><code>MYSQLND_MS_QOS_OPTION_AGE</code></strong>.
     </p>
     <p class="para">
      L&#039;option <strong><code>MYSQLND_MS_QOS_OPTION_GTID</code></strong> peut être utilisé pour
      définir le niveau de service <strong><code>MYSQLND_MS_QOS_CONSISTENCY_SESSION</code></strong>.
      Il doit être combiné avec un 4ème paramètre, <code class="parameter">option_value</code>.
      Le paramètre <code class="parameter">option_value</code> doit être un identifiant de
      transaction globale obtenu depuis la fonction <span class="function"><a href="function.mysqlnd-ms-get-last-gtid.html" class="function">mysqlnd_ms_get_last_gtid()</a></span>.
      Si défini, le plugin considère qu&#039;à la fois les serveurs maîtres et les
      esclaves asynchrones utiliseront une consistence de session (lecture de
      vos écritures). Sinon, seuls les maîtres seront utilisés pour la consistence
      de session. Un esclave est considéré à jour et il sera vérifié si il a déjà
      répliqué l&#039;identifiant de transaction globale issu du paramètre
      <code class="parameter">option_value</code>. Veuillez noter que la recherche d&#039;esclaves
      appropriés est une opération couteuse et lente. Elle est donc à utiliser avec
      précaution, surtout si le maître ne peut pas gérer seul la charge des lectures.
     </p>
     <p class="para">
      L&#039;option <strong><code>MYSQLND_MS_QOS_OPTION_AGE</code></strong> peut être combinée avec
      le niveau de service <strong><code>MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</code></strong>
      pour filtrer les esclaves asynchrones qui lag pendant plus de
      <code class="parameter">option_value</code> secondes derrières le maître. Si défini,
      le plugin ne considèrera que les esclaves pour les lectures si
      <code class="literal">SHOW SLAVE STATUS</code> rapporte
      <code class="literal">Slave_IO_Running=Yes</code>,
      <code class="literal">Slave_SQL_Running=Yes</code> et
      <code class="literal">Seconds_Behind_Master &lt;= option_value</code>. Veuillez noter que
      la recherche d&#039;esclaves appropriés est une opération couteuse et lente.
      Elle est donc à utiliser avec précaution en version 1.2.0. Les futures versions
      devraient améliorer l&#039;algorithme utilisé pour identifier les candidats.
      Reportez-vous au manuel de référence MySQL sur la précision, l&#039;exactitude,
      et les limitations de la commande administrative MySQL
      <code class="literal">SHOW SLAVE STATUS</code>.
     </p>
    </dd>

   
   
    <dt>
<code class="parameter">option_value</code></dt>

    <dd>

     <p class="para">
      La valeur optionnelle du niveau de service. Reportez-vous au paramètre
      <code class="parameter">service_level_option</code> pour plus de détails.
     </p>
    </dd>

   
  </dl>

 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-function.mysqlnd-ms-set-qos-returnvalues">
  <h3 class="title">Valeurs de retour</h3>
  <p class="para">
   Retourne <strong><code>TRUE</code></strong> si le niveau de service des connexions a pû
   être atteint, <strong><code>FALSE</code></strong> sinon.
  </p>
 </div>

 
 <div class="refsect1 unknown-returnvaluet" id="refsect1-function.mysqlnd-ms-set-qos-unknown-returnvaluet">
  <h3 class="title">Notes</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    <span class="function"><strong>mysqlnd_ms_set_qos()</strong></span> requière
    PHP &gt;= 5.4.0 and PECL mysqlnd_ms &gt;= 1.2.0. En interne, elle utilise
    une fonctionnalité de la bibliothèque C <code class="literal">mysqlnd</code>
    qui n&#039;est pas disponible en PHP 5.3.
   </p>
   <p class="para">
    Veuillez noter que toues les versions de production de MySQL 5.6 ne
    fournissent pas aux clients des informations suffisantes pour l&#039;utilisation
    des GTIDs permettant de renforcer la consistence des sessions.
    Dans un tel cas, le plugin choisira uniquement le maître.
   </p>
  </p></blockquote>
 </div>

 
 <div class="refsect1 examples" id="refsect1-function.mysqlnd-ms-set-qos-examples">
  <h3 class="title">Exemples</h3>
  <p class="para">
   <div class="example" id="example-2259">
    <p><strong>Exemple #1 Exemple avec <span class="function"><strong>mysqlnd_ms_set_qos()</strong></span></strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Ouvre&nbsp;une&nbsp;connexion&nbsp;mysqlnd_ms&nbsp;en&nbsp;utilisant&nbsp;l'extension&nbsp;mysqli,&nbsp;PDO_MySQL&nbsp;ou&nbsp;mysql&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">)<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;évidemment,&nbsp;votre&nbsp;gestionnaire&nbsp;d'erreur&nbsp;est&nbsp;meilleur...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Consistence&nbsp;de&nbsp;session&nbsp;:&nbsp;lecture&nbsp;de&nbsp;vos&nbsp;écritures&nbsp;*/<br /></span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_set_qos</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QOS_CONSISTENCY_SESSION</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$ret</span><span style="color: #007700">)<br />&nbsp;&nbsp;die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Va&nbsp;utiliser&nbsp;le&nbsp;maître&nbsp;et&nbsp;retourner&nbsp;des&nbsp;données&nbsp;récentes,&nbsp;le&nbsp;client&nbsp;pourra&nbsp;voir&nbsp;ces&nbsp;dernières&nbsp;écritures&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;item,&nbsp;price&nbsp;FROM&nbsp;orders&nbsp;WHERE&nbsp;order_id&nbsp;=&nbsp;1"</span><span style="color: #007700">))<br />&nbsp;&nbsp;die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Retour&nbsp;vers&nbsp;le&nbsp;comportement&nbsp;par&nbsp;défaut&nbsp;:&nbsp;utilisation&nbsp;de&nbsp;tous&nbsp;les&nbsp;esclaves&nbsp;et&nbsp;maîtres<br />autorisés,&nbsp;des&nbsp;données&nbsp;non-à-jour&nbsp;peuvent&nbsp;survenir&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">mysqlnd_ms_set_qos</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QOS_CONSISTENCY_EVENTUAL</span><span style="color: #007700">))<br />&nbsp;&nbsp;die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.mysqlnd-ms-set-qos-seealso">
  <h3 class="title">Voir aussi</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member">
     <span class="function"><a href="function.mysqlnd-ms-get-last-gtid.html" class="function" rel="rdfs-seeAlso">mysqlnd_ms_get_last_gtid()</a> - Retourne le dernier identifiant de transaction globale</span>
    </li>
    <li class="member">
     <a href="mysqlnd-ms.qos-consistency.html" class="link">Concepte sur le niveau de service et la consistence</a>
    </li>
    <li class="member">
     <a href="mysqlnd-ms.filter.html" class="link">Concepte sur les filtres</a>
    </li>
   </ul>
  </p>
 </div>

 
</div></div></div></body></html>