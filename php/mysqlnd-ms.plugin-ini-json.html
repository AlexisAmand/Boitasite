<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Fichier de configuration du plugin (&gt;=1.1.x)</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.configuration.html">« Configuration &agrave; l'ex&eacute;cution</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.constants.html">Constantes pr&eacute;-d&eacute;finies »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.setup.html">Installation/Configuration</a></li>
    <li>Fichier de configuration du plugin (&gt;=1.1.x)</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.plugin-ini-json" class="section">
  <h2 class="title">Fichier de configuration du plugin (&gt;=1.1.x)</h2>
  
  <p class="para">
   La documentation suivantes s&#039;applique à PECL/mysqlnd_ms &gt;= 1.1.0-beta.
   Elle n&#039;est pas valide pour les versions antérieures. Pour une documentation
   qui couvre les anciennes versions, raportez-vous à la documentation de la
   configuration pour <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-v1" class="link">mysqlnd_ms 1.0.x
   et antérieures</a>.
  </p>
  
  <div class="section" id="mysqlnd-ms.plugin-ini-json-introduction">
   <h2 class="title">Introduction</h2>
   
   <blockquote class="note"><p><strong class="note">Note</strong>: 
    <strong>Historique : Fonctionnalités ajoutées en PECL/mysqlnd_ms 1.1.0-beta</strong><br />
    <p class="para">
     La description ci-dessous s&#039;applique à PECL/mysqlnd_ms &gt;= 1.1.0-beta.
     Elle n&#039;est pas valide pour les versions plus anciennes.
    </p>
   </p></blockquote>
   
   <p class="para">
    Le plugin utilise un fichier de configuration propre, qui contient les informations
    sur le maitre de réplication MySQL, les escalves, la politique de bascule et la stratégie
    de failover et l&#039;utilisation de connexions paresseuses (lazy).
   </p>
   <p class="para">
    Le plugin charge son fichier de configuration au début de la requête web.
    Il est ensuite mis en cache mémoire et utilisé pour toute la durée de la
    requête web. De cette façon, il n&#039;est pas nécessaire de redémarrer PHP
    après avoir déployé le fichier de configuration. Les modifications du
    fichier de configuration devient ainsi actives en seulement quelques
    minutes.
   </p>
   <p class="para">
    La directive de configuration PHP
    <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.config-file" class="link"><code class="literal">mysqlnd_ms.config_file</code></a> 
    est utilisée pour indiquer le fichier de configuration des plugins. Notez
    que la directive de configuration PHP ne sera pas évaluée pour chaque requête
    web. Toutefois, la modification du nom du fichier de configuration ou son
    lieu de stockage nécessite un redémarrage de PHP. Cependant, aucun redémarrage
    n&#039;est nécessaire pour lire les modifications d&#039;un fichier de configuration
    déjà en place.
   </p>
   <p class="para">
    L&#039;utilisation et l&#039;analyse <acronym title="JavaScript Object Notation">JSON</acronym> est rapide, et l&#039;utilisation
    de <acronym title="JavaScript Object Notation">JSON</acronym> rend simple les structures hiérarchiques par rapport au format standard
    <var class="filename">php.ini</var>.
   </p>
   <p class="para">
    <div class="example" id="example-2213">
     <p><strong>Exemple #1 Conversion d&#039;un hash PHP en frmat JSON</strong></p>
     <div class="example-contents"><p>
      Ou sinon, un développeur peut être plus familier avec la syntaxe PHP
      <span class="type"><a href="language.types.array.html" class="type array">array</a></span> et ainsi, le préférer. Cet exemple montre la façon dont un
      développeur peut convertir un tableau PHP en <acronym title="JavaScript Object Notation">JSON</acronym>.
     </p></div>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$config&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"myapp"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master_0"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"host"&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"socket"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"/tmp/mysql.sock"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"slave"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(),<br />&nbsp;&nbsp;),<br />);<br /><br /></span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">json_encode</span><span style="color: #007700">(</span><span style="color: #0000BB">$config</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">JSON_PRETTY_PRINT</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Fichier&nbsp;mysqlnd_ms.ini&nbsp;créé...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Affichage&nbsp;du&nbsp;contenu...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br />echo&nbsp;</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"\n%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
     <div class="example-contents screen">
<div class="cdata"><pre>
Fichier mysqlnd_ms.ini créé...
Affichage du contenu...
--------------------------------------------------------------------------------
{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: [

        ]
    }
}
--------------------------------------------------------------------------------
</pre></div>
     </div>
    </div>
   </p>
   <p class="para">
    Un fichier de configuration de plugin consiste en une ou plusieurs sections.
    Les sections sont représentées par des propriétés d&#039;objet haut-niveau
    de l&#039;objet encodé dans le fichier <acronym title="JavaScript Object Notation">JSON</acronym>. Les sections
    peuvent aussi être appelées des <em class="emphasis">noms de configuration</em>.
   </p>
   <p class="para">
    Les applications font références aux sections par leurs noms. Les applications
    utilisent les noms de sections comme paramètre hôte (serveur) dans les 
    méthodes de connexions des extensions
    <a href="ref.mysqli.html" class="link">mysqli</a>,
    <a href="ref.mysql.html" class="link">mysql</a> et
    <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a>. Une fois connectée, le plugin
    <a href="book.mysqlnd.html" class="link">mysqlnd</a> compare le nom de l&#039;hôte avec tous
    les noms de sections du fichier de configuration du plugin. Si le nom d&#039;hôte et
    le nom de la section correspondent, le plugin chargera les paramètres de cette
    section.
   </p>
   <p class="para" id="mysqlnd-ms.plugin-ini-json.using-section">
    <div class="example" id="example-2214">
     <p><strong>Exemple #2 Exemple d&#039;utilisation des noms de section</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: 3306
            }
        }
    },
    &quot;localhost&quot;: {
        &quot;master&quot;: [
            {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/path\/to\/mysql.sock&quot;
            }
        ],
        &quot;slave&quot;: [
            {
                &quot;host&quot;: &quot;192.168.3.24&quot;,
                &quot;port&quot;: &quot;3305&quot;
            },
            {
                &quot;host&quot;: &quot;192.168.3.65&quot;,
                &quot;port&quot;: &quot;3309&quot;
            }
        ]
    }
}</pre>
</div>
     </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Toutes&nbsp;les&nbsp;connexions&nbsp;suivantes&nbsp;seront&nbsp;en&nbsp;balance&nbsp;de&nbsp;charge&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$pdo&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=myapp;dbname=database'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'username'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'password'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysql_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
   <p class="para">
    Les noms de section sont des chaînes de caractères. Il est valide d&#039;utiliser
    un nom de section comme
    <code class="literal">192.168.2.1</code>, <code class="literal">127.0.0.1</code> ou
    <code class="literal">localhost</code>. Si, par exemple, une application se connecte à
    <code class="literal">localhost</code> et que la section de configuration
    <code class="literal">localhost</code> existe pour ce plugin, la sémantique de l&#039;opération
    de connexion change. L&#039;application n&#039;utilise plus que le serveur MySQL sur l&#039;hôte
    <code class="literal">localhost</code> mais le plugin commence à effectuer un balance de
    charge en suivant les règles issues de la section de configuration
    <code class="literal">localhost</code>. De cette façon, vous pouvez effectuer de la
    balance de charge des requêtes depuis l&#039;application sans aucune modification
    du code source de l&#039;application. Garder à l&#039;esprit qu&#039;une telle configuration
    ne contribue pas à une meilleure lisibilité de votre code source.
    L&#039;utilisation de noms de section qui peuvent être utilisés comme noms d&#039;hôte
    doit être de dernier recours.
   </p>
   <p class="para" id="mysqlnd-ms.plugin-ini-json.server-list-syntax">
    Chaque section de configuration contient au moins une liste de serveurs maîtres,
    et une liste de serveurs esclaves. La liste des maîtres est configurée avec
    le mot clé <code class="literal">master</code>, alors que la liste des esclaves est configurée
    avec le mot clé <code class="literal">slave</code>. Le fait de ne pas fournir de liste
    d&#039;esclaves produit une erreur de type <strong><code>E_ERROR</code></strong> (erreur fatale).
    Malgré le fait que vous ne pouvez pas omettre de liste d&#039;esclaves, elle peut être vide.
    Il est possible de n&#039;autoriser aucun esclave. Cependant, ce n&#039;est recommandé
    que pour les clusters synchrones (lire la documentation sur les
    <a href="mysqlnd-ms.supportedclusters.html" class="link">clusters supportés</a>).
    La majeure partie de la documentation parle que des clusters de réplication
    MySQL asynchrones.
   </p>
   <p class="para">
    Les listes de maîtres et d&#039;esclaves peuvent être optionnellement indexées
    par le nom symbolique du serveur qu&#039;elles décrivent.
   </p>
   <p class="para">
    <div class="example" id="example-2215">
     <p><strong>Exemple #3 Liste des esclaves anonymes</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;slave&quot;: [
    {
        &quot;host&quot;: &quot;192.168.3.24&quot;,
        &quot;port&quot;: &quot;3305&quot;
    },
    {
        &quot;host&quot;: &quot;192.168.3.65&quot;,
        &quot;port&quot;: &quot;3309&quot;
    }
]</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para">
    Une liste de serveurs anonymes est encodée en <code class="literal">JSON array</code>.
    Vous pouvez optionnellement utiliser les noms symboliques pour indexer
    les serveurs esclaves ou maîtres de la liste des serveurs. Dans un dernier ressort,
    vous pouvez utiliser le type <code class="literal">JSON object</code>.
   </p>
   <p class="para">
    <div class="example" id="example-2216">
     <p><strong>Exemple #4 Liste Maître en utilisant les noms symboliques</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;master&quot;: {
    &quot;master_0&quot;: {
        &quot;host&quot;: &quot;localhost&quot;
    }
}</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para">
    Il est recommandé d&#039;indexer la liste des serveurs avec les noms symboliques
    des serveurs. Les noms d&#039;alias seront affichés dans les messages d&#039;erreur.
   </p>
   <p class="para">
    L&#039;ordre des serveurs est préservé et pris en compte par mysqlnd_ms.
    Si, par exemple, vous configurez la stratégie de balance de charge round robin,
    la première requête <code class="literal">SELECT</code> sera exécutée sur l&#039;esclave
    qui apparaît en premier dans la liste des serveurs esclaves.
   </p>
   <p class="para">
    Un serveur configuré peut être décrit avec les paramètres <code class="literal">host</code>,
    <code class="literal">port</code>, <code class="literal">socket</code>, <code class="literal">db</code>,
    <code class="literal">user</code>, <code class="literal">password</code> et <code class="literal">connect_flags</code>.
    Il est obligatoire de définir l&#039;hôte du serveur de base de données en utilisant le
    mot clé <code class="literal">host</code>. Tous les autres paramètres de configuration sont optionnels.
   </p>
   <p class="para">
    <div class="example" id="example-2217">
     <p><strong>Exemple #5 Mot clé pour configurer un serveur</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;,
                &quot;db&quot;: &quot;database_resp_schema&quot;,
                &quot;user&quot;: &quot;user&quot;,
                &quot;password&quot;: &quot;password&quot;,
                &quot;connect_flags&quot;: 0
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;
            }
        }
    }
}</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para">
    Si une configuration est omise, le plugin utilisera la valeur fournie par l&#039;appel API
    de l&#039;utilisateur pour ouvrir la connexion. Reportez-vous à l&#039;exemple ci-dessus
    sur l&#039;<a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">utilisation des noms de section</a>.
   </p>
   <p class="para">
    Le format du fichier de configuration a été modifié en version 1.1.0-beta
    pour permettre les filtres chaînés. Les filtres sont responsables du filtrage de la
    liste de serveurs configurés afin d&#039;identifier un serveur pour l&#039;exécution de la
    requête donnée. Les filtres sont configurés avec le mot clé <code class="literal">filter</code>.
    Les filtres sont exécutés par mysqlnd_ms dans l&#039;ordre de leur apparence.
    La définition de filtres est optionnel. Une section de configuration dans le
    fichier de configuration du plugin n&#039;a pas besoin d&#039;avoir d&#039;entrée
    <code class="literal">filters</code>.
   </p>
   <p class="para">
    Les filtres remplacent la configuration
    <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><code class="literal">pick[]</code></a>
    des précédentes versions. <code class="literal">random</code> et <code class="literal">roundrobin</code>
    fournissent la même fonctionnalité.
   </p>
   <p class="para">
    <div class="example" id="example-2218">
     <p><strong>Exemple #6 Nouveau filtre <code class="literal">roundrobin</code>, ancienne fonctionnalité</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;roundrobin&quot;: [

            ]
        }
    }
}</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para">
    La fonction <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> a été supprimée.
    La définition d&#039;une fonction de rappel est maintenant possible avec le filtre
    <code class="literal">user</code>. Quelques filtres acceptent des paramètres.
    Le filtre <code class="literal">user</code> requière et accepte obligatoirement le paramètre
    <code class="literal">callback</code> pour définir la fonction de rappel précédemment
    définie via la fonction <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>.
    <div class="example" id="example-2219">
     <p><strong>Exemple #7 Le filtre <code class="literal">user</code> remplace la fonction <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span></strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;filters&quot;: {
    &quot;user&quot;: {
        &quot;callback&quot;: &quot;pick_server&quot;
    }
}</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para" id="mysqlnd-ms.plugin-ini-json.debug_config">
    La validité du fichier de configuration est vérifiée à la fois lors de
    la lecture du fichier de configuration mais aussi plus tard, lors de
    l&#039;établissement d&#039;une connexion. Le fichier de configuration est lu
    durant le démarrage de PHP. A ce stade là, une extension PHP ne peut
    afficher les messages d&#039;erreurs proprement. Dans la plupart des cas, aucune
    erreur n&#039;est montrée, et une connexion peut échouer sans pour autant
    avoir un message d&#039;erreur adéquate. Ce problème a été résolu en version 1.5.0.
   </p>
   <p class="para">
    <div class="example" id="example-2220">
     <p><strong>Exemple #8 Message d&#039;erreur commun dans le cas d&#039;une erreur dans le fichier de configuration
      (à partir de la version 1.5.0)</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
     <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code

Warning: mysqli::mysqli(): (HY000/2002): php_network_getaddresses: getaddrinfo failed: Name or service not known in Command line code on line 1

Warning: mysqli::query(): Couldn&#039;t fetch mysqli in Command line code on line 1

Fatal error: Call to a member function fetch_assoc() on a non-object in Command line code on line 1
</pre></div>
     </div>
    </div>
   </p>
   <p class="para">
    Depuis la version 1.5.0, les erreurs au démarrage sont mises en mémoire tampon,
    et émises lorsqu&#039;une tentative de connexion est réalisée. Utilisez la directive de
    configuration
    <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.force-config-usage" class="link"><code class="literal">mysqlnd_ms.force_config_usage</code></a>
    pour définir le type d&#039;erreyr à utiliser pour afficher les erreurs de la mémoire tampon.
    Par défaut, une erreur de type <code class="literal">E_WARNING</code> sera émise.
   </p>
   <p class="para">
    <div class="example" id="example-2221">
     <p><strong>Exemple #9 Validation renforcée du fichier de configuration depuis la version 1.5.0</strong></p>
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
     <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) (mysqlnd_ms) Failed to parse config file [s1.json]. Please, verify the JSON in Command line code on line 1
</pre></div>
     </div>
    </div>
   </p>
   <p class="para">
    Il peut être utile de définir 
    <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.force-config-usage" class="link"><code class="literal">mysqlnd_ms.force_config_usage = 1</code></a>
    lors du débogage des erreurs du fichier de configuration. Ceci ne va pas seulement définir
    le type d&#039;erreurs de démarrage mises en mémoire tampon à <code class="literal">E_RECOVERABLE_ERROR</code>
    mais aussi va vous aider à détecter les noms de section erronés.
   </p>
   <p class="para">
    <div class="example" id="example-2222">
     <p><strong>Exemple #10 Erreur plus précise grâce à l&#039;utilisation de <code class="literal">mysqlnd_ms.force_config_usage=1</code></strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.force_config_usage=1</pre>
</div>
     </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"invalid_section"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

     <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
     <div class="example-contents screen">
<div class="cdata"><pre>
Warning: mysqli::mysqli(): (mysqlnd_ms) Exclusive usage of configuration enforced but did not find the correct INI file section (invalid_section) in Command line code on line 1 line 1
</pre></div>
     </div>
     
    </div>
   </p>
  </div>
  
  <div class="section" id="mysqlnd-ms.plugin-ini-json-reference">
   <h2 class="title">Directives de configuration</h2>
   
   <p class="para">
    Voici une explication rapide des directives de configuration qui peuvent être utilisées.
   </p>
   
   <p class="para">
    <dl>

     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.master">
       <code class="parameter">master</code>
       <span class="type"><span class="type tableau ou object">tableau ou object</span></span>
      </dt>

      <dd>

       <p class="para">
        Liste de serveurs maîtres de réplication MySQL. La liste est au
        format <code class="literal">JSON type array</code> pour déclarer une liste
        anonyme de serveurs ou au format <code class="literal">JSON type object</code>.
        Reportez-vous aux <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.server-list-syntax" class="link">exemples
        ci-dessous</a>.
       </p>
       <p class="para">
        La définition d&#039;au moins un serveur maître est obligatoire. Le plugin
        émettra une erreur de type <code class="literal">E_ERROR</code> si l&#039;utilisateur
        n&#039;a pas fourni de liste de serveurs maîtres dans une section
        de configuration. L&#039;erreur fatale ressemble à ceci :
        <code class="literal">(mysqlnd_ms) Section [master] doesn&#039;t exist for host
         [name_of_a_config_section] in %s on line %d</code>.
       </p>
       <p class="para">
        Un serveur est décrit avec les paramètres
        <code class="literal">host</code>, <code class="literal">port</code>,
        <code class="literal">socket</code>, <code class="literal">db</code>,
        <code class="literal">user</code>, <code class="literal">password</code> et
        <code class="literal">connect_flags</code>.
        Il est obligatoire de fournir une valeur pour le paramètre
        <code class="literal">host</code>. Si n&#039;importe quel autre paramètre
        n&#039;est pas fourni, il sera récupéré depuis l&#039;appel API de
        connexion. Reportez-vous aux
        <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">exemples d&#039;utilisation
         des noms de section</a>.
       </p>
       <p class="para" id="mysqlnd-ms.plugin-ini-json.server-config-keywords">
        Tableau de mot clé pour les serveurs dans la configuration.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">host</code>
           </td>
           <td>
            <p class="para">
             Hôte du serveur de base de données. Cette donnée est obligatoire.
             Le fait de ne pas le fournir émettra une erreur de type
             <code class="literal">E_RECOVERABLE_ERROR</code> lorsque le plugin tentera
             de se connecter au serveur. Le message d&#039;erreur ressemblera à ceci : 
             <code class="literal">(mysqlnd_ms) Cannot find [host] in [%s] section in config in %s on line %d</code>.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">port</code>
           </td>
           <td>
            <p class="para">
             Port TCP/IP du serveur de base de données.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">socket</code>
           </td>
           <td>
            <p class="para">
             Socket du domaine Unix du serveur de base de données.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">db</code>
           </td>
           <td>
            <p class="para">
             Base de données (schemata).
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">user</code>
           </td>
           <td>
            <p class="para">
             Utilisateur de la base de données MySQL.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">password</code>
           </td>
           <td>
            <p class="para">
             Mot de passe pour l&#039;utilisateur de la base de données MySQL.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">connect_flags</code>
           </td>
           <td>
            <p class="para">
             Drapeaux de connexion.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

         </tbody>
        
       </table>

       <p class="para">
        Le plugin supporte l&#039;utilisation d&#039;un seul serveur maître.
        Une configuration expérimentale existe pour activer le support
        multi-maître. Les détails ne sont pas actuellement documentés.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.slave">
       <code class="parameter">slave</code>
       <span class="type"><span class="type tableau ou object">tableau ou object</span></span>
      </dt>

      <dd>

       <p class="para">
        Liste un ou plusieurs serveurs esclaves de réplication MySQL. La syntaxe
        est identique à la configuration des serveurs maîtres. Reportez-vous au
        <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.master" class="link"><code class="literal">master</code></a>
        ci-dessus pour plus de détails.
       </p>
       <p class="para">
        Le plugin supporte l&#039;utilisation d&#039;un ou plusieurs esclaves.
       </p>
       <p class="para">
        Le fait de définit une liste de serveurs esclaves est obligatoire. Le plugin
        émettra une erreur de type <code class="literal">E_ERROR</code> si <code class="literal">slave</code>
        n&#039;est pas fourni dans une section de configuration. Le message d&#039;erreur fatale
        devrait afficher quelque chose comme
        <code class="literal">(mysqlnd_ms) Section [slave] doesn&#039;t exist for host [%s] in %s on line %d</code>.
        Notez qu&#039;il est valide d&#039;utiliser une liste de serveur esclave vide. L&#039;erreur
        a été introduite pour prévenir une configuration accidentelle des esclaves
        en oubliant la configuration <code class="literal">slave</code> setting.
        Une configuration de maîtres uniquement est toujours possible en utilisant
        une liste d&#039;esclave vide.
       </p>
       <p class="para">
        Si une liste d&#039;esclave vide est configuré et une tentative est faîte
        d&#039;exécuter une requête sur un esclave, le plugin émettra une alerte du
        type <code class="literal">mysqlnd_ms) Couldn&#039;t find the appropriate slave connection.
        0 slaves to choose from.</code> lors de l&#039;exécution. Il est possible
        qu&#039;une autre alerte suive, comme ceci
        <code class="literal">(mysqlnd_ms) No connection selected by the last filter</code>.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.gtid">
       <code class="parameter">global_transaction_id_injection</code>
       <span class="type"><span class="type array ou objet">array ou objet</span></span>
      </dt>

      <dd>

       <p class="para">
        Configuration de GTID dans le cas de l&#039;inclusion directe dans le serveur, et
        l&#039;émulation coté client.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot-clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">fetch_last_gtid</code>
           </td>
           <td>
            <p class="para">
             Requête SQL pour recupérer le dernier GTID. La requête est lancée si le plugin
             a besoin de connaitre le dernier GTID. Ce peut être le cas, par exemple, pour vérifier
             le statut de réplication d&#039;un esclave MySQL. Aussi utilisé avec
             <span class="function"><a href="function.mysqlnd-ms-get-last-gtid.html" class="function">mysqlnd_ms_get_last_gtid()</a></span>.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">check_for_gtid</code>
           </td>
           <td>
            <p class="para">
             Requête SQL pour vérifier sur un réplica a répliqué toutes les transactions
             jusqu&#039;à une certaine, recherchée. La requête est jouée lorsqu&#039;une recherche
             de réplica pouvant offrir un niveau de consistence supérieur est lancée.
             La requête doit comporter un jocker <code class="literal">#GTID</code> qui sera remplacé
             par le GTID recherché par le plugin. Voyez le
             <a href="mysqlnd-ms.quickstart.gtid.html" class="link">quickstart</a> pour les exemples.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">report_errors</code>
           </td>
           <td>
            <p class="para">
             Si oui ou non une erreur de type warning doit être levée dans le cas
             où une requête SQL configurée provoque une erreur.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">on_commit</code>
           </td>
           <td>
            <p class="para">
             Emulation GTID coté client uniquement. Requête SQL a exécuter lorsqu&#039;une
             transaction a fini de mettre à jour le GTID sur le maitre. Voyez
             <a href="mysqlnd-ms.quickstart.gtid.html" class="link">quickstart</a> pour les exemples.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">wait_for_gtid_timeout</code>
           </td>
           <td>
            <p class="para">
             Indique au plugin d&#039;attendre <code class="literal">wait_for_gtid_timeout</code>
             secondes pour attraper un esclave lors d&#039;une recherche d&#039;esclaves
             qui peuvent délivrer une consistence de session. Cette option
             limite le temps consacré pour interroger le statut de l&#039;esclave.
             Si cette interrogation prend trop de temps, le temps passé
             au total peut dépasser la valeur de l&#039;option <code class="literal">wait_for_gtid_timeout</code>.
             Le plugin appel <code class="literal">sleep(1)</code> pour attendre une seconde
             entre deux demandes.
            </p>
            <p class="para">
             L&#039;option peut être utilisée avec l&#039;émulation côté client mais aussi
             avec la fonctionalité des identifiants globaux de transaction de MySQL 5.6.
            </p>
            <p class="para">
             L&#039;attente d&#039;un esclave pour répliquer un certain GTID nécessaire
             pour une consistence de session signifie également l&#039;étranglement
             du client. En étranglant le client, le charge en écriture du maître
             est indirectement réduite. Une copie primaire basé sur le système
             de réplication, comme une réplication MySQL, prend plus de temps
             pour atteindre un statut de consistence. Ce comportement peut
             être désiré, par exemple, pour accroitre le nombre de copies de 
             données pour des considérations de haute disponibilité, ou
             pour prévenir la surcharge du maître.
            </p>
           </td>
           <td>Depuis 1.4.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.fabric">
       <code class="parameter">fabric</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        La configuration relative à MySQL Fabric. Si le plugin est utilisé
        avec MySQL Fabric, alors le fichier de configuration du plugin ne contiendra
        plus la liste des serveurs MySQL. A la place, le plugin demandera à
        MySQL Fabric la liste des serveurs à utiliser pour effectuer certaines tâches.
       </p>
       <p class="para">
        Au minimum, le fichier de configuration du plugin à utiliser avec
        MySQL Fabric contiendra un ou plusieurs hôtes MySQL Fabric que le plugin
        peut interroger. Si plus d&#039;un hôte MySQL Fabric est configuré, le plugin
        utilisera la stratégie roundrobin pour effectuer son choix.
        Les autres stratégies ne sont actuellement pas disponible.
       </p>
       <p class="para">
        <div class="example" id="example-2223">
         <p><strong>Exemple #11 Configuration minimale du plugin pour son utilisation avec MySQL Fabric</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;fabric&quot;: {
            &quot;hosts&quot;: [
                {
                    &quot;host&quot; : &quot;127.0.0.1&quot;,
                    &quot;port&quot; : 8080
                }
            ]
        }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Chaque hôte MySQL Fabric est décrit en utilisant un objet JSON contenant les
        membres suivants.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">host</code>
           </td>
           <td>
            <p class="para">
             Nom de l&#039;hôte du serveur MySQL Fabric.
            </p>
           </td>
           <td>Depuis 1.6.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">port</code>
           </td>
           <td>
            <p class="para">
             Le port TCP/IP sur lequel écoute le serveur MySQL Fabric
             pour les appels aux procédures distantes envoyées par les
             clients comme le plugin.
            </p>
           </td>
           <td>Depuis 1.6.0.</td>
          </tr>

         </tbody>
        
       </table>

       <p class="para">
        Le plugin utilise les flux PHP pour communiquer avec MySQL Fabric
        via XML RPC sur HTTP. Par défaut, aucun délai maximal d&#039;attente
        n&#039;est défini pour les communications réseaux. Aussi, le plugin
        utilisera les délais d&#039;attente maximale par défaut des flux PHP.
        Ces valeurs ne sont pas contrôlées par le plugin lui même.
       </p>
       <p class="para">
        Une valeur optionnelle du délai d&#039;attente maximale peut être définie
        en écrasant la valeur par défaut des flux PHP. Le fait de définir
        la valeur du délai d&#039;attente maximale dans le fichier de configuration
        du plugin a le même effet que de définir un délai d&#039;attente dans l&#039;espace
        utilisateur PHP des connexions HTTP établies via les flux PHP.
       </p>
       <p class="para">
        L&#039;unité de la valeur du délai d&#039;attente maximale de Fabric est la seconde.
        L&#039;intervalle de valeur autorisée est 0 - 65535. Cette configuration existe
        depuis la version 1.6.
       </p>
       <p class="para">
        <div class="example" id="example-2224">
         <p><strong>Exemple #12 Délai d&#039;attente maximale optionnelle pour les communications avec Fabric</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;fabric&quot;: {
            &quot;hosts&quot;: [
                {
                    &quot;host&quot; : &quot;127.0.0.1&quot;,
                    &quot;port&quot; : 8080
                }
            ],
            &quot;timeout&quot;: 2
        }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Les <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.trx-stickiness" class="link">transactions stickiness</a>
        et la logique MySQL Fabric peuvent cohabiter. L&#039;option stickiness
        désactive le chagement de serveur pendant la durée d&#039;une transaction.
        Lors de l&#039;utilisation de Fabric ainsi que du partage, l&#039;utilisateur peut
        (par erreur) commencer une transaction locale sur un serveur partagé, puis,
        tenter de changer de serveur en utilisant soit la fonction
        <span class="function"><a href="function.mysqlnd-ms-fabric-select-shard.html" class="function">mysqlnd_ms_fabric_select_shard()</a></span>, soit la fonction
       <span class="function"><a href="function.mysqlnd-ms-fabric-select-global.html" class="function">mysqlnd_ms_fabric_select_global()</a></span>. Dans ce cas,
        le plugin ne va pas rejeter la requête de changement de serveur au milieu
        d&#039;une transaction, mais autoriser l&#039;utilisateur à changer de serveur suivant la
        configuration stickiness de la transaction utilisée. Ceci est clairement une erreur
        de l&#039;utilisation d&#039;écrire ce genre de code.
       </p>
       <p class="para">
        Si les transactions stickiness sont actives, et que vous souhaitez récupérer
        une alerte lors de l&#039;appel à la fonction <span class="function"><a href="function.mysqlnd-ms-fabric-select-shard.html" class="function">mysqlnd_ms_fabric_select_shard()</a></span>
        ou <span class="function"><a href="function.mysqlnd-ms-fabric-select-global.html" class="function">mysqlnd_ms_fabric_select_global()</a></span>,
        définissez le booléen <code class="literal">trx_warn_server_list_changes</code>.
       </p>
       <p class="para">
        <div class="example" id="example-2225">
         <p><strong>Exemple #13 Alerte lors de la violation des limitations des transactions</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;fabric&quot;: {
            &quot;hosts&quot;: [
                {
                    &quot;host&quot; : &quot;127.0.0.1&quot;,
                    &quot;port&quot; : 8080
                }
            ],
            &quot;trx_warn_serverlist_changes&quot;: 1
        },
        &quot;trx_stickiness&quot;: &quot;on&quot;
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*<br />&nbsp;&nbsp;Pour&nbsp;la&nbsp;démo,&nbsp;l'appel&nbsp;doit&nbsp;échouer.<br />&nbsp;&nbsp;Echec&nbsp;ou&nbsp;non,&nbsp;nous&nbsp;arrivons&nbsp;dans&nbsp;un&nbsp;cas&nbsp;souhaité&nbsp;pour&nbsp;l'exemple.<br />*/<br /></span><span style="color: #007700">@</span><span style="color: #0000BB">mysqlnd_ms_fabric_select_global</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$link</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">begin_transaction</span><span style="color: #007700">();<br />@</span><span style="color: #0000BB">$link</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*<br />&nbsp;&nbsp;Le&nbsp;changement&nbsp;de&nbsp;serveurs&nbsp;est&nbsp;une&nbsp;erreur&nbsp;en&nbsp;raison<br />&nbsp;&nbsp;de&nbsp;l'ouverture&nbsp;d'une&nbsp;transaction&nbsp;locale&nbsp;!<br />*/<br /></span><span style="color: #0000BB">mysqlnd_ms_select_global</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
         <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning: mysqlnd_ms_fabric_select_global(): (mysqlnd_ms) Fabric server exchange in the middle of a transaction in %s on line %d
</pre></div>
         </div>
        </div>
       </p>
       <p class="para">
        Veuillez considérer cette fonctionalité comme expérimentale.
        Une modification de la syntaxe ou de la sémantique peut intervenir à tout moment.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filters">
       <code class="parameter">filters</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Liste des filtres. Un filtre est prévu pour filtrer la liste des serveurs disponibles
        pour l&#039;exécution d&#039;une requête donnée. Ils peuvent être chaînés.
        Le filtre <code class="literal">random</code> et le filtre <code class="literal">roundrobin</code>
        remplacent la directive
        <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><code class="literal">pick[]</code></a>
        utilisée dans les versions précédantes pour sélectionner une politique de balance
        de charge. le filtre <code class="literal">user</code> remplace la fonction
        <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>.
       </p>
       <p class="para">
        Les filtres peuvent accepter des paramètres pour redéfinir leurs actions.
       </p>
       <p class="para">
        Si aucune politique de balance de charge n&#039;est définie, le plugin
        prendra par défaut le filtre <code class="literal">random_once</code>.
        Le filtre <code class="literal">random_once</code> sélectionne un serveur esclave
        aléatoire lors de l&#039;exécution de la première requête de lecture. Le serveur
        esclave sera ensuite utilisé pour exécuter toutes les requêtes de
        lecture seule jusqu&#039;à la fin du script PHP. Aucune politique de balance de
        charge n&#039;est définie et ainsi, le mode par défaut prend place si
        ni le filtre <code class="literal">random</code>, ni le filtre <code class="literal">roundrobin</code>
        n&#039;est présent dans une section de configuration.
       </p>
       <p class="para">
        Si un filtre chaîné est configuré de tel façon qu&#039;un filtre qui
        affiche en sortie pas plus d&#039;un serveur utilisé comme entrée pour un
        filtre dont on doit passer plus d&#039;un serveur en entrée, le plugin peut
        émettre une alerte lors de l&#039;ouverture de la connexion. L&#039;alerte
        ressemblera à quelque chose comme : <code class="literal">(mysqlnd_ms) Error while creating
        filter &#039;%s&#039; . Non-multi filter &#039;%s&#039; already created.
        Stopping in %s on line %d</code>. En plus une erreur de code
        <code class="literal">2000</code>, un statut sql <code class="literal">HY000</code>
        et un message d&#039;erreur similaire à l&#039;alerte peuvent être définis
        sur le gestionnaire de connexion.
       </p>
       <p class="para">
        <div class="example" id="example-2226">
         <p><strong>Exemple #14 Séquence de filtres invalide</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;,
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$link</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
         <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning:  mysqli::mysqli(): (HY000/2000): (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping in filter_warning.php on line 1
[2000] (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping
PHP Warning:  mysqli::query(): Couldn&#039;t fetch mysqli in filter_warning.php on line 3
</pre></div>
         </div>
        </div>
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-random">
       Filtre : <code class="parameter">random</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Le filtre <code class="literal">random</code> fournit les fonctionnalités de
        sélection aléatoire et de sélection aléatoire unique pour
        la politique de balance de charge, équivalent à la directive
        <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><code class="literal">pick[]</code></a>
        dans les précédentes versions.
       </p>
       <p class="para">
        La politique de sélection aléatoire va prendre un serveur aléatoirement
        lorsqu&#039;une requête en lecture seule est exécutée. La stratégie de sélection
        aléatoire unique va sélectionner un serveur esclave aléatoirement et va
        continuer de l&#039;utiliser pour le reste des requêtes PHP. La sélection aléatoire
        unique est le mode par défaut, si la balance de charge n&#039;est pas configurée
        via un filtre.
       </p>
       <p class="para">
        Si le filtre <code class="literal">random</code> ne fournit aucun argument,
        la politique de balance de charge sera la sélection aléatoire.
       </p>
       <p class="para">
        <div class="example" id="example-2227">
         <p><strong>Exemple #15 Balance de charge aléatoire avec le filtre <code class="literal">random</code></strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Optionnellement, l&#039;argument <code class="literal">sticky</code> peut être passé au filtre.
        Si l&#039;argument <code class="literal">sticky</code> est défini en la chaîne de caractère
        <code class="literal">1</code>, le filtre suit la stratégie de sélection aléatoire unique.
       </p>
       <p class="para">
        <div class="example" id="example-2228">
         <p><strong>Exemple #16 Balance de charge avec sélection aléatoire unique avec le filtre <code class="literal">random</code></strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;filters&quot;: {
        &quot;random&quot;: {
            &quot;sticky&quot;: &quot;1&quot;
        }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        A la fois le filtre <code class="literal">random</code> et le filtre
        <code class="literal">roundrobin</code> supportent la définition d&#039;une priorité,
        un poids pour un serveur, et ce, depuis PECL/mysqlnd_ms 1.4.0.
        Si l&#039;argument <code class="literal">weight</code> est passé au filtre, il doit
        assigner un poids à tous les serveurs. Les serveurs doivent donner
        un alias dans la liste des serveurs <code class="literal">slave</code> et
        <code class="literal">master</code>. L&#039;alias doit être utilisé pour référencer
        les serveurs pour l&#039;assignement d&#039;une priorité avec l&#039;argument <code class="literal">weight</code>.
       </p>
       <p class="para">
        <div class="example" id="example-2229">
         <p><strong>Exemple #17 Erreur de référencement</strong></p>
         <div class="example-contents screen">
<div class="cdata"><pre>
[E_RECOVERABLE_ERROR] mysqli_real_connect(): (mysqlnd_ms) Unknown server &#039;slave3&#039; in &#039;random&#039; filter configuration. Stopping in %s on line %d
</pre></div>
         </div>
        </div>
       </p>
       <p class="para">
        L&#039;utilisation d&#039;un mauvais alias avec l&#039;argument
        <code class="literal">weight</code> peut conduire à une erreur similaire
        à celle de l&#039;exemple ci-dessus.
       </p>
       <p class="para">
        Si <code class="literal">weight</code> est omis, le poids par défaut de tous les
        serveurs sera de un.
       </p>
       <p class="para">
        <div class="example" id="example-2230">
         <p><strong>Exemple #18 Assignement d&#039;un argument <code class="literal">weight</code> pour la balance de charge</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
   &quot;myapp&quot;: {
       &quot;master&quot;: {
           &quot;master1&quot;:{
               &quot;host&quot;:&quot;localhost&quot;,
               &quot;socket&quot;:&quot;\/var\/run\/mysql\/mysql.sock&quot;
           }
       },
       &quot;slave&quot;: {
           &quot;slave1&quot;: {
               &quot;host&quot;:&quot;192.168.2.28&quot;,
               &quot;port&quot;:3306
           },
           &quot;slave2&quot;: {
               &quot;host&quot;:&quot;192.168.2.29&quot;,
               &quot;port&quot;:3306
           },
           &quot;slave3&quot;: {
               &quot;host&quot;:&quot;192.0.43.10&quot;,
               &quot;port&quot;:3306
           },
       },
       &quot;filters&quot;: {
           &quot;random&quot;: {
               &quot;weights&quot;: {
                   &quot;slave1&quot;:8,
                   &quot;slave2&quot;:4,
                   &quot;slave3&quot;:1,
                   &quot;master1&quot;:1
               }
           }
       }
   }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        En moyenne, un serveur dont le poids est de deux sera sélectionné
        de fois plus qu&#039;un serveur dont le poids est de un. Différents poids
        peuvent être assignés pour refléter différentes tailles de machine,
        pour préférer des esclaves proches qui ont une latence réseau faible, ou
        pour configurer un serveur de secours en cas d&#039;échec. Dans ce dernier
        cas, vous pouvez vouloir assigner au serveur de secours un poids
        très faible par rapport aux autres serveurs. Par exemple, si l&#039;on reprend
        la configuration ci-dessus, <code class="literal">slave3</code> ne recevra qu&#039;en
        moyenne huit pourcent des requêtes. Tant que les esclaves <code class="literal">slave1</code>
        et <code class="literal">slave2</code> fonctionnent, il sera utilisé rarement,
        un peu à la façon d&#039;un serveur de secours. En cas d&#039;erreur sur l&#039;esclave
        <code class="literal">slave1</code> et l&#039;esclave <code class="literal">slave2</code>,
        l&#039;utilisation de l&#039;esclave <code class="literal">slave3</code> augmentera.
        Veuillez lire les notes relative au failover avant d&#039;utiliser
        l&#039;argument <code class="literal">weight</code> dans ce but.
       </p>
       <p class="para">
        L&#039;intervalle de valeurs valides pour le poids est de 1 à 65535.
       </p>
       <p class="para">
        Les arguments inconnus sont ignorés par le filtre. Aucune alerte
        ni erreur n&#039;est fourni.
       </p>
       
       <p class="para">
        Le filtre attente un ou plusieurs serveurs en entrée et ne sort qu&#039;un
        seul serveur.
        Une séquence de filtre comme
        <code class="literal">random</code>, <code class="literal">roundrobin</code> peut
        émettre une alerte et un message d&#039;erreur définis sur le
        gestionnaire de connexion lors de l&#039;exécution d&#039;une requête.
       </p>
       <p class="para">
        Liste des arguments du filtre.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">sticky</code>
           </td>
           <td>
            <p class="para">
             Active ou désactive la politique de balance de charge
             &quot;random once&quot;. Voir ci-dessus.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">weight</code>
           </td>
           <td>
            <p class="para">
             Assigne une priorité/un poids de balance de charge
             à un serveur. Voir ci-dessus pour une description.
            </p>
           </td>
           <td>Depuis 1.4.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-roundrobin">
       Filtre : <code class="parameter">roundrobin</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Lors de l&#039;utilisation du filtre <code class="literal">roundrobin</code>,
        le plugin parcourt la liste des serveurs esclaves configurés pour
        y sélectionner un serveur à utiliser pour l&#039;exécution d&#039;une requête.
        Si le plugin atteint la fin de la liste, il se replace au début
        et prend le premier serveur esclave configuré.
       </p>
       <p class="para">
        <div class="example" id="example-2231">
         <p><strong>Exemple #19 Filtre <code class="literal">roundrobin</code></strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;
        ]
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Attends un ou plusieurs serveurs en entrée. Sort un seul serveur.
        Une séquence de filtres comme
        <code class="literal">roundrobin</code>, <code class="literal">random</code> peut émettre
        une alerte et un message d&#039;erreur définis sur le gestionnaire de connexion
        lors de l&#039;exécution d&#039;une requête.
       </p>
       <p class="para">
        Liste des arguments du filtre.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">weight</code>
           </td>
           <td>
            <p class="para">
             Assigne une priorité/un poids à un serveur. Repportez-vous
             à la <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.filter-random" class="link">section
             ci-dessus</a> pour plus de détails.
            </p>
           </td>
           <td>Depuis 1.4.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user">
       Filtre : <code class="parameter">user</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Le filtre <code class="literal">user</code> remplace la fonction 
        <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>,
        qui a été supprimée en version 1.1.0-beta. Le filtre définit une fonction
        de rappel pour la séparation définie par l&#039;utilisateur des lectures et des écritures
        ainsi que la sélection de serveurs.
       </p>
       <p class="para">
        Le mécanisme interne du plugin de décisions de séparation des lectures
        et des écritures peut être surchargé de deux façons. La façon la plus simple
        est d&#039;ajouter en début de requête l&#039;astuce SQL <strong><code>MYSQLND_MS_MASTER_SWITCH</code></strong>,
        <strong><code>MYSQLND_MS_SLAVE_SWITCH</code></strong> ou
        <strong><code>MYSQLND_MS_LAST_USED_SWITCH</code></strong>. L&#039;utilisation des astuces SQL
        permet de contrôler, par exemple, si une requête doit être envoyée au serveur maître
        de réplication SQL ou à un des serveurs esclaves. Avec les astuces SQL,
        il n&#039;est pas possible de sélectionner un serveur esclave en particulier pour
        l&#039;exécution d&#039;une requête.
       </p>
       <p class="para">
        Le contrôle total de la sélection des serveurs peut être atteint en utilisant
        une fonction de rappel. Son utilisation est recommandée aux utilisateurs experts
        uniquement, tout simplement par la fonction de rappel doit couvrir tous les
        cas que doit normalement gérer le plugin.
       </p>
       <p class="para">
        Le plugin invoquera la fonction de rappel pour la sélection d&#039;un serveur
        depuis la liste des serveurs maîtres et esclaves configurés. La fonction
        de rappel inspecte la requête à exécuter, sélectionne un serveur pour son
        exécution en retourner l&#039;URI de l&#039;hôte, tel que trouvé dans la liste des
        serveurs maîtres et esclaves.
       </p>
       <p class="para">
        Si les connexions paresseuses sont actives et que la fonction de rappel
        choisit un serveur esclave dont aucune connexion n&#039;a été établie, et que
        la connexion échoue, le plugin retournera une erreur lors de la prochaine action
        sur la connexion échouée, par exemple, lors de l&#039;exécution d&#039;une requête.
        Il en est de la responsabilité du développeur de l&#039;application de gérer cette
        erreur. Par exemple, l&#039;application peut ré-exécuter la requête pour lancer
        la sélection d&#039;un nouveau serveur et invoquer à nouveau la fonction de rappel.
        Ainsi, la fonction de rappel doit s&#039;assurer de sélectionner un serveur différent,
        ou de vérifier la disponibilité de l&#039;esclave, avant de retourner au plugin
        et ce, afin de ne pas entrer dans une boucle infinie.
       </p>
       <p class="para">
        <div class="example" id="example-2232">
         <p><strong>Exemple #20 Définition d&#039;une fonction de rappel</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        La fonction de rappel est supposée retourner un hôte sur lequel
        la requête sera exécutée. L&#039;URI de l&#039;hôte doit être récupérée depuis
        la liste des connexions aux serveurs maîtres et esclaves. Si la fonction
        de rappel retourne une valeur ni trouvée dans la liste des connexions
        aux serveurs maîtres, ni trouvée dans la liste des connexions esclaves,
        le plugin émettra une erreur de type <code class="literal">E_RECOVERABLE_ERROR</code>.
        L&#039;erreur sera quelque chose comme :
        <code class="literal">  (mysqlnd_ms) User filter callback has returned an unknown server.
         The server &#039;server that is not in master or slave list&#039; can neither be found
         in the master list nor in the slave list</code>.
        Si l&#039;application attrape l&#039;erreur afin de l&#039;ignirer, les erreurs suivantes
        seront définies sur le gestionnaire de connexion, par exemple,
        <code class="literal">(mysqlnd_ms) No connection selected by the last filter</code> avec
        le code erreur <code class="literal">2000</code> ainsi que le statut sql <code class="literal">HY000</code>.
        Et enfin, une alerte peut être émise.
       </p>
       <p class="para">
        Le fait de référencer une fonction inexistante comme fonction de rappel
        résultera en une erreur de type <code class="literal">E_RECOVERABLE_ERROR</code>
        lorsque le plugin tentera d&#039;utiliser la fonction de rappel. Le message
        d&#039;erreur sera quelque chose comme :
        <code class="literal">(mysqlnd_ms) Specified callback (pick_server) is
         not a valid callback</code>. Si l&#039;application attrape l&#039;erreur afin
        de l&#039;ignorer, les erreurs peuvent être définies sur le gestionnaire de connexion,
        par exemple,
        <code class="literal">(mysqlnd_ms) Specified callback (pick_server) is
         not a valid callback</code> avec le code erreur <code class="literal">2000</code>
        ainsi que le statut sql <code class="literal">HY000</code>. De plus, une alerte sera émise.
       </p>
       <p class="para">
        Les paramètres suivants sont passés depuiq le plugin à la fonction de rappel.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Paramètre</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">connected_host</code>
           </td>
           <td>
            <p class="para">
             URI du serveur de base de données actuellement connecté.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">query</code>
           </td>
           <td>
            <p class="para">
             La requête pour laquelle un serveur doit être sélectionné.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">masters</code>
           </td>
           <td>
            <p class="para">
             Liste des serveurs maîtres depuis lequel le choix sera fait.
             Notez que la liste des serveurs maîtres peut ne pas être identiques
             à la liste des serveurs maîtres configurés, si le filte n&#039;est
             pas le premier dans la chaîne des filtres. Les filtres précédemment
             configurés peuvent avoir réduit cette liste.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">slaves</code>
           </td>
           <td>
            <p class="para">
             Liste des serveurs esclaves depuis lequel le choix sera fait.
             Notez que la liste des serveurs esclaves peut ne pas être identiques
             à la liste des serveurs esclaves configurés, si le filte n&#039;est
             pas le premier dans la chaîne des filtres. Les filtres précédemment
             configurés peuvent avoir réduit cette liste.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">last_used_connection</code>
           </td>
           <td>
            <p class="para">
             URI du serveur de la connexion utilisée pour exécuter
             la précédente requête.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">in_transaction</code>
           </td>
           <td>
            <p class="para">
             Drapeau booléen indiquant si la requête fait partie d&#039;une
             transaction ouverte. Si le mode autocommit est désactivé,
             il sera définit à <strong><code>TRUE</code></strong>, <strong><code>FALSE</code></strong> sinon.
            </p>
            <p class="para">
             La détection de la transaction est basée sur la surveillance
             de l&#039;appel de <code class="literal">set_autocommit</code> sur la bibliothèque mysqlnd.
             La surveillance n&#039;est pas possible avant PHP 5.4.0. Reportez-vous à la
             <a href="mysqlnd-ms.pooling.html" class="link">pile et au changement de connexion</a>
             pour plus de détails.
            </p>
           </td>
           <td>Depuis la version 1.1.0.</td>
          </tr>

         </tbody>
        
       </table>

       <p class="para">
        <div class="example" id="example-2233">
         <p><strong>Exemple #21 Utilisation d&#039;une fonction de rappel</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$slave_idx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br />&nbsp;if&nbsp;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">))<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;défaut&nbsp;:&nbsp;retour&nbsp;à&nbsp;la&nbsp;logique&nbsp;interne&nbsp;du&nbsp;plugin&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"L'utilisation&nbsp;s'est&nbsp;connecté&nbsp;sur&nbsp;'%s'...\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$connected</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;décision&nbsp;du&nbsp;serveur&nbsp;pour&nbsp;exécuter&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #0000BB">$where&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_query_is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;switch&nbsp;(</span><span style="color: #0000BB">$where</span><span style="color: #007700">)<br />&nbsp;{<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_MASTER</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;utilisation&nbsp;du&nbsp;maître\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_SLAVE</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;SELECT&nbsp;ou&nbsp;astuce&nbsp;SQL&nbsp;pour&nbsp;l'utilisation&nbsp;d'un&nbsp;esclave&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">stristr</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">))<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;une&nbsp;table&nbsp;qui&nbsp;est&nbsp;uniquement&nbsp;sur&nbsp;le&nbsp;premier&nbsp;esclave&nbsp;configuré&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;accès&nbsp;à&nbsp;la&nbsp;table&nbsp;disponible&nbsp;uniquement&nbsp;sur&nbsp;l'esclave&nbsp;A&nbsp;détectée\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;round&nbsp;robin&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;quelques&nbsp;requêtes&nbsp;en&nbsp;lecture&nbsp;seul&nbsp;pour&nbsp;un&nbsp;esclave\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">$slave_idx</span><span style="color: #007700">++&nbsp;%&nbsp;</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_LAST_USED</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;utilisation&nbsp;du&nbsp;dernier&nbsp;serveur&nbsp;utilisé\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;}<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;ret&nbsp;=&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">);<br />&nbsp;return&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;2&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher :</p></div>
         <div class="example-contents screen">
<div class="cdata"><pre>
L&#039;utilisation s&#039;est connecté sur &#039;myapp&#039;...
... décision du serveur pour exécuter &#039;SELECT 1 FROM DUAL&#039;
... quelques requêtes en lecture seul pour un esclave
... ret = &#039;tcp://192.168.2.27:3306&#039;
L&#039;utilisation s&#039;est connecté sur &#039;myapp&#039;...
... décision du serveur pour exécuter &#039;SELECT 2 FROM DUAL&#039;
... quelques requêtes en lecture seul pour un esclave
... ret = &#039;tcp://192.168.78.136:3306&#039;
L&#039;utilisation s&#039;est connecté sur &#039;myapp&#039;...
... décision du serveur pour exécuter &#039;SELECT * FROM table_on_slave_a_only&#039;
... accès à la table disponible uniquement sur l&#039;esclave A détectée
... ret = &#039;tcp://192.168.2.27:3306&#039;
</pre></div>
         </div>
        </div>
       </p>
      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user-multi">
       Filtre : <code class="parameter">user_multi</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Le filtre <code class="literal">user_multi</code> diffère du filtre
        <code class="literal">user</code> sur un seul aspect. Sinon, leur syntaxe est
        identique. Le filtre <code class="literal">user</code> doit prendre et retourner
        exactement un noeud pour une exécution de requête. Un filtre
        chaîné se termine habituellement avec un filtre qui émet seulement un
        noeud. Le filtre chaîné doit réduire la liste des candidats pour exécution
        de la requête à un seul résultat. Ainsi, un seul noeud reste après l&#039;exécution
        du filtre <code class="literal">user</code>.
       </p>
       <p class="para">
        Le filtre <code class="literal">user_multi</code> est un filtre multiple.
        Il retourne une liste de serveurs esclaves et maîtres. Cette liste
        doit ensuite être filtrée pour identifier exactement un noeud pour
        l&#039;exécution de la requête. Un filtre multiple est habituellement
        placé au haut de la chaîne de filtrage. Le filtre <code class="literal">quality_of_service</code>
        est un autre exemple d&#039;un filtre multiple.
       </p>
       <p class="para">
        La valeur retournée par un fonction de rappel pour le filtre
        <code class="literal">user_multi</code> doit être un tableau contenant 2 éléments. Le
        premier élément contient une liste de serveurs maîtres sélectionnés.
        Le second élément contient une liste de serveurs maîtres sélectionnés.
        Ces listes doivent contenir les clés des serveurs esclaves et maîtres telles
        que trouvées dans les listes d&#039;esclave et de maître passées à la fonction
        de rappel. L&#039;exemple ci-dessous retourne des listes aléatoires de serveurs
        maîtres et esclaves extraites depuis les fonctions d&#039;entrée.
       </p>
       <p class="para">
        <div class="example" id="example-2234">
         <p><strong>Exemple #22 Retourne des esclaves et des maîtres aléatoirement</strong></p>
         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$masters&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$slaves&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;array(</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

        </div>
       </p>
       <p class="para">
        Le plugin émettra une erreur de type <code class="literal">E_RECOVERABLE</code> si
        la fonction de rappel échoue à retourner une liste de serveurs.
        L&#039;erreur contiendra ceci : <code class="literal">(mysqlnd_ms) User multi
        filter callback has not returned a list of servers to use.
        The callback must return an array in %s on line %d</code>.
        Dans le cas où la liste de serveurs n&#039;est pas vide mais contient
        des identifiants/clés de serveurs invalides, une erreur de type
        <code class="literal">E_RECOVERABLE</code> sera émise avec un message d&#039;erreur
        du type : <code class="literal">(mysqlnd_ms) User multi filter callback
        has returned an invalid list of servers to use.
        Server id is negative in %s on line %d</code>, ou similaire.
       </p>
       <p class="para">
        Une erreur est émise concernant une liste d&#039;esclave ou de maître vide
        suivant la configuration. Si une liste de maître vide est retournée
        pour une opération en écriture, le plugin émettra une alerte dont le
        message sera : <code class="literal">(mysqlnd_ms) Couldn&#039;t find the appropriate
        master connection. 0 masters to choose from. Something is wrong in %s on line %d</code>.
        Typiquement, cette alerte sera suivit d&#039;une erreur de type <code class="literal">E_ERROR</code>.
        Dans le cas d&#039;une opération en lecture et une liste d&#039;esclave vide, le comportement
        dépendra de la configuration du fail over. Si le fail over du maître
        est désactivé, le plugin émettra une alerte dont le message sera
        <code class="literal">(mysqlnd_ms) Couldn&#039;t find the appropriate slave connection.
         0 slaves to choose from. Something is wrong in %s on line %d</code>.
       </p>
      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-node-groups">
       Filtre : <code class="parameter">node_groups</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Le filtre <code class="literal">node_groups</code> vous permet de grouper
        les noeuds de cluster et requêter les groupes sélectionnés, par exemple,
        pour supporter le partitionnement de données. Le partitionnement de données
        peut être requis pour la fragmentation manuelle, la copie primaire basée
        sur les clusters fonctionnant avec plusieurs maîtres, ou pour éviter les
        points chauds lors des mises à jour sur les clusters dépourvus en interne
        de partitionnement. Le filtre est un filtre multiple qui retourne zéro, un
        ou plusieurs serveurs. Ainsi, il doit être suivi d&#039;autres filtres pour réduire
        le nombre de candidats à un seul, pour l&#039;exécution de la requête.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">user defined node group name</code>
           </td>
           <td>
            <p class="para">
             Un ou plusieurs groupes de noeuds doivent être définis.
             Un groupe de noeuds peut avoir un nom arbitraire, défini par
             l&#039;utilisateur. Le nom est utilisé en combinaison d&#039;une astuce SQL
             pour restreindre l&#039;exécution de la requête aux noeuds listés
             par le groupe de noeuds. Pour exécuter une requête sur un des serveurs
             d&#039;un groupe de noeuds, la requête doit commencer avec l&#039;astuce SQL
             <code class="literal">/*user defined node group name*/</code>.
             Veuillez noter qu&#039;aucun espace n&#039;est autorisé autour de
             <code class="literal">user defined node group name</code>. En raison du fait que
             <code class="literal">user defined node group name</code> est utilisé tel que comme
             partie d&#039;une astuce SQL, vous devez choisir le nom valide avec le langage SQL.
            </p>
            <p class="para">
             Chaque entré du groupe de noeuds doit contenir une liste de serveurs
             <code class="literal">master</code>. Les serveurs <code class="literal">slave</code> sont également
             autorisés. Le fait de ne pas fournir de liste de <code class="literal">master</code> pour
             un groupe de noeuds <code class="literal">name_of_group</code> va émettre une erreur de type
             <strong><code>E_RECOVERABLE_ERROR</code></strong> comme celle-ci
             <code class="literal">(mysqlnd_ms) No masters configured in node group &#039;name_of_group&#039; for &#039;node_groups&#039; filter</code>.
            </p>
            <p class="para">
             La liste des serveurs maîtres et esclaves doit correspondre, respectivement,
             aux entrées de la liste des serveurs
             <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.master" class="link">global master</a>
             et de <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.slave" class="link">slave</a>.
             Le fait de référencer un serveur inconnu d&#039;une de ces listes va émettre une
             erreur de type <strong><code>E_RECOVERABLE_ERROR</code></strong> comme celle-ci
             <code class="literal">(mysqlnd_ms) Unknown master &#039;server_alias_name&#039; (section &#039;name_of_group&#039;) in &#039;node_groups&#039; filter configuration</code>.
            </p>
            <p class="para">
             <div class="example" id="example-2235">
              <p><strong>Exemple #23 Partitionnement manuel</strong></p>
              <div class="example-contents">
<div class="inicode"><pre class="inicode">{
  &quot;myapp&quot;: {
       &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.28&quot;,
                &quot;port&quot;: 3306
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;127.0.0.1&quot;,
                &quot;port&quot;: 3311
            }
        },
        &quot;filters&quot;: {
            &quot;node_groups&quot;: {
                &quot;Partition_A&quot; : {
                    &quot;master&quot;: [&quot;master_0&quot;],
                    &quot;slave&quot;: [&quot;slave_0&quot;]
                }
            },
           &quot;roundrobin&quot;: []
        }
    }
}</pre>
</div>
              </div>

             </div>
            </p>
            <p class="para">
             Veuillez noter que si un filtre chaîné génère une liste d&#039;esclave
             vide, et que la directive de configuration PHP
             <code class="literal">mysqlnd_ms.multi_master=0</code> est utilisé,
             le plugin peut émettre une alerte.
            </p>
           </td>
           <td>Depuis 1.5.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-qos">
       Filtre : <code class="parameter">quality_of_service</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Le filtre <code class="literal">quality_of_service</code> identifie les noeuds du cluster
        capable de délivrer une certaine qualité de service. C&#039;est un filtre multiple
        qui retourne zéro, un ou plusieurs serveurs d&#039;entrées. Aussi,  Il doit être
        suivi par d&#039;autres filtres pour réduire le nombre de candidats à un seul pour
        l&#039;exécution de la requête.
       </p>
       <p class="para">
        Le filtre <code class="literal">quality_of_service</code> a été introduit en version
        1.2.0-alpha. Dans les séries 1.2, le but de ces filtres était sur l&#039;aspect
        de la qualité du service. Différents types de clusters offrent des
        consistences de données par défaut différentes. Par exemple, un serveur esclave
        de réplication MySQL asynchrones offre éventuellement une consistence.
        L&#039;esclave ne devrait pas être capable de délivrer les données demandées
        car il n&#039;a pas répliqué l&#039;écriture, il peut délivrer une base de données non à jour
        en raison des lags, ou bien des données à jour. Souvent, c&#039;est acceptable.
        Dans quelques cas, des niveaux de consistence élevés sont nécessaire pour
        que l&#039;application fonctionne correctement. Dans ces cas là, le filtre
        <code class="literal">quality_of_service</code> peut filtrer les noeuds du cluster
        ne pouvant pas délivrer la qualité de service nécessaire.
       </p>
       <p class="para">
        Le filtre <code class="literal">quality_of_service</code> peut être remplacé ou créé
        au moment de l&#039;exécution. Un appel réussi à la fonction
        <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> supprime toutes les entrées pour le filtre
        <code class="literal">qos</code> depuis la liste des filtres, et en installe un nouveau
        au tout début. Toutes les configurations peuvant être effectuées via la fonction
        <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> peuvent aussi être faîtes au
        niveau du fichier de configuration. Cependant, l&#039;utilisation de la fonction
        est générallement privilégiée dans ce cas. Au lieu de configurer la consistence
        de la session ainsi que les niveaux hauts de consistence du service dans le fichier
        de configuration du plugin, il est recommandé de définir uniquement des maîtres,
        et aucun esclave. Les niveaux du service forceront l&#039;utilisation des maîtres uniquement.
        L&#039;utilisation d&#039;une liste d&#039;esclave vide allège le fichier de configuration et ainsi,
        en améliore la lisibilité. Le seul niveau de service pour lequel il convient
        d&#039;utiliser le fichier de configuration est la combinaison d&#039;une consistence éventuelle
        et d&#039;un maximum d&#039;esclaves.
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">eventual_consistency</code>
           </td>
           <td>
            <p class="para">
             Demande une consistence éventuelle. Autorise l&#039;utilisation de tous
             les serveurs maîtres et de tous les serveurs esclaves. Les données
             retournées peuvent (ou pas) être des données à jour.
            </p>
            <p class="para">
             La consistence éventuelle accepte un paramètre optionnel
             <code class="literal">age</code>. Si le paramètre <code class="literal">age</code>
             est fourni, le plugin considère seulement les esclaves pour la lecture
             pour lesquels la réplication MySQL rapporte d&#039;un lag serveur inférieur
             ou égal à la valeur du paramètre <code class="literal">age</code>.
             Le lag de réplication est mesuré en utilisant
             <code class="literal">SHOW SLAVE STATUS</code>.
             Si le plugin échoue dans la récupération du lag de réplication, l&#039;esclave
             testé sera ignoré. Des détails ainsi que des astuces de l&#039;implémentation
             sont fournis dans la <a href="mysqlnd-ms.qos-consistency.html" class="link">section
             sur la qualité de service</a>.
            </p>
            <p class="para">
             Veuillez noter que si une chaîne de filtres génère une liste vide
             d&#039;esclave, et que la directive de configuration PHP
             <code class="literal">mysqlnd_ms.multi_master=0</code> est utilisée, le plugin
             peut émettre une alerte.
            </p>
            <p class="para">
             <div class="example" id="example-2236">
              <p><strong>Exemple #24 Limitation globale du lag d&#039;un esclave</strong></p>
              <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;quality_of_service&quot;: {
                &quot;eventual_consistency&quot;: {
                    &quot;age&quot;:123
                }
            }
        }
    }
}</pre>
</div>
              </div>

             </div>
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">session_consistency</code>
           </td>
           <td>
            <p class="para">
             Demande une consistence de session (lecture de vos écritures).
             Autorise l&#039;utilisation de tous les maîtres
             et de tous les esclaves qui sont synchronisés avec le maître.
             Si aucun paramètre supplémentaire n&#039;est fourni, les esclaves
             filtrés seront ceux pour lesquels il n&#039;a pas été possible
             de tester leur consistence ou bien parce qu&#039;ils lagguent.
             Notez que si un chaîne de filtres génère une liste d&#039;esclave
             vide, et que la directive de configuration PHP
             <code class="literal">mysqlnd_ms.multi_master=0</code> est utilisé,
             le plugin peut émettre une alerte.
            </p>
            <p class="para">
             Les demandes temporaires de consistence de session utilisant la fonction
             <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> est une alternative à l&#039;utilisation
             de <code class="literal">master_on_write</code>. <code class="literal">master_on_write</code>
             est plutôt utilisé pour envoyer plus de requêtes au maître que nécessaires.
             L&#039;application devrait être capable de continuer l&#039;opération à un niveau
             de consistence moindre après avoir subit des lectures critiques.
            </p>
           </td>
           <td>Depuis 1.1.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">strong_consistency</code>
           </td>
           <td>
            <p class="para">
             Demande une consistence forte. Seuls les maîtres seront utilisés.
            </p>
           </td>
           <td>Depuis 1.2.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.failover">
       <code class="parameter">failover</code>
       A partir de 1.3.x : <span class="type"><a href="language.types.string.html" class="type string">string</a></span>.
       Depuis 1.4.0 : <span class="type"><a href="language.types.object.html" class="type object">object</a></span>.
      </dt>

      <dd>

       <p class="para">
        Politique de basculement. Politiques supportées :
        <code class="literal">disabled</code> (défaut), <code class="literal">master</code>,
        <code class="literal">loop_before_master</code> (depuis 1.4.0).
       </p>
       <p class="para">
        Si aucune politique de basculement n&#039;est définie, le plugin
        ne procèdera à aucun basculement automatique
        (<code class="literal">failover=disabled</code>). À chaque fois que le
        plugin échoue lors de la connexion à un serveur, il émettra
        une alerte et définira le code et le message d&#039;erreur sur la
        connexion. Par la suite, c&#039;est à l&#039;application de gérer l&#039;erreur
        et, par exemple, relancera la dernière requête afin de
        déclencher la sélection d&#039;un autre serveur.
       </p>
       <p class="para">
        A noter : la logique de basculement automatique est appliqué seulement
        lors de l&#039;ouverture des connexions. Une fois la connexion ouverte, aucune
        tentative automatique n&#039;est effectuée pour la ré-ouvrir lorsqu&#039;une erreur
        survient. Si, par exemple, la connexion vers le serveur est fermée, et
        que l&#039;utilisateur tente d&#039;y exécuter une requête, aucun basculement
        automatique ne sera tenté. En lieu et place, une erreur sera rapportée.
       </p>
       <p class="para">
        Lors de l&#039;utilisation de <code class="literal">failover=master</code>,
        le plugin basculera implicitement vers un maître, si disponible.
        Reportez-vous à la documentation de ce concept pour en apprendre
        plus sur les risques de l&#039;utilisation de <code class="literal">failover=master</code>.
       </p>
       <p class="para">
        <div class="example" id="example-2237">
         <p><strong>Exemple #25 Basculement optionnel vers un maître lors d&#039;un échec de connexion sur un esclave  (PECL/mysqlnd_ms &lt; 1.4.0)</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;failover&quot;: &quot;master&quot;
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Depuis PECL/mysqlnd_ms 1.4.0, le mot clé de configuration du basculement
        se réfère à un objet.
       </p>
       <p class="para">
        <div class="example" id="example-2238">
         <p><strong>Exemple #26 Nouvelle syntaxe depuis 1.4.0</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;failover&quot;: {&quot;strategy&quot;: &quot;master&quot; }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Mot clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">strategy</code>
           </td>
           <td>
            <p class="para">
             Politique de basculement. Les valeurs possibles sont :
             <code class="literal">disabled</code> (par défaut), <code class="literal">master</code>,
             <code class="literal">loop_before_master</code>
            </p>
            <p class="para">
             Une valeur à <code class="literal">disabled</code> désactivera le basculement
             automatique.
            </p>
            <p class="para">
             Le fait de définir le <code class="literal">master</code> indique au plugin
             de tenter une connexion vers ce maître lors d&#039;une erreur de connexion
             vers l&#039;esclave. Si la connexion au maître échoue, le plugin sortira
             de la boucle de basculement et une erreur sera retournée à
             l&#039;utilisateur.
            </p>
            <p class="para">
             Lors de l&#039;utilisation de <code class="literal">loop_before_master</code> et 
             qu&#039;une requête esclave est faîte, le plugin tentera une connexion
             aux autres esclabes avant de basculer vers le maître. Si plusieurs
             maîtres sont fournis, et que la gestion des multi-maîtres
             est activée, le plugin parcourra la liste des maîtres et tentera
             de s&#039;y connecter avant de retourner une erreur à l&#039;utilisateur.
            </p>
           </td>
           <td>Depuis 1.4.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">remember_failed</code>
           </td>
           <td>
            <p class="para">
             Se souvenir des échecs pendant la durée d&#039;une requête web.
             Par défaut, vaut <code class="literal">false</code>.
            </p>
            <p class="para">
             Si défini à <code class="literal">true</code>, le plugin va se souvenir des
             hôtes ayant échoués, et les écartera dans toutes les balances
             de charge réalisées pendant la durée de la requête web courante.
            </p>
           </td>
           <td>
            Depuis 1.4.0. Cette fonctionalité n&#039;est disponible qu&#039;avec les filtres
            <code class="literal">random</code> et <code class="literal">roundrobin</code> de balance de charge.
            L&#039;utilisation de cette fonctionalité est recommandée.
           </td>
          </tr>

          <tr>
           <td>
            <code class="literal">max_retries</code>
           </td>
           <td>
            <p class="para">
             Nombre maximal de tentative de reconnexion avant d&#039;écarter un hôte.
             Défaut : <code class="literal">0</code> (aucune limite).
            </p>
            <p class="para">
             Cette configuration est utilisée pour éviter qu&#039;un hôte
             soit écarté de la liste des hôtes dès le premier échec.
             Si défini à <code class="literal">n &gt; 0</code>, le pluginva conserver
             le noeud dans la liste des noeuds y compris après une tentative
             de connexion échouée. Le noeud ne sera pas supprimé immédiatement
             de la liste des esclaves et de la liste des maîtres après
             le premier échec de connexion, mais <code class="literal">n</code> tentatives
             suivantes seront réalisées dans les futures balances de charge
             avant d&#039;être réellement écarté.
            </p>
           </td>
           <td>
            Depuis 1.4.0. Cette fonctionalité n&#039;est disponible qu&#039;avec les filtres
            <code class="literal">random</code> et <code class="literal">roundrobin</code> de balance de charge.
           </td>
          </tr>

         </tbody>
        
       </table>

       <p class="para">
        Le fait de définir <code class="literal">failover</code> à une valeur
        autre que <code class="literal">disabled</code>, <code class="literal">master</code>
        ou <code class="literal">loop_before_master</code> n&#039;émettra aucune alerte ni erreur.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.lazy-connections">
       <code class="parameter">lazy_connections</code>
       <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
      </dt>

      <dd>

       <p class="para">
        Contrôle l&#039;utilisation des connexions paresseuses. Les connexions
        paresseuses sont des connexions qui ne sont pas ouvertes tant que le client
        n&#039;envoie pas la première connexion. Les connexions paresseuses sont activées
        par défaut.
       </p>
       <p class="para">
        Il est vivement recommandé d&#039;utiliser les connexions paresseuses. Elles vous
        aident à conserver un nombre très faible de connexions ouvertes.
        Si vous les désactivez, et, par exemple, vous configurez un serveur MySQL
        maître de réplication et 2 serveurs MySQL esclaves de réplication,
        le plugin ouvrira trois connexions lors du premier appel à la fonction
        de connexion, malgré le fait que l&#039;application n&#039;utilise que la connexion
        maître.
       </p>
       <p class="para">
        Les connexions paresseuses représentent un risque si vous réalisez des actions
        qui changent le statut d&#039;une connexion. Le plugin ne répercutera pas toutes
        les actions de modification du statut à toutes les connexions de la pile
        de connexions. Les actions répercutées seront appliquées seulement à toutes
        les connexions ouvertes. Les connexions paresseuses ouvertes dans le futur
        ne seront pas affectées. Seules quelques configurations seront
        &quot;retenues&quot; et appliquées lorsqu&#039;une connexion paresseuse
        sera ouverte.
       </p>
       <p class="para">
        <div class="example" id="example-2239">
         <p><strong>Exemple #27 Désactivation des connexions paresseuses</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;lazy_connections&quot;: 0
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Voir aussi <code class="literal">server_charset</code> afin de prévenir
        de possibles problèmes avec les chaînes échappées et des
        serveurs utilisant des jeux de caractères différents.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.server-charset">
       <code class="parameter">server_charset</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        Ce paramètre a été introduit en 1.4.0. Il est recommandé de le définir
        lors de l&#039;utilisation des connexions paresseuses.
       </p>
       <p class="para">
        L&#039;option <code class="literal">server_charset</code> a deux buts. Il agit comme
        un jeu de caractères de secours à utiliser lors de l&#039;échappement des chaînes
        avant qu&#039;une connexion ne soit établie, et il aide à éviter les erreurs
        lors de l&#039;échappement en environnements hétérogènes avec des serveurs
        utilisant des jeux de caractères différents.
       </p>
       <p class="para">
        L&#039;échappement des chaînes prend en compte le jeu de caractères de la connexion.
        L&#039;échappement des chaînes n&#039;est pas possible avant qu&#039;une connexion ne
        soit ouverte, et que le jeu de caractères de la connexion ne soit connu.
        L&#039;utilisation des connexions paresseuses retarde l&#039;ouverture de la connexion,
        attendant qu&#039;une requête ne soit envoyée.
       </p>
       <p class="para">
        Une application utilisant les connexions paresseuses peut tenter d&#039;échapper
        une chaîne avant d&#039;envoyer une requête. En fait, c&#039;est un cas commun
        sachant que la chaîne de requête peut contenir la chaîne à échapper.
        Cependant, en raison de l&#039;utilisation des connexions paresseuses, aucune
        connexion n&#039;a été ouverte et l&#039;échappement échoue. Le plugin peut rapporter
        une erreur de type <code class="literal">E_WARNING</code> ainsi qu&#039;un message
        de ce type : <code class="literal">(mysqlnd_ms) string escaping doesn&#039;t work without established connection.
        Possible solution is to add server_charset to your configuration</code>
        afin de vous informer de cet échec.
       </p>
       <p class="para">
        Le fait de définir <code class="literal">server_charset</code> fera que le plugin
        utilisera le jeu de caractères fourni lors de l&#039;échappement des chaînes
        effectué sur des connexions paresseuses avant d&#039;établir une connexion réseau
        vers MySQL. De plus, le plugin va forcer l&#039;utilisation de ce jeu de caractères
        lorsque la connexion est établie.
       </p>
       <p class="para">
        Le forcage de l&#039;utilisation du jeu de caractères configuré pour l&#039;échappement
        est réalisé pour éviter d&#039;avoir des erreurs en utilisant un jeu de caractères
        pour l&#039;échappement différent de celui utilisé ensuite pour la connexion.
        Cela apporte également l&#039;avantage de ne pas avoir à aligner la configuration
        du jeu de caractères pour tous les serveurs utilisés. Inutile de savoir le jeu
        de caractères par défaut des serveurs, le plugin définiera celui configuré
        par défaut.
       </p>
       <p class="para">
        Le plugin n&#039;empêchera pas l&#039;utilisateur de changer le jeu de caractères
        à tout moment, en utilisant la fonction <span class="function"><strong>set_charset()</strong></span>
        ou une requête SQL équivalente. Veuillez noter que l&#039;utilisation de SQL n&#039;est
        pas recommandé car il ne pourra pas être surveiller par le plugin.
        L&#039;utilisateur peut, par exemple, modifier le jeu de caractères sur un
        gestionnaire de connexions paresseuses après l&#039;échappement d&#039;une chaîne et
        avant que la connexion actuelle ne soit ouverte. Le jeu de caractères définit
        par l&#039;utilisateur sera utilisé pour tous les échappements avant que la
        connexion ne soit établie. La connexion sera établie en utilisant le jeu
        de caractères configuré, peu importe le jeu de caractères du serveur, et
        peu importe le jeu de caractères défini par l&#039;utilisateur auparavant. Une
        fois une connexion ouverte, <code class="literal">set_charset</code> n&#039;a plus de sens.
       </p>
       <p class="para">
        <div class="example" id="example-2240">
         <p><strong>Exemple #28 Echappement d&#039;une chaîne sur une connexion paresseuse</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;lazy_connections&quot;: 1,
        &quot;server_charset&quot; : &quot;utf8&quot;
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape</span><span style="color: #007700">(</span><span style="color: #DD0000">"this&nbsp;will&nbsp;be&nbsp;escaped&nbsp;using&nbsp;the&nbsp;server_charset&nbsp;setting&nbsp;-&nbsp;utf8"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape</span><span style="color: #007700">(</span><span style="color: #DD0000">"this&nbsp;will&nbsp;be&nbsp;escaped&nbsp;using&nbsp;latin1"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;server_charset&nbsp;définit&nbsp;implicitement&nbsp;une&nbsp;connexion&nbsp;utf8&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'This&nbsp;connection&nbsp;will&nbsp;be&nbsp;set&nbsp;to&nbsp;server_charset&nbsp;upon&nbsp;establishing'&nbsp;AS&nbsp;_msg&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;latin1&nbsp;sera&nbsp;maintenant&nbsp;utilisé&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

        </div>
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.master-on-write">
       <code class="parameter">master_on_write</code>
       <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
      </dt>

      <dd>

       <p class="para">
        Si définit, le plugin utilisera le serveur maître uniquement
        après que la première requête ait été exécutée sur le maître.
        Les applications peuvent toujours envoyer les requêtes aux esclaves
        en utilisant les astuces SQL pour écraser la décision automatique.
       </p>
       <p class="para">
        Cette configuration permet de corriger le lag dans la réplication.
        Si une application exécute une requête <code class="literal">INSERT</code>,
        le plugin utilisera, par défaut, le maître pour exécuter les requêtes suivantes,
        y compris les requêtes <code class="literal">SELECT</code>.
        Ceci permet d&#039;éviter les problèmes de lecture depuis les esclaves
        qui n&#039;ont pas encore répliqués les requêtes
        <code class="literal">INSERT</code>.
       </p>
       <p class="para">
        <div class="example" id="example-2241">
         <p><strong>Exemple #29 Utilisation du maître lors d&#039;une écriture pour consolider les lectures</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;master_on_write&quot;: 1
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Veuillez noter que le filtre <code class="literal">quality_of_service</code>
        a été introduit en version 1.2.0-alpha. Il fournit un contrôle plus
        fin, par exemple, pour effectuer une lecture de vos écritures, et,
        il offre des fonctionnalités supplémentaires en introduisant les
        <a href="mysqlnd-ms.qos-consistency.html" class="link">niveaux de service</a>.
       </p>
       <p class="para">
        Toutes les configurations de
        <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.trx-stickiness" class="link">transaction rigide</a>,
        incluant <code class="literal">trx_stickiness=on</code>, seront écrasées par
        <code class="literal">master_on_write=1</code>.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">
       <code class="parameter">trx_stickiness</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        Politique des transactions colantes. Les politiques supportées
        sont <code class="literal">disabled</code> (défaut), <code class="literal">master</code>.
       </p>
       <p class="para">
        Cette configuration nécessite PHP 5.4.0 ou supérieure. Si utilisée sur
        des versions de PHP plus anciennes, le plugin émettra une alerte de type
        <code class="literal">(mysqlnd_ms) trx_stickiness strategy is not supported before PHP 5.3.99</code>.
       </p>
       <p class="para">
        Si aucune politique de transaction colante n&#039;est défini, ou bien si la
        configuration <code class="literal">trx_stickiness=disabled</code> est utilisée,
        le plugin ne tiendra pas compte des transactions. Ainsi, le plugin
        peut effectuer un balance de charge des connexions, et changer de connexions
        en plein milieu d&#039;une transaction. Le plugin n&#039;est ainsi pas sécurisé sur
        les transactions. Les astuces SQL peuvent être utilisées pour empécher les
        changements de connexions durant une transaction.
       </p>
       <p class="para">
        Depuis PHP 5.4.0, la bibliothèque mysqlnd autorise le plugin à surveiller
        la définition du mode <code class="literal">autocommit</code> par appel à la fonction
        <code class="literal">set_autocommit()</code> de la bibliothèque.
        Si <code class="literal">set_stickiness=master</code> et
        <code class="literal">autocommit</code> a été désactivé par une extension PHP MySQL
        en invoquant la fonction <code class="literal">set_autocommit()</code> de la bibliothèque
        interne <code class="literal">mysqlnd</code>, le plugin tiendra compte d&#039;un début de transaction.
        Ainsi, le plugin arrêtera les balances de charge et dirigera toutes les requêtes
        vers le maître tant que <code class="literal">autocommit</code> est actif.
        Dans ce cas, aucune astuce SQL n&#039;est nécessaire.
       </p>
       <p class="para">
        Un exemple de fonction de l&#039;API PHP MySQL appelant la fonction interne
        <code class="literal">set_autocommit()</code> de la bibliothèque <code class="literal">mysqlnd</code>
        est la fonction <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span>.
       </p>
       <p class="para">
        Malgré la configuration <code class="literal">trx_stickiness=master</code>, le plugin
        ne tiendra pas compte d&#039;une modification du mode <code class="literal">autocommit</code>
        réalisée par une requête SQL comme <code class="literal">SET AUTOCOMMIT=0</code> ou
        <code class="literal">BEGIN</code>.
       </p>
       <p class="para">
        Depuis PHP 5.5.0, de nouvelles fonctionalités de la bibliothèque mysqlnd permettent
        de contrôler les transactions. Le niveau de contrôle correspond à celui fourni
        par la requête SQL. L&#039;API <code class="literal">mysqli</code> a été modifiée pour utiliser
        ces appels. Depuis la version 1.5.0, PECL/mysqlnd_ms peut surveiller non seulement
        <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span> mais aussi <span class="function"><strong>mysqli_begin()</strong></span>,
        <span class="function"><a href="mysqli.commit.html" class="function">mysqli_commit()</a></span> et <span class="function"><a href="mysqli.rollback.html" class="function">mysqli_rollback()</a></span> pour
        détecter les limites de la transaction et arrêter la balance de charge
        durant une transaction.
       </p>
       <p class="para">
        <div class="example" id="example-2242">
         <p><strong>Exemple #30 Utilisation du maître pour l&#039;exécution des transactions</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;trx_stickiness&quot;: &quot;master&quot;
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <p class="para">
        Depuis la version 1.5.0, le failover automatique ou silencieux est
        désactivé pour la durée d&#039;une transaction. Si les limites d&#039;une
        transaction ont été détectées proprement, la rigidité de la transaction
        est activé et un serveur échoue, alors le plugin ne va pas tenter
        d&#039;utiliser le prochain serveur, s&#039;il existe, suivant la politique
        de failover configurée. L&#039;utilisation doit gérer cette erreur manuellement.
        Suivant la configuration, le plugin peut émettre une erreur de type
        <code class="literal">E_WARNING</code> comme celle-ci
        <code class="literal">(mysqlnd_ms) Automatic failover is not permitted in the middle of a transaction</code>.
        Cette erreur peut ensuite être écrasée par un suivi des erreurs comme
        <code class="literal">(mysqlnd_ms) No connection selected by the last filter</code>.
        Ces erreurs seront générées par la fonction exécutant la requête qui a échouée.
       </p>
       <p class="para">
        <div class="example" id="example-2243">
         <p><strong>Exemple #31 Aucun failover automatique, utilisation d&#039;un gestionnaire d&#039;erreurs</strong></p>
         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;On&nbsp;suppose&nbsp;que&nbsp;le&nbsp;failover&nbsp;automatique&nbsp;est&nbsp;configuré&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Défini&nbsp;le&nbsp;statut&nbsp;interne&nbsp;du&nbsp;plugin&nbsp;à&nbsp;in_trx&nbsp;=&nbsp;1&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;On&nbsp;suppose&nbsp;que&nbsp;le&nbsp;serveur&nbsp;échoue&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'Assume&nbsp;this&nbsp;query&nbsp;fails'&nbsp;AS&nbsp;_msg&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;Gestion&nbsp;de&nbsp;l'échec&nbsp;de&nbsp;la&nbsp;transaction,&nbsp;le&nbsp;statut&nbsp;interne&nbsp;du&nbsp;plugin&nbsp;est&nbsp;toujours&nbsp;in_trx&nbsp;=&nbsp;1&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #FF8000">/*<br />&nbsp;&nbsp;Si&nbsp;vous&nbsp;utilisez&nbsp;l'autocommit()&nbsp;pour&nbsp;les&nbsp;transactions,&nbsp;il&nbsp;est&nbsp;préférable<br />&nbsp;&nbsp;de&nbsp;l'appeler&nbsp;comme&nbsp;ceci&nbsp;:&nbsp;autocommit(true).&nbsp;Sinon,&nbsp;le&nbsp;plugin&nbsp;pensera<br />&nbsp;&nbsp;que&nbsp;la&nbsp;transaction&nbsp;courante&nbsp;continue,&nbsp;et&nbsp;ainsi,&nbsp;toute&nbsp;modification<br />&nbsp;&nbsp;de&nbsp;connexion&nbsp;sera&nbsp;interdite.<br />&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;De&nbsp;plus,&nbsp;vous&nbsp;pouvez&nbsp;vouloir&nbsp;démarrer&nbsp;une&nbsp;nouvelle&nbsp;transaction&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">autocommit</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br />}<br /></span><span style="color: #FF8000">/*&nbsp;Maintenant,&nbsp;utilisation&nbsp;du&nbsp;latin1&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">set_charset</span><span style="color: #007700">(</span><span style="color: #DD0000">"latin1"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

        </div>
       </p>
       <p class="para">
        Si un serveur échoue au milieu d&#039;une transaction, le plugin continue
        à refuser le changement de connexions tant que la transaction courante
        n&#039;est pas terminée. Souvenez-vous que le plugin surveille les appels API
        pour détecter les limites de la transaction. Aussi, vous devez, par exemple,
        activer le mode autocommit pour finir la transaction courante
        avant que le plugin ne continue à faire du balance de charge et
        ainsi, ne change de serveur. De plus, vous voudriez vouloir démarrer
        une nouvelle transaction immédiatement après, et désactiver l&#039;autocommit.
       </p>
       <p class="para">
        Le fait de ne pas gérer les requêtes qui échouent, et de ne pas terminer
        une transaction en échec utilisant des appels API, peuvent causer des
        erreurs de ce type : <code class="literal">Commands out of sync; you can&#039;t run this command now</code>.
        Aussi, il est important de gérer toutes les erreurs.
       </p>
      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.transient_error">
       <code class="parameter">transient_error</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Cette option a été introduite en version 1.6.0.
       </p>
       <p class="para">
        Un noeud de cluster de bases de données peut émettre une erreur
        passagère au client. Le client peut alors répéter l&#039;opération sur le
        même noeud, peut changer de noeud, ou peut annuler l&#039;opération.
        Par définition, il est résonnable pour un client de re-tenter
        la même opération sur le même noeud avant de continuer.
       </p>
       <p class="para">
        <code class="literal">PECL/mysqlnd_ms</code> peut entrer dans une boucle de tentatives
        à la place de l&#039;application. En configuration l&#039;option
        <code class="literal">transient_error</code>, le plugin peut répéter l&#039;opération
        ayant échouée avec un code erreur spécifique pendant un certain nombre
        de fois, avec une pause entre chaque tentative. Si l&#039;erreur passagère
        disparaît pendant l&#039;exécution de la boucle, elle ne sera pas vue
        de l&#039;application. Sinon, l&#039;erreur sera transmise à l&#039;application à la
        fin de la boucle.
       </p>
       <p class="para">
        <div class="example" id="example-2244">
         <p><strong>Exemple #32 Boucle de tentative pour les erreurs passagères</strong></p>
         <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
       },
       &quot;transient_error&quot;: {
          &quot;mysql_error_codes&quot;: [
            1297
          ],
          &quot;max_retries&quot;: 2,
          &quot;usleep_retry&quot;: 100
       }
    }
}</pre>
</div>
         </div>

        </div>
       </p>
       <table class="doctable informaltable">
        
         <col width="1*" />
         <col width="7*" />
         <col width="2*" />
         <thead>
          <tr>
           <th>Clé</th>
           <th>Description</th>
           <th>Version</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>
            <code class="literal">mysql_error_codes</code>
           </td>
           <td>
            <p class="para">
             Liste des codes erreurs passagères. Vous pouvez y inclure
             n&#039;importe quel code erreur MySQL. Il est possible de considérer
             n&#039;importe quelle erreur comme passagère, et pas seulement
             l&#039;erreur <code class="literal">1297</code> (<code class="literal">HY000 (ER_GET_TEMPORARY_ERRMSG),
             Message: Got temporary error %d &#039;%s&#039; from %s</code>).
             Avant d&#039;ajouter d&#039;autres codes erreurs, autre que
             <code class="literal">1297</code>, à cette liste, assurez-vous que votre
             cluster supporte une nouvelle tentative sans impacter le statut
             de votre application.
            </p>
           </td>
           <td>Depuis 1.6.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">max_retries</code>
           </td>
           <td>
            <p class="para">
             Le nombre de tentatives d&#039;une opération échouant
             avec une erreur passagère avant d&#039;envoyer l&#039;erreur
             à l&#039;utilisateur.
            </p>
            <p class="para">
             Par défaut : <code class="literal">1</code>
            </p>
           </td>
           <td>Depuis 1.6.0.</td>
          </tr>

          <tr>
           <td>
            <code class="literal">usleep_retry</code>
           </td>
           <td>
            <p class="para">
             Durée en millisecondes d&#039;attente entre deux tentatives.
             La valeur est passée à la fonction C <span class="function"><a href="function.usleep.html" class="function">usleep()</a></span>.
            </p>
            <p class="para">
             Par défaut : <code class="literal">100</code>
            </p>
           </td>
           <td>Depuis 1.6.0.</td>
          </tr>

         </tbody>
        
       </table>

      </dd>

     
     
     
      <dt id="ini.mysqlnd-ms-plugin-config-v2.xa">
       <code class="parameter">xa</code>
       <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
      </dt>

      <dd>

       <p class="para">
        Cette option a été introduite en 1.6.0.
       </p>
       <p class="para">
        <blockquote class="note"><p><strong class="note">Note</strong>: 
         <strong>Expérimental</strong><br />
         <p class="para">
          Cette fonctionnalité est actuellement en cours de développement.
          Il peut y avoir des bogues ou des limitations dans la fonctionnalité.
          Ne pas utiliser en environnement de production.
         </p>
        </p></blockquote>
       </p>
       <dl>

        
         <dt>
state_store</dt>

         <dd>

          <dl>

           
            <dt>
record_participant_credentials</dt>

            <dd>

             <p class="para">
              Si l&#039;on doit stocker le nom d&#039;utilisateur et le mot de passe
              d&#039;un participant à une transaction globale dans la table
              des participants. Si désactivé, la collection des données incorrectes
              va utiliser le nom d&#039;utilisateur et le mot de passe par défaut lors
              de la connexion aux participants. Tant que vous n&#039;utilisez pas de
              nom d&#039;utilisateur et de mot de passe différents pour chaque serveur
              MySQL, vous pouvez utiliser la configuration par défaut, faisant
              ainsi que vous ne stockerez pas d&#039;informations sensibles dans le
              stockage de statut.
             </p>
             <p class="para">
              Veuillez noter que le nom d&#039;utilisateur et le mot de passe sont
              stockés en clear lors de l&#039;utilisation du stockage de statut MySQL,
              qui est le seul moyen de stockage actuellement. Il en est de votre
              responsabilité de protéger cette information sensible.
             </p>
             <p class="para">
              Par défaut : <code class="literal">false</code>
             </p>
            </dd>

           
           
            <dt>
participant_localhost_ip</dt>

            <dd>

             <p class="para">
              Durant la collection des données incorrectes XA, le plugin peut trouver
              un serveur participant avec l&#039;hôte <code class="literal">localhost</code> enregistré.
              Si la collection de données incorrectes prend place sur un autre hôte
              que celui enregistré pour le participant, alors le nom d&#039;hôte
              <code class="literal">localhost</code> doit résoudre un hôte différent. Toutefois,
              lors de l&#039;enregistrement de nom d&#039;hôte de serveur participant dans le
              stockage de statut, au lieu d&#039;utiliser la valeur <code class="literal">localhost</code>,
              vous pouvez utiliser l&#039;adresse IP actuelle de <code class="literal">localhost</code>.
             </p>
             <p class="para">
              La définition de <code class="literal">participant_localhost_ip</code> ne doit être
              considérée que si <code class="literal">localhost</code> ne peut être utilisé.
              D&#039;un point de vue de la collection des données incorrectes uniquement,
              il est préférable de ne pas configurer de socket de connexion mais plutôt
              de fournir un adresse IP et un port pour un noeud.
             </p>
            </dd>

           
           
            <dt>
mysql</dt>

            <dd>

             <p class="para">
              Le stockage de statut MySQL est le seul stockage de statut disponible.
             </p>
             <dl>

              
               <dt>
global_trx_table</dt>

               <dd>

                <p class="para">
                 Nom de la table MySQL utilisé pour stocker le statut d&#039;une transaction
                 globale entrant ou stoppée. Utilisez la requête SQL ci-dessous pour
                 créer la table. Assurez-vous d&#039;éditer le nom de la table pour la faire
                 correspondre à votre configuration.
                </p>
                <p class="para">
                 Par défaut : <code class="literal">mysqlnd_ms_xa_trx</code>
                </p>                                  
                <p class="para">
                 <div class="example" id="example-2245">
                  <p><strong>Exemple #33 Définition SQL pour la table de stockage MySQL de statut des transactions</strong></p>
                  <div class="example-contents">
<div class="sqlcode"><pre class="sqlcode">CREATE TABLE mysqlnd_ms_xa_trx (
  store_trx_id int(11) NOT NULL AUTO_INCREMENT,
  gtrid int(11) NOT NULL,
  format_id int(10) unsigned NOT NULL DEFAULT &#039;1&#039;,
  state enum(&#039;XA_NON_EXISTING&#039;,&#039;XA_ACTIVE&#039;,&#039;XA_IDLE&#039;,&#039;XA_PREPARED&#039;,&#039;XA_COMMIT&#039;,&#039;XA_ROLLBACK&#039;) NOT NULL DEFAULT &#039;XA_NON_EXISTING&#039;,
  intend enum(&#039;XA_NON_EXISTING&#039;,&#039;XA_ACTIVE&#039;,&#039;XA_IDLE&#039;,&#039;XA_PREPARED&#039;,&#039;XA_COMMIT&#039;,&#039;XA_ROLLBACK&#039;) DEFAULT &#039;XA_NON_EXISTING&#039;,
  finished enum(&#039;NO&#039;,&#039;SUCCESS&#039;,&#039;FAILURE&#039;) NOT NULL DEFAULT &#039;NO&#039;,
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  started datetime DEFAULT NULL,
  timeout datetime DEFAULT NULL,
  PRIMARY KEY (store_trx_id),
  KEY idx_xa_id (gtrid,format_id,finished),
  KEY idx_state (state)
) ENGINE=InnoDB</pre>
</div>
                  </div>

                 </div>
                </p>
               </dd>

              
              
               <dt>
participant_table</dt>

               <dd>

                <p class="para">
                 Nom de la table MySQL utilisé pour stocker les participants à une transaction
                 globale entrante ou stoppée. Utilisez la requête SQL ci-dessous pour créer la
                 table. Assurez-vous d&#039;éditer le nom de la table pour la faire correspondre
                 à votre configuration.
                </p>
                <p class="para">
                 Le stockage des informations de connexion peut être activé ou désactivé
                 en utilisant <code class="literal">record_participant_credentials</code>
                </p>
                <p class="para">
                 Par défaut : <code class="literal">mysqlnd_ms_xa_participants</code>
                </p>
                <div class="example" id="example-2246">
                 <p><strong>Exemple #34 Définition SQL de la table de stockage MySQL de statut des transactions</strong></p>
                 <div class="example-contents">
<div class="sqlcode"><pre class="sqlcode">CREATE TABLE mysqlnd_ms_xa_participants (
  fk_store_trx_id int(11) NOT NULL,
  bqual varbinary(64) NOT NULL DEFAULT &#039;&#039;,
  participant_id int(10) unsigned NOT NULL AUTO_INCREMENT,
  server_uuid varchar(127) DEFAULT NULL,
  scheme varchar(1024) NOT NULL,
  host varchar(127) DEFAULT NULL,
  port smallint(5) unsigned DEFAULT NULL,
  socket varchar(127) DEFAULT NULL,
  user varchar(127) DEFAULT NULL,
  password varchar(127) DEFAULT NULL,
  state enum(&#039;XA_NON_EXISTING&#039;,&#039;XA_ACTIVE&#039;,&#039;XA_IDLE&#039;,&#039;XA_PREPARED&#039;,&#039;XA_COMMIT&#039;,&#039;XA_ROLLBACK&#039;)
   NOT NULL DEFAULT &#039;XA_NON_EXISTING&#039;,
  health enum(&#039;OK&#039;,&#039;GC_DONE&#039;,&#039;CLIENT ERROR&#039;,&#039;SERVER ERROR&#039;) NOT NULL DEFAULT &#039;OK&#039;,
  connection_id int(10) unsigned DEFAULT NULL,
  client_errno smallint(5) unsigned DEFAULT NULL,
  client_error varchar(1024) DEFAULT NULL,
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (participant_id),
  KEY idx_xa_bqual (bqual),
  KEY idx_store_trx (fk_store_trx_id),
  CONSTRAINT mysqlnd_ms_xa_participants_ibfk_1 FOREIGN KEY (fk_store_trx_id)
    REFERENCES mysqlnd_ms_xa_trx (store_trx_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB</pre>
</div>
                 </div>

                </div>
               </dd>

              
              
               <dt>
garbage_collection_table</dt>

               <dd>

                <p class="para">
                 Nom de la table MySQL utilisé pour surveiller et synchroniser les exécutions
                 de la collection des données incorrectes. Utilisez la requête SQL ci-dessous
                 pour créer la table. Assurez-vous d&#039;éditer le nom de la table pour la faire
                 correspondre à votre configuration.
                </p>
                <p class="para">
                 Par défaut : <code class="literal">mysqlnd_ms_xa_gc</code>
                </p>
                <div class="example" id="example-2247">
                 <p><strong>Exemple #35 Définition SQL pour la table MySQL de stockage de statut de la collection des données incorrectes</strong></p>
                 <div class="example-contents">
<div class="sqlcode"><pre class="sqlcode">CREATE TABLE mysqlnd_ms_xa_gc (
  gc_id int(10) unsigned NOT NULL AUTO_INCREMENT,
  gtrid int(11) NOT NULL,
  format_id int(10) unsigned NOT NULL DEFAULT &#039;1&#039;,
  fk_store_trx_id int(11) DEFAULT NULL,
  modified timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  attempts smallint(5) unsigned NOT NULL DEFAULT &#039;0&#039;,
  PRIMARY KEY (gc_id),
  KEY idx_store_trx (gtrid,format_id,fk_store_trx_id)
) ENGINE=InnoDB</pre>
</div>
                 </div>

                </div>
               </dd>

              
              
               <dt>
host</dt>

               <dd>

                <p class="para">
                 Nom d&#039;hôte du serveur MySQL.
                </p>
               </dd>

              
              
               <dt>
user</dt>

               <dd>

                <p class="para">
                 Nom de l&#039;utilisateur à utiliser pour la connexion au serveur MySQL.
                </p>
               </dd>

              
              
               <dt>
password</dt>

               <dd>

                <p class="para">
                 Mot de passe à utiliser pour le serveur MySQL.
                </p>
               </dd>

              
              
               <dt>
db</dt>

               <dd>

                <p class="para">
                 Base de données qui contiendra les tables de collection des données
                 incorrectes. Notez que vous devez d&#039;abord créer les tables
                 avant d&#039;utiliser le plugin. Les tables ne seront pas
                 créées pendant l&#039;exécution et la collection des données incorrectes
                 va échouer si les tables n&#039;existent pas.
                </p>
               </dd>

              
              
               <dt>
port</dt>

               <dd>

                <p class="para">
                 Port du serveur MySQL.
                </p>
               </dd>

              
              
               <dt>
socket</dt>

               <dd>

                <p class="para">
                 Socket de domaine Unix pour le serveur MySQL.
                 Notez que si vous avez plusieurs serveurs PHP,
                 chacun d&#039;eux va tenter de s&#039;occuper de la collection
                 des données incorrectes, et doit pouvoir se connecter
                 au stockage de statut. Dans ce cas, vous devriez
                 configurer l&#039;adresse IP et le port pour le serveur
                 de stockage de statut MySQL pour vous assurer
                 que tous les serveurs PHP arrivent à le trouver.
                </p>
               </dd>

              
             </dl>

            </dd>

            
          </dl>

         </dd>

        
        
         <dt>
rollback_on_close</dt>

         <dd>

          <p class="para">
           Si l&#039;on doit automatiquement annuler une transaction globale ouverte
           lorsqu&#039;une connexion se ferme. Si actif, le comportement par défaut
           des transactions locales sera imité. Si un client se déconnecte,
           le serveur annulera toute transaction ouverte et non terminée.
          </p>
          <p class="para">
           Par défaut : <code class="literal">true</code>
          </p>
         </dd>

        
        
         <dt id="ini.mysqlnd-ms-plugin-config-v2.xa.gc">garbage_collection</dt>

         <dd>

          <dl>

           
            <dt>
max_retries</dt>

            <dd>

             <p class="para">
              Nombre maximal de collection de données incorrectes à tenter.
              Les valeurs autorisées vont de <code class="literal">0</code> à <code class="literal">100</code>.
              Une configuration à <code class="literal">0</code> signifie aucune limite,
              tant que le stockage de statut ne force une limite. Si le stockage
              de statut force une limite, on peut supposer que ce sera une valeur
              supérieure à <code class="literal">100</code>. Disponible depuis 1.6.0.
             </p>
             <p class="para">
              Veuillez noter qu&#039;il est très important de terminer les transactions
              XA en échec dans un délai raisonnable afin de permettre aux serveurs
              participants de libérer les ressources associées à la transaction.
              Le collecteur de données incorrectes embarqué n&#039;est pas prévu
              pour être en échec pendant une longue période, au moins tant que les
              serveurs en échec redeviennent disponibles. Aussi, il peut arriver
              dans quelques situations qu&#039;une action humaine soit nécessaire
              à cause du fait que le collecteur de données incorrectes soit stoppé
              ou en échec. Dans ce cas, vous devriez vouloir d&#039;abord vérifier si
              la transaction ne peut pas être réparée en forçant la fonction
              <span class="function"><a href="function.mysqlnd-ms-xa-gc.html" class="function">mysqlnd_ms_xa_gc()</a></span> à ignorer cette configuration,
              avant de gérer le problème manuellement.
             </p>
             <p class="para">
              Par défaut : <code class="literal">5</code>
             </p>
            </dd>

           
           
            <dt>
probability</dt>

            <dd>

             <p class="para">
              Probabiblité de la collecte des données incorrectes.
              Les valeurs autorisées sont dans l&#039;intervalle
              <code class="literal">0</code> à <code class="literal">1000</code>.
              Une valeur de <code class="literal">0</code> désactive la collecte des
              données incorrectes en arrière-plan. Malgré une valeur de
              <code class="literal">0</code>, il est toujours possible de lancer une
              collecte de données incorrectes en appelant la fonction
              <span class="function"><strong>mysqlnd_ms_gc()</strong></span>. Disponible depuis la
              version 1.6.0.
             </p>
             <p class="para">
              La collection automatique de données incorrectes d&#039;une transaction
              XA dans un statut incorrect est uniquement disponible si un stockage
              de statut a été configuré. Suivant ces enregistrements, il peut
              trouver des transactions XA bloquées où le client est en erreur,
              se connecter aux participants, et annuler les transactions non terminées.
             </p>
             <p class="para">
              La collecte des données incorrectes est lancée comme étant une partie
              d&#039;une demande de procédure d&#039;arrêt PHP à la fin d&#039;une requête web.
              Suivant le moment où on décide de lancer la collecte des données incorrectes,
              une valeur aléatoire entre <code class="literal">0</code> et <code class="literal">1000</code>
              est calculée. Si la valeur <code class="literal">probability</code> est supérieure
              ou égale à la valeur aléatoire, les routines du stockage de statut
              du collecteur de données incorrectes sont appelées..
             </p>
             <p class="para">
              Par défaut : <code class="literal">5</code>
             </p>
            </dd>

           
           
            <dt>
max_transactions_per_run</dt>

            <dd>

             <p class="para">
              Nombre maximal de transactions XA non terminées considérées
              par la collecte des données incorrectes pendant une exécution.
              Les valeurs autorisées doivent être dans l&#039;intervalle
              <code class="literal">1</code> à <code class="literal">32768</code>. Disponible depuis
              la version 1.6.0.
             </p>
             <p class="para">
              Le nettoyage d&#039;une transaction XA non terminée prend beaucoup de temps
              et de ressource. La routine de collecte des données incorrectes
              doit se connecter à plusieurs participants d&#039;une transaction globale
              en échec pour y émettre des commandes SQL pour annuler la transaction
              non terminée.
             </p>
             <p class="para">
              Par défaut : <code class="literal">100</code>
             </p>
            </dd>

           
          </dl>

         </dd>

        
       </dl>

      </dd>

     
    </dl>

   </p>
  </div>
  
  <div class="section" id="mysqlnd-ms.plugin-ini-v1">
   <h2 class="title">Fichier de configuration du plugin (&lt;= 1.0.x)</h2>
   <blockquote class="note"><p><strong class="note">Note</strong>: 
    <p class="para">
     La description suivante s&#039;applique à PECL/mysqlnd_ms &lt; 1.1.0-beta.
     Elle n&#039;est pas valide pour les versions supérieures.
    </p>
   </p></blockquote>
   <p class="para">
    Le plugin utilise son propre fichier de configuration. Ce fichier contient
    les informations sur les serveurs maîtres de réplication MySQL, les serveurs
    esclaves de réplication MySQL, la politique de sélection de serveur (balance de charge),
    la stratégie de basculement ainsi que l&#039;utilisation des connexions paresseuses.
   </p>
   <p class="para">
    La directive de configuration PHP
    <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.ini-file" class="link"><code class="literal">mysqlnd_ms.ini_file</code></a>
    est utilisée pou définir le fichier de configuration du plugin.
   </p>
   <p class="para">
    Le fichier de configuration reprend le standard du format <code class="literal">php.ini</code>.
    Il contient un ou plusieurs sections. Chaque section définit sa propre unité
    de configuration. Il n&#039;y a pas de section globale pour la configuration
    par défaut.
   </p>
   <p class="para">
    Les applications se réfèrent aux sections par leurs noms. Les applications
    utilisent les noms de section comme paramètre de l&#039;hôte (serveur) dans les
    différentes méthodes de connexion des extensions comme
    <a href="ref.mysqli.html" class="link">mysqli</a>,
    <a href="ref.mysql.html" class="link">mysql</a> et
    <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a>. Lors de la connexion,
    le plugin <a href="book.mysqlnd.html" class="link">mysqlnd</a> compare le nom
    de l&#039;hôte avec tous les noms de section depuis le fichier de configuration
    du plugin. Si le nom d&#039;hôte et le nom de section correspondent, le
    plugin chargera la configuration depuis cette section.
   </p>
   <p class="para">
    <div class="example" id="example-2248">
     <p><strong>Exemple #36 Exemple d&#039;utilisation des noms de section</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">[myapp]
master[] = localhost
slave[] = 192.168.2.27
slave[] = 192.168.2.28:3306
[localhost]
master[] = localhost:/tmp/mysql/mysql.sock
slave[] = 192.168.3.24:3305
slave[] = 192.168.3.65:3309</pre>
</div>
     </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Toutes&nbsp;les&nbsp;sections&nbsp;suivantes&nbsp;seront&nbsp;soumises&nbsp;à&nbsp;la&nbsp;balance&nbsp;de&nbsp;charge&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$pdo&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=myapp;dbname=database'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'username'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'password'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysql_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
   <p class="para">
    Les noms de section sont des chaînes de caractères. Il est valide d&#039;utiliser
    un nom de section comme
    <code class="literal">192.168.2.1</code>, <code class="literal">127.0.0.1</code> ou
    <code class="literal">localhost</code>. Si, par exemple, une application se
    connecte à <code class="literal">localhost</code> et une section de configuration
    du plugin <code class="literal">[localhost]</code> existe, la sémantique de l&#039;opération
    de connexion change. L&#039;application n&#039;utilisera plus seulement le serveur MySQL
    fonctionnant sur l&#039;hôte <code class="literal">localhost</code>, mais le plugin
    commencera à balancer la charge des requêtes MySQL en suivant les règles
    depuis la section de configuration <code class="literal">[localhost]</code>.
    De cette façon, vous pouvez effectuer un balance de charge depuis une
    application sans aucune modification du code source de l&#039;application.
   </p>
   <p class="para">
    Les directives de configuration <code class="literal">master[]</code>, <code class="literal">slave[]</code>
    et <code class="literal">pick[]</code> utilisent une syntaxe sous forme de liste.
    Ces directives peuvent apparaître à plusieurs reprises dans une section de configuration.
    Le plugin maintient l&#039;ordre dans laquelle les entrées apparaîssent au moment
    de leurs interprétations. Par exemple, l&#039;exemple ci-dessous montre
    les directives de configuration pour 2 <code class="literal">slave[]</code> dans la
    section de configuration <code class="literal">[myapp]</code>. Si vous utilisez la balance
    de charge round-robin pour les requêtes en lecture seule, le plugin enverra
    la premère requête en lecture seule au serveur MySQLL
    <code class="literal">mysql_slave_1</code> parce qu&#039;il est premier dans la liste.
    La seconde requête en lecture seule sera envoyée au serveur MySQL
    <code class="literal">mysql_slave_2</code> parce qu&#039;il est second sur la liste.
    Les directives de configuration supportant la syntaxe sous forme de liste
    sont ordonnées depuis le haut vers le bas, dans l&#039;ordre de leurs apparissions
    dans la section de configuration.
   </p>
   <p class="para">
    <div class="example" id="example-2249">
     <p><strong>Exemple #37 Syntaxe sous forme de liste</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">[myapp]
master[] = mysql_master_server
slave[] = mysql_slave_1
slave[] = mysql_slave_2</pre>
</div>
     </div>

    </div>
   </p>
   <p class="para">
    Voici une explication brève sur les directives de configuration pouvant être utilisées.
   </p>
   <p class="para">
    <dl>

     
      <dt id="ini.mysqlnd-ms-plugin-config.master">
       <code class="parameter">master[]</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        URI d&#039;un serveur de réplication MySQL maitres. L&#039;URI est de la forme
        <code class="literal">hostname[:port|unix_domain_socket]</code>.
       </p>
       <p class="para">
        Le plugin ne supporte que l&#039;utilisation d&#039;un seul maitre à la fois.
       </p>
       <p class="para">
        Déclarer un maitre est obligatoire. Le plugin renverra une alerte à la connexion
        si il ne trouve pas de maitre dans la configuration.
        Ce message d&#039;alerte peut ressembler à
        <code class="literal">(mysqlnd_ms) Cannot find master section in config</code>.
        Aussi, le plugin renseignera sur un code d&#039;erreur pour la connexion
        <code class="literal">HY000/2000 (CR_UNKNOWN_ERROR)</code>. Le message dépend de la langue
        considérée.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.slave">
       <code class="parameter">slave[]</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        URI d&#039;un ou plusieurs serveurs de réplication MySQL esclaves. L&#039;URI est de la forme
        <code class="literal">hostname[:port|unix_domain_socket]</code>.
       </p>
       <p class="para">
        Le plugin supporte l&#039;utilisation d&#039;un ou plusieurs esclaves.
       </p>
       <p class="para">
        Déclarer au moins un esclave est obligatoire. Le plugin renverra une alerte à la connexion
        s&#039;il ne trouve pas au moins un esclave dans la configuration.
        Ce message d&#039;alerte peut ressembler à
        <code class="literal">(mysqlnd_ms) Cannot find slaves section in config</code>.
        Aussi, le plugin renseignera sur un code d&#039;erreur pour la connexion
        <code class="literal">HY000/2000 (CR_UNKNOWN_ERROR)</code>.Le message dépend de la langue
        considérée.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.pick">
       <code class="parameter">pick[]</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        Politique de balance de charge (choix du serveur). Sont supportées :
        <code class="literal">random</code>, <code class="literal">random_once</code> (defaut),
        <code class="literal">roundrobin</code>, <code class="literal">user</code>.
       </p>
       <p class="para">
        Si aucune politique n&#039;est précisée, <code class="literal">random_once</code> sera utilisée.
        La politique <code class="literal">random_once</code> choisit un serveur esclave au hasard
        lors de la première requête en lecture. Le serveur esclave sera alors utilisé pour toutes
        les requêtes en lecture jusqu&#039;à l&#039;extinction de PHP.
       </p>
       <p class="para">
        La politique <code class="literal">random</code> choisira un serveur esclave au hasard pour chaque
        requête de lecture.
       </p>
       <p class="para">
        Avec <code class="literal">roundrobin</code> le plugin parcourt la liste des esclaves déclarés
        et les choisit un-à-un pour chaque requête. Si le plugin atteint la fin de la liste,
        il prendra le premier serveur esclave configuré.
       </p>
       <p class="para">
        Utiliser plus d&#039;une politique d&#039;équilibrage par section de configuration n&#039;est effectif
        qu&#039;avec la politique <code class="literal">user</code>
        et avec <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>. Si la fonction utilisateur
        échoue à la selection d&#039;un serveur, le plugin se rabat sur le second choix de politique
        d&#039;équilibrage.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.failover">
       <code class="parameter">failover</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        Politique de gestion des incidents (failover). Sont supportées :
        <code class="literal">disabled</code> (défaut), <code class="literal">master</code>.
       </p>
       <p class="para">
        Si aucune politique de gestion d&#039;incident (failover) n&#039;est utilisée, le plugin n&#039;effectuera
        aucun failover automatique (<code class="literal">failover=disabled</code>). Dès lors que le plugin échoue
        à la connexion sur un serveur, il émet un warning et change le code d&#039;erreur et le message
        d&#039;erreur de la connexion. Après, c&#039;est à l&#039;application de gérer l&#039;erreur et d&#039;éventuellement
        relancer la requête pour déclencher la selection d&#039;un autre serveur.
       </p>
       <p class="para">
        Si vous utilisez <code class="literal">failover=master</code>, le plugin changera vers un
        esclave automatiquement en failover, si possible. Veuillez lire la documentation dans le cas
        de l&#039;utilisation de <code class="literal">failover=master</code>, cela comporte des risques à connaitre.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.lazy-connections">
       <code class="parameter">lazy_connections</code>
       <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
      </dt>

      <dd>

       <p class="para">
        Utilise ou non des connexions paresseuses. Ce sont des connexions qui ne
        sont pas établies tant que le client n&#039;envoie pas d&#039;informations vers celle-ci. 
       </p>
       <p class="para">
        Il est fortement recommandé d&#039;utiliser les connexions paresseuses, car elles
        aident à réduire le nombre de connexions simultanées ouvertes. Si vous les
        désactivez, et que par exemple, vous configurez un maitre de réplication et
        deux esclaves, le plugin ouvrira alors 3 connexions dès le premier appel
        alors que l&#039;application pourrait ne vouloir utiliser que le maitre.
       </p>
       <p class="para">
        Les connexions parresseuses représentent par contre un problème si vous changez
        souvent le statut de vos connexions. En effet, le plugin ne fait suivre les ordres
        de changement de statut qu&#039;aux connexions effectivement déja ouvertes, et non à
        celles qui sont configurées, mais pas encore ouvertes.
        Par exemple, si le jeu de caractères devait être changé en utilisant un appel PHP
        vers l&#039;API MySQL, le plugin ne changera que pour les connexions ouvertes. Il ne se
        souviendra pas du jeu de caractères à appliquer aux futures connexions à établir,
        elles supporteront alors un autre jeu de caractères, ce qui n&#039;est pas très intelligent,
        étant donné que les jeux de caractères sont utilisés dans l&#039;échappement.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.master-on-write">
       <code class="parameter">master_on_write</code>
       <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
      </dt>

      <dd>

       <p class="para">
        Si utilisé, le plugin utilisera le maitre immédiatement après le premier
        appel à celui-ci. Les applications pourront toujours utiliser les astuces
        SQL pour discuter avec les esclaves.
       </p>
       <p class="para">
        Ce paramètre peut aider à réduire la latence de la réplication. Si une application
        lance un <code class="literal">INSERT</code> le plugin selectionnera par défaut le maitre pour toutes
        les requêtes futures, y compris les <code class="literal">SELECT</code>. Ceci aide à éviter les
        problèmes de lectures sur des esclaves qui n&#039;ont pas encore répliqué le
        <code class="literal">INSERT</code> précédent.
       </p>
      </dd>

     
     
      <dt id="ini.mysqlnd-ms-plugin-config.trx-stickiness">
       <code class="parameter">trx_stickiness</code>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </dt>

      <dd>

       <p class="para">
        Politique d&#039;accrochage des transactions. Sont supportées :
        <code class="literal">disabled</code> (défaut), <code class="literal">master</code>.
       </p>
       <p class="para">
        Fonctionnalité expérimentale.
       </p>
       <p class="para">
        Cette fonctionnalité requiert 5.4.0 ou plus récent. Si vous utilisez PHP avant 5.4.0,
        le plugin va emettre un warning comme
        <code class="literal">(mysqlnd_ms) trx_stickiness strategy is not supported before PHP 5.3.99</code>.
       </p>
       <p class="para">
        Si aucune politique d&#039;accrochage des transactions n&#039;est utilisée ou si 
        <code class="literal">trx_stickiness=disabled</code>, le plugin n&#039;est pas relatif aux transactions.
        Ainsi, le plugin pourrait équilibrer les connexions et basculer d&#039;une à l&#039;autre
        en plein milieu d&#039;une transaction. Le plugin n&#039;est pas sûr pour les transactions.
        Des astuces SQL devraient être utilisées pour éviter de tels cas.
       </p>
       <p class="para">
        Depuis PHP 5.4.0, la bibliothèque mysqlnd permet au plugin de surveiller le mode
        <code class="literal">autocommit</code> en appelant la fonction
        <code class="literal">trx_autocommit()</code>. Si <code class="literal">trx_stickiness=master</code> et
        <code class="literal">autocommit</code> que les transactions sont désactivées suite à un appel
        de <code class="literal">mysqlnd</code> à <code class="literal">trx_autocommit()</code>, le plugin devient
        sensible au début de la transaction. Il arrête alors l&#039;équilibrage de charge automatique
        et dirige les requêtes vers le maitre jusqu&#039;à ce que <code class="literal">autocommit</code>
        soit activé. Ainsi, aucune astuce SQL n&#039;est requise.
       </p>
       <p class="para">
        Un exemple d&#039;une fonction PHP déclenchant un appel de <code class="literal">mysqlnd</code> 
        à <code class="literal">trx_autocommit()</code> est
        <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span>.
       </p>
       <p class="para">
        Même si <code class="literal">trx_stickiness=master</code>, le plugin
        ne peut être mis au courant des changements du mode <code class="literal">autocommit</code> causés par
        des requêtes SQL comme <code class="literal">SET AUTOCOMMIT=0</code>.
       </p>
      </dd>

     
    </dl>

   </p>
  </div>
  
  <div class="section" id="mysqlnd-ms.testing">
   <h2 class="title">Testing</h2>
   <blockquote class="note"><p><strong class="note">Note</strong>: 
    <p class="para">
     Cette section s&#039;applique pour myslqnd_ms 1.1.0 ou supérieure, et non pour
     la série 1.0.
    </p>
   </p></blockquote>
   <p class="para">
    La suite de test PECL/mysqlnd_ms se trouve dans le dossier
    <var class="filename">tests/</var> des sources de la distribution.
    La suite de test consiste en des tests standards phpt, qui sont décrits
    sur le site d&#039;assurance qualité de PHP.
   </p>
   <p class="para">
    L&#039;exécution des tests nécessite la configuration d&#039;un à 4 serveurs MySQL.
    Quelques tests ne se connectent pas du tout à MySQL. D&#039;autres ne nécessitent
    qu&#039;un seul serveur. D&#039;autres, deux. Dans la plupart des cas, deux serveurs
    sont utilisés pour émuler la configuration d&#039;une réplication. Dans d&#039;autres cas,
    un maître et un esclave d&#039;une configuration de réplication MySQL existante
    est nécessaire pour les tests. Les tests vont tenter de détecter le nombre
    de serveurs et le type de serveurs fournis. Si les serveurs requis ne sont pas
    trouvés, le test ne sera pas effecté, automatiquement.
   </p>
   <p class="para">
    Avant d&#039;effectuer ces tests, éditez le fichier <var class="filename">tests/config.inc</var>
    pour configurer les serveurs MySQL à utiliser lors des tests. 
   </p>
   <p class="para">
    Voici la configuration habituellement utilisée :
    <div class="example-contents">
<div class="cdata"><pre>
 putenv(&quot;MYSQL_TEST_HOST=localhost&quot;);
 putenv(&quot;MYSQL_TEST_PORT=3306&quot;);
 putenv(&quot;MYSQL_TEST_USER=root&quot;);
 putenv(&quot;MYSQL_TEST_PASSWD=&quot;);
 putenv(&quot;MYSQL_TEST_DB=test&quot;);
 putenv(&quot;MYSQL_TEST_ENGINE=MyISAM&quot;);
 putenv(&quot;MYSQL_TEST_SOCKET=&quot;);

 putenv(&quot;MYSQL_TEST_SKIP_CONNECT_FAILURE=1&quot;);
 putenv(&quot;MYSQL_TEST_CONNECT_FLAGS=0&quot;);
 putenv(&quot;MYSQL_TEST_EXPERIMENTAL=0&quot;);

 /* émulation d&#039;un cluster de réplication */
 putenv(&quot;MYSQL_TEST_EMULATED_MASTER_HOST=&quot;. getenv(&quot;MYSQL_TEST_HOST&quot;));
 putenv(&quot;MYSQL_TEST_EMULATED_SLAVE_HOST=&quot;. getenv(&quot;MYSQL_TEST_HOST&quot;));

 /* cluster de réplication réel */
 putenv(&quot;MYSQL_TEST_MASTER_HOST=&quot;. getenv(&quot;MYSQL_TEST_EMULATED_MASTER_HOST&quot;));
 putenv(&quot;MYSQL_TEST_SLAVE_HOST=&quot;. getenv(&quot;MYSQL_TEST_EMULATED_SLAVE_HOST&quot;));
</pre></div>
    </div>

   </p>
   <p class="para">
    <code class="literal">MYSQL_TEST_HOST</code>, <code class="literal">MYSQL_TEST_PORT</code> et
    <code class="literal">MYSQL_TEST_SOCKET</code> définissent le nom de l&#039;hôte,
    le port TCP/IP et le socket du domaine Unix pour le serveur de base de données
    par défaut. <code class="literal">MYSQL_TEST_USER</code> et <code class="literal">MYSQL_TEST_PASSWD</code>
    contiennent le nom de l&#039;utilisateur et le mot de passe nécessaires pour la connexion
    à la base de données/schéma configurée avec <code class="literal">MYSQL_TEST_DB</code>.
    Tous les serveurs doivent avoir le même utilisateur de base de données de configuré
    pour donner l&#039;accès à la base de données de test.
   </p>
   <p class="para">
    L&#039;utilisation de la syntaxe <code class="literal">host</code>, <code class="literal">host:port</code> ou
    <code class="literal">host:/path/to/socket</code> pour <code class="literal">MYSQL_TEST_SLAVE_HOST</code>
    permet de définir un hôte, un port et un hôte, et un socket différent pour le
    serveur esclave logique.
    <div class="example-contents">
<div class="cdata"><pre>
putenv(&quot;MYSQL_TEST_SLAVE_HOST=192.168.78.136:3307&quot;));
putenv(&quot;MYSQL_TEST_MASTER_HOST=myserver_hostname:/path/to/socket&quot;));
</pre></div>
    </div>

   </p>
  </div>
  
  <div class="section" id="mysqlnd-ms.debugging">
   <h2 class="title">Débogage et surveillance</h2>
   <p class="para">
    Les logs de débogage mysqlnd peuvent être utilisées pour le débogage et la surveillance
    de l&#039;activité de PECL/mysqlnd_ms, vu que mysqlnd PECL/mysqlnd_ms ajoute des informations
    de surveillance dans le fichier de débogage de la bibliothèque mysqlnd.
    Reportez-vous à la documentation sur la directive de configuration PHP 
    <a href="mysqlnd.config.html#ini.mysqlnd.debug" class="link"><code class="literal">mysqlnd.debug</code></a>
    pour plus d&#039;informations détaillées sur la façon dont doit être
    configurer les logs de débogage.
   </p>
   <p class="para">
    Exemple de configuration de cette directive pour activer les logs de débogage :
    <div class="example-contents">
<div class="cdata"><pre>
mysqlnd.debug=d:t:x:O,/tmp/mysqlnd.trace
</pre></div>
    </div>

    <blockquote class="note"><p><strong class="note">Note</strong>: 
     <p class="para">
      Cette fonctionnalité n&#039;est disponible qu&#039;avec une compilation de PHP en
      mode débogage. Elle fonctionne sous Microsoft Windows si l&#039;on utilise
      PHP en mode débogage et que PHP a été compilé en utilisant
      Microsoft Visual C version 9 et supérieure.
     </p>
    </p></blockquote>
   </p>
   <p class="para">
    Les logs de débogage montrent les appels fonctions à la bibliothèque
    mysqlnd et PECL/mysqlnd_ms. Les appels à mysqlnd sont habituellement préfixés
    avec <code class="literal">mysqlnd_</code>. Les appels internes PECL/mysqlnd commencent avec
    <code class="literal">mysqlnd_ms</code>.
   </p>
   <p class="para">
    Exemple attendu depuis les logs de débogage (connexion) :
    <div class="example-contents">
<div class="cdata"><pre>
[...]
&gt;mysqlnd_connect
| info : host=myapp user=root db=test port=3306 flags=131072
| &gt;mysqlnd_ms::connect
| | &gt;mysqlnd_ms_config_json_section_exists
| | | info : section=[myapp] len=[5]
| | | &gt;mysqlnd_ms_config_json_sub_section_exists
| | | | info : section=[myapp] len=[5]
| | | | info : ret=1
| | | &lt;mysqlnd_ms_config_json_sub_section_exists
| | | info : ret=1
| | &lt;mysqlnd_ms_config_json_section_exists
[...]
</pre></div>
    </div>

   </p>
   <p class="para">
    Les logs de débogage ne sont pas uniquement utiles pour les développeurs
    du plugin, mais aussi pour trouver la cause d&#039;erreurs utilisateurs.
    Par exemple, si votre application ne gère pas correctement les erreurs,
    et échoue dans l&#039;enregistrement des messages d&#039;erreur, le fait de vérifier
    les logs de débogage et de surveillance peut aider dans la recherche de la
    cause. L&#039;utilisation des logs de débogage pour déboguer l&#039;application
    ne doit être considérée que si aucune autre option n&#039;est disponible.
    Le fait d&#039;écrire les logs de débogage sur le disque est une opération
    lente et peut avoir des impacts négatifs dans les performances de l&#039;application.
   </p>
   <p class="para">
    Exemple attendu depuis les logs de débogage (échec de connexion) :
    <div class="example-contents">
<div class="cdata"><pre>
[...]
| | | | | | | info : adding error [Access denied for user &#039;root&#039;@&#039;localhost&#039; (using password: YES)] to the list
| | | | | | | info : PACKET_FREE(0)
| | | | | | | info : PACKET_FREE(0x7f3ef6323f50)
| | | | | | | info : PACKET_FREE(0x7f3ef6324080)
| | | | | | &lt;mysqlnd_auth_handshake
| | | | | | info : switch_to_auth_protocol=n/a
| | | | | | info : conn-&gt;error_info.error_no = 1045
| | | | | &lt;mysqlnd_connect_run_authentication
| | | | | info : PACKET_FREE(0x7f3ef63236d8)
| | | | | &gt;mysqlnd_conn::free_contents
| | | | | | &gt;mysqlnd_net::free_contents
| | | | | | &lt;mysqlnd_net::free_contents
| | | | | | info : Freeing memory of members
| | | | | | info : scheme=unix:///tmp/mysql.sock
| | | | | | &gt;mysqlnd_error_list_pdtor
| | | | | | &lt;mysqlnd_error_list_pdtor
| | | | | &lt;mysqlnd_conn::free_contents
| | | | &lt;mysqlnd_conn::connect
[...]
</pre></div>
    </div>

   </p>
   <p class="para">
    Les logs de surveillance peuvent également être utilisés pour vérifier
    le comportement correct de PECL/mysqlnd_ms, par exemple, pour vérifier
    quel serveur a été sélectionné pour l&#039;exécution de la requête et pourquoi
    celui-là.
   </p>
   <p class="para">
    Exemple attendu depuis les logs de débogage (décision du plugin) :
    <div class="example-contents">
<div class="cdata"><pre>
[...]
&gt;mysqlnd_ms::query
| info : query=DROP TABLE IF EXISTS test
| &gt;_mysqlnd_plugin_get_plugin_connection_data
| | info : plugin_id=5
| &lt;_mysqlnd_plugin_get_plugin_connection_data
| &gt;mysqlnd_ms_pick_server_ex
| | info : conn_data=0x7fb6a7d3e5a0 *conn_data=0x7fb6a7d410d0
| | &gt;mysqlnd_ms_select_servers_all
| | &lt;mysqlnd_ms_select_servers_all
| | &gt;mysqlnd_ms_choose_connection_rr
| | | &gt;mysqlnd_ms_query_is_select
[...]
| | | &lt;mysqlnd_ms_query_is_select
[...]
| | | info : Init the master context
| | | info : list(0x7fb6a7d3f598) has 1
| | | info : Using master connection
| | | &gt;mysqlnd_ms_advanced_connect
| | | | &gt;mysqlnd_conn::connect
| | | | | info : host=localhost user=root db=test port=3306 flags=131072 persistent=0 state=0
</pre></div>
    </div>

   </p>
   <p class="para">
    Dans ce cas, la requête <code class="literal">DROP TABLE IF EXISTS test</code>
    a été exécutée. Notez que la chaîne de requête est affichée directement
    dans le fichier de logs. Aussi, vous devriez restreindre l&#039;accès à ce fichier
    suivant vos contraintes de sécurité.
   </p>
   <p class="para">
    La requête a été soumis à la balance de charge en utilisant la politique round robin,
    comme vous pouvez facilement le deviner depuis le nom de la fonction
    <code class="literal">mysqlnd_ms_choose_connection_rr</code>.
    Elle a été envoyée au serveur maître s&#039;exécutant sur
    <code class="literal">host=localhost user=root db=test port=3306 flags=131072 persistent=0 state=0</code>.
   </p>
  </div>
  
  <div class="section" id="mysqlnd-ms.monitoring">
   <h2 class="title">Monitoring</h2>
   <p class="para">
    L&#039;activité du plugin peut être surveillée en utilisant les logs de trace
    mysqlnd, les statistiques mysqlnd, les statistiques du plugin mysqlnd_ms,
    ainsi que des outils de déboggage PHP externes. L&#039;utilisation des logs
    de trace devrait être limitée au débogage. Il est recommandé d&#039;utiliser
    les statistiques du plugin pour la surveillance.
   </p>
   <p class="para">
    L&#039;écriture d&#039;une trace dans un log est une opération lente. Si vous utilisez
    un outil de débogage externe PHP, référez-vous au manuel utilisateur de ce dernier
    concernant les impacts sur les performances ainsi que le type d&#039;informations
    collectées. Dans la plupart des cas, les outils de débogage externe PHP
    font des appels à la pile. Un appel à la pile, ou une trace dans les logs
    sont souvent plus difficiles à interpréter que les statistiques fournies par le
    plugin.
   </p>
   <p class="para">
    Les statistiques du plugin indiquent la fréquence d&#039;utilisation d&#039;un noeud du cluster
    (esclave ou maître), pourquoi le noeud a été utilisé, si les connexions paresseuses
    ont été utilisées et si l&#039;injection d&#039;un identifiant global de transaction a
    été effectuée. Les informations de surveillance fournies permettent à l&#039;utilisateur
    de vérifier les décisions du plugin et de prévoir les ressources de son cluster
    suivant leur utilisation. La fonction <span class="function"><a href="function.mysqlnd-ms-get-stats.html" class="function">mysqlnd_ms_get_stats()</a></span>
    est utilisée pour accéder aux statistiques. Reportez-vous aux descriptions
    des fonctions pour une liste des statistiques disponibles.
   </p>
   <p class="para">
    Les statistiques sont collectées pour chaque processus PHP. Leur scope se limite à
    un processus PHP. Suivant le modèle de déploiement PHP, un processus peut
    servir une ou plusieurs requêtes web. Si le modèle CGI est utilisé, un processus
    PHP ne sert qu&#039;une requête web. Si le modèle FastCGI ou pre-fork serveur web
    est utilisé, un processus PHP sert habituellement plusieurs requêtes web ;
    idem dans le cas d&#039;un serveur web threadé. Notez que les threads fonctionnant
    en parallèle peuvent mettre à jour les statistiques en parallèle.
    Aussi, si un modèle de déploiement PHP threadé est utilisé, les statistiques
    peuvent être modifiées par plus d&#039;un script à la fois. Un script ne peut pas être
    sûr de ne voir que ces propres modifications sur les statistiques.
   </p>
   <p class="para">
    <div class="example" id="example-2250">
     <p><strong>Exemple #38 Vérification de l&#039;activité du plugin sur un modèle de déploiement non-threadé</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1</pre>
</div>
     </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;La&nbsp;balance&nbsp;de&nbsp;charge&nbsp;suit&nbsp;les&nbsp;règles&nbsp;de&nbsp;la&nbsp;section&nbsp;"myapp"&nbsp;du&nbsp;fichier&nbsp;de&nbsp;configuration&nbsp;du&nbsp;plugin&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;évidemment,&nbsp;votre&nbsp;gestionnaire&nbsp;d'erreur&nbsp;est&nbsp;meilleur...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br /></span><span style="color: #0000BB">$stats_before&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br />if&nbsp;(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'Read&nbsp;request'&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_all</span><span style="color: #007700">());<br />}<br /></span><span style="color: #0000BB">$stats_after&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br />if&nbsp;(</span><span style="color: #0000BB">$stats_after</span><span style="color: #007700">[</span><span style="color: #DD0000">'use_slave'</span><span style="color: #007700">]&nbsp;&lt;=&nbsp;</span><span style="color: #0000BB">$stats_before</span><span style="color: #007700">[</span><span style="color: #DD0000">'use_slave'</span><span style="color: #007700">])&nbsp;{<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Suivant&nbsp;les&nbsp;statistiques,&nbsp;la&nbsp;requête&nbsp;en&nbsp;lecture&nbsp;n'a&nbsp;pas&nbsp;été&nbsp;exécutée&nbsp;sur&nbsp;un&nbsp;esclave&nbsp;!"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
   <p class="para">
    Les statistiques sont aggrégées pour les activités de tous les plugins, et toutes
    les connexions gérées par le plugin. Il n&#039;est pas possible de savoir le nombre
    de contribution aux statistiques d&#039;un gestionnaire de connexion en particulier.
   </p>
   <p class="para">
    L&#039;utilisation de la fonction <span class="function"><a href="function.register-shutdown-function.html" class="function">register_shutdown_function()</a></span>
    ou de la directive de configuration <code class="literal">auto_append_file</code> de PHP
    est une façon simple de copier les statistiques dans, par exemple, un fichier
    de logs, lorsque le script se termine. Au lieu d&#039;utiliser un fichier de logs,
    il est également possible d&#039;envoyer les statistiques vers un outil de surveillance
    externe pour l&#039;enregistrement et le rendu.
   </p>
   <p class="para">
    <div class="example" id="example-2251">
     <p><strong>Exemple #39 Enregistrement des statistiques lorsque le script se termine</strong></p>
     <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1
error_log=/tmp/php_errors.log</pre>
</div>
     </div>

     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">check_stats</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">var_export</span><span style="color: #007700">(</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">error_log</span><span style="color: #007700">(</span><span style="color: #0000BB">$msg</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">register_shutdown_function</span><span style="color: #007700">(</span><span style="color: #DD0000">"check_stats"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
  </div>
 </div></div></div></body></html>