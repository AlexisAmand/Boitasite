<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Changement dans la gestion des r&eacute;f&eacute;rences</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="migration51.changes.html">« Nouvelles fonctionnalit&eacute;s PHP 5.1.x</a></li>
      <li style="float: right;"><a href="migration51.reading.html">Lecture de [] »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="migration51.html">Migration de PHP 5.0.x &agrave; PHP 5.1.x</a></li>
    <li>Changement dans la gestion des r&eacute;f&eacute;rences</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="migration51.references" class="section">
  <h2 class="title">Changement dans la gestion des références</h2>
  <ul class="itemizedlist">
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-overview" class="link">Présentation</a>
    </p>
   </li>
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-fails" class="link">Code qui fonctionnait en
      4.3.x, mais qui échoue maintenant</a>
    </p>
   </li>
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-error" class="link">Code qui fonctionnait en
      4.3.x, mais qui émet une alerte</a>
    </p>
   </li>
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-works" class="link">Code qui échouait en PHP
      4.3.x, mais qui fonctionne maintenant</a>
    </p>
   </li>
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-didnotwork" class="link">Code qui
      devrait avoir fonctionné en PHP 5.0.x</a>
    </p>
   </li>
   <li class="listitem">
    <p class="para">
     <a href="migration51.references.html#migration51.references-warnings" class="link">Alertes qui vont et viennent</a>
    </p>
   </li>
  </ul>

  <div class="section" id="migration51.references-overview">
   <h2 class="title">Présentation</h2>
   <p class="para">
    Du point de vue du programmeur, le changement qui aura le plus d&#039;impact
    sur le code déjà écrit est la manière avec laquelle les références sont
    gérées dans les versions PHP 4.4.0 et plus récentes.
   </p>
   <p class="para">
    Jusqu&#039;à la version PHP 4.3 incluse, il était possible d&#039;envoyer,
    assigner ou retourner des variables par références, alors qu&#039;elles auraient
    dues être retournées par valeur, comme des constantes, des valeurs temporaires (comme le résultat d&#039;une expression), ou le résultat d&#039;une fonction qui elle-même, retourne une valeur.
   </p>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$foo&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"123"</span><span style="color: #007700">;<br /><br />function&nbsp;</span><span style="color: #0000BB">return_value</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$foo</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$foo</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$bar&nbsp;</span><span style="color: #007700">=&nbsp;&amp;</span><span style="color: #0000BB">return_value</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <p class="para">
    Même si ce code fonctionne tel qu&#039;attendu en PHP 4.3, en général il
    conduit à une situation indéfinie. Le moteur Zend ne peut pas fonctionner
    correctement avec des valeurs passées par références. Ce bogue peut et
    a conduit à des corruptions de mémoire difficiles à reproduire, notamment
    lorsque le code de l&#039;application est compliqué.
   </p>
   <p class="para">
    En PHP 4.4.0, PHP 5.0.4 et toutes les versions plus récentes, le moteur
    Zend a été modifié pour reconnaître les cas où une valeur ne doit pas
    être utilisée par référence. La valeur réelle est maintenant utilisée
    dans ces cas, et une alerte est émise. Cette alerte prend la forme d&#039;un
    message <strong><code>E_NOTICE</code></strong> en PHP 4.4.0 et plus récent, et
    <strong><code>E_STRICT</code></strong> en PHP 5.0.4 et plus récent.
   </p>
   <p class="para">
    Du code qui pouvait produire des corruptions de mémoire ne peut plus le faire. Cependant, certains codes anciens peuvent fonctionner de manière
    différente.
   </p>
  </div>

  <div class="section" id="migration51.references-fails">
   <h2 class="title">Code qui fonctionnait en 4.3.x, mais qui échoue maintenant</h2>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">func</span><span style="color: #007700">(&amp;</span><span style="color: #0000BB">$arraykey</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$arraykey</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;la&nbsp;fonction&nbsp;retourne&nbsp;par&nbsp;valeur!<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB">$array&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'a'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'b'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'c'</span><span style="color: #007700">);<br />foreach&nbsp;(</span><span style="color: #0000BB">array_keys</span><span style="color: #007700">(</span><span style="color: #0000BB">$array</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$y&nbsp;</span><span style="color: #007700">=&nbsp;&amp;</span><span style="color: #0000BB">func</span><span style="color: #007700">(</span><span style="color: #0000BB">$array</span><span style="color: #007700">[</span><span style="color: #0000BB">$key</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$z</span><span style="color: #007700">[]&nbsp;=&amp;&nbsp;</span><span style="color: #0000BB">$y</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$z</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;<br /></span>&lt;</span>
</code></div>
    </div>

    <p class="para">
     L&#039;exécution du script ci-dessus dans une version de PHP antérieure à la
     correction du bogue produit ce résultat :
    </p>
    <div class="example-contents screen">
<div class="cdata"><pre>
array(3) {
  [0]=&gt;
  &amp;string(1) &quot;a&quot;
  [1]=&gt;
  &amp;string(1) &quot;b&quot;
  [2]=&gt;
  &amp;string(1) &quot;c&quot;
}
</pre></div>
    </div>
    <p class="para">
     Après la correction du bogue, cela donne :
    </p>
    <div class="example-contents screen">
<div class="cdata"><pre>
array(3) {
  [0]=&gt;
  &amp;string(1) &quot;c&quot;
  [1]=&gt;
  &amp;string(1) &quot;c&quot;
  [2]=&gt;
  &amp;string(1) &quot;c&quot;
}
</pre></div>
    </div>
   </div>
   <p class="para">
    Ceci est dû au fait que <code class="literal">func()</code> effectue une assignation
    par valeur. La valeur de <var class="varname">$y</var> est réassignée, et que la
    liaison par référence avec <var class="varname">$z</var> est préservée. Avant la
    correction du bogue, la valeur était assignée par référence, faisant que
    la variable <var class="varname">$y</var> était réassignée à chaque assignement.    
    La tentative de liaison avec une valeur temporaire est la cause
    de la corruption de la mémoire.
   </p>
   <p class="para">
    Ce code peut être réparé pour fonctionner à l&#039;identique avec des versions
    pré et post-correction. La signature de <code class="literal">func()</code> peut être
    modifiée pour retourner les valeurs par référence, ou bien l&#039;affectation
    par référence peut être supprimée du résultat de <code class="literal">func()</code>.
   </p>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">func</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">'function&nbsp;return'</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$x&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'original&nbsp;value'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$y&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">$x</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$y&nbsp;</span><span style="color: #007700">=&nbsp;&amp;</span><span style="color: #0000BB">func</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #0000BB">$x</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <p class="para">
    En PHP 4.3, <var class="varname">$x</var> vaudrait &#039;original value&#039;, alors qu&#039;après le changement, il
    vaudrait &#039;function return&#039; : n&#039;oubliez pas que la fonction ne retourne plus
    par référence, et que la référence est convertie en affectation par valeur.
    Encore une fois, cela peut être corrigé en forçant <code class="literal">func()</code> à retourner par
    référence, ou bien en éliminant l&#039;affectation par référence.
   </p>
  </div>

  <div class="section" id="migration51.references-error">
   <h2 class="title">Code qui fonctionnait en PHP 4.3.x, mais qui émet maintenant
          une erreur</h2>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Foo&nbsp;</span><span style="color: #007700">{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">getThis</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;</span><span style="color: #0000BB">destroyThis</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$baz&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getThis</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$bar&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Foo</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$bar</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">destroyThis</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$bar</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <p class="para">
    En PHP 5.0.3, <var class="varname">$bar</var> vaut <strong><code>NULL</code></strong> au
    lieu de l&#039;objet attendu. Cela arrive car <code class="literal">getThis()</code>
    retourne une valeur, mais que la valeur est assignée par référence.
    Même si cela fonctionne désormais comme attendu, ce code est en
    fait invalide, et émettra une alerte <strong><code>E_NOTICE</code></strong> sous
    PHP 4.4 ou <strong><code>E_STRICT</code></strong> en PHP 5.0.4 et plus récent.
   </p>
  </div>

  <div class="section" id="migration51.references-works">
   <h2 class="title">Code qui échouaient en PHP 4.3.x, mais qui fonctionne maintenant</h2>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;&amp;</span><span style="color: #0000BB">f</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$x&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"foo"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$x</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$x</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;return(</span><span style="color: #0000BB">$a</span><span style="color: #007700">);<br />}<br /><br />for&nbsp;(</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">3</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i</span><span style="color: #007700">++)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$h&nbsp;</span><span style="color: #007700">=&nbsp;&amp;</span><span style="color: #0000BB">f</span><span style="color: #007700">();<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <p class="para">
     En PHP 4.3, le troisième appel à <span class="function"><a href="function.var-dump.html" class="function">var_dump()</a></span> produit
     <strong><code>NULL</code></strong>, à cause d&#039;une correction de la mémoire, causée
     par le retour d&#039;une valeur non initialisée par référence. C&#039;est du code
     valide en PHP 5.0.4 et plus récent, mais il produit une erreur dans les
     versions plus anciennes.
    </p>
   </div>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$arr&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'a1'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'alfa'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'ok'</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$arr&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">$arr</span><span style="color: #007700">[</span><span style="color: #DD0000">'a1'</span><span style="color: #007700">];<br />echo&nbsp;</span><span style="color: #DD0000">'-'</span><span style="color: #007700">.</span><span style="color: #0000BB">$arr</span><span style="color: #007700">[</span><span style="color: #DD0000">'alfa'</span><span style="color: #007700">].</span><span style="color: #DD0000">"-\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <p class="para">
     Jusqu&#039;en PHP 5.0.5, il n&#039;était pas possible d&#039;assigner un élément de
     tableau par référence de cette manière. C&#039;est corrigé maintenant.
    </p>
   </div>
  </div>

  <div class="section" id="migration51.references-didnotwork">
   <h2 class="title">Code qui <code class="literal">aurait du fonctionner</code> en PHP 5.0.x</h2>
   <p class="para">
    Il y a quelques cas de bogues rapportés en PHP PHP 5.0 avant la correction
    de ce bogue qui &#039;refonctionnent&#039;. Cependant, dans tous les cas, des erreurs
    sont émises en PHP 5.1.x, car le code est invalide. Retourner des références
    avec <code class="literal">self::</code> fonctionne maintenant, mais émet une alerte
    <strong><code>E_STRICT</code></strong>, et même si votre expérience est différente
    lors de l&#039;assignation d&#039;un objet par référence, vous verrez toujours une
    erreur <strong><code>E_ERROR</code></strong> lorsque vous tentez cela même si
    l&#039;assignation semble fonctionner.
   </p>
  </div>

  <div class="section" id="migration51.references-warnings">
   <h2 class="title">Alertes qui vont et viennent</h2>
   <p class="para">
    Des appels imbriqués à des fonctions retournant des valeurs par référence
    sont valides en PHP 4.3.x et PHP 5.1.x, mais ils émettent des erreurs
    <strong><code>E_NOTICE</code></strong> et <strong><code>E_STRICT</code></strong> dans les
    nouvelles versions de PHP.
   </p>
   <div class="informalexample">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;&amp;&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$var&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'ok'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$var</span><span style="color: #007700">;<br />}<br /><br />function&nbsp;&amp;&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">foo</span><span style="color: #007700">();<br />}<br /><br /></span><span style="color: #0000BB">$a&nbsp;</span><span style="color: #007700">=&amp;&nbsp;</span><span style="color: #0000BB">bar</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$a</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </div>
 </div></div></div></body></html>