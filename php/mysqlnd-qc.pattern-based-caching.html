<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Mise en cache bas&eacute;e sur un masque</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-qc.per-query-ttl.html">« D&eacute;finition du TTL</a></li>
      <li style="float: right;"><a href="mysqlnd-qc.slam-defense.html">D&eacute;fense de type slam »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-qc.quickstart.html">D&eacute;marrage rapide et quelques exemples</a></li>
    <li>Mise en cache bas&eacute;e sur un masque</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-qc.pattern-based-caching" class="section">
  <h2 class="title">Mise en cache basée sur un masque</h2>
  <p class="para">
   Une application a 3 options pour demander à PECL/mysqlnd_qc si une requête doit être
   mise en cache ou non. L&#039;approche la plus basique est de mettre en cache toutes les
   requêtes en définissant
   <code class="literal"><a href="mysqlnd-qc.configuration.html" class="link">mysqlnd_qc.cache_by_default = 1</a></code>.
   Cette approche est souvent peu pratique. Mais elle permet aux utilisateurs de
   prendre conscience rapidement des gains de performance de la mise en cache.
   Une application prévue pour utiliser un cache doit être capable de préfixer
   les requêtes sélectionnées avec l&#039;astuce SQL appropriée. Cependant, le fait
   de modifier le code source d&#039;une application peut ne pas toujours être possible
   ou désiré, par exemple, pour éviter des problèmes lors des mises à jour logicielles.
   Aussi, PECL/mysqlnd_qc autorise la définition d&#039;une fonction de rappel qui décide
   si une requête doit être mise en cache ou non.
  </p>
  <p class="para">
   La fonction de rappel est installée avec la fonction
   <span class="function"><a href="function.mysqlnd-qc-set-is-select.html" class="function">mysqlnd_qc_set_is_select()</a></span>. La fonction de rappel fournit
   la chaîne de requête pour chaque requête inspectée par le plugin. Alors, la
   fonction de rappel décide de la mise en cache ou non. La fonction de rappel
   est supposée retourner <strong><code>FALSE</code></strong> si la requête ne doit pas être mise en cache.
   Si la valeur <strong><code>TRUE</code></strong> est retournée, le plugin tentera d&#039;ajouter la requête au cache.
   L&#039;entrée du cache prendra le TTL par défaut (<code class="literal"><a href="mysqlnd-qc.configuration.html" class="link">
   mysqlnd_qc.ttl</a></code>). Si la fonction de rappel retourne une valeur
   numérique, elle sera utilisée comme TTL au lieu de la valeur par défaut.
  </p>
  <p class="para">
   <div class="example" id="example-2268">
    <p><strong>Exemple #1 Définir une fonction de rappel avec
     <span class="function"><a href="function.mysqlnd-qc-set-is-select.html" class="function">mysqlnd_qc_set_is_select()</a></span></strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_qc.enable_qc=1
mysqlnd_qc.collect_statistics=1</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;fonction&nbsp;de&nbsp;rappel&nbsp;qui&nbsp;va&nbsp;décider&nbsp;si&nbsp;la&nbsp;requête&nbsp;doit&nbsp;être&nbsp;mise&nbsp;en&nbsp;cache&nbsp;ou&nbsp;non&nbsp;*/<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;static&nbsp;</span><span style="color: #0000BB">$patterns&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;true&nbsp;-&nbsp;utilisation&nbsp;du&nbsp;TTL&nbsp;par&nbsp;défaut&nbsp;depuis&nbsp;mysqlnd_qc.ttl&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"@SELECT\s+.*\s+FROM\s+test@ismU"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;3&nbsp;-&nbsp;utilisation&nbsp;d'un&nbsp;TTL&nbsp;=&nbsp;3&nbsp;secondes&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"@SELECT\s+.*\s+FROM\s+news@ismU"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">3<br />&nbsp;&nbsp;</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;vérifie&nbsp;si&nbsp;la&nbsp;requête&nbsp;correspond&nbsp;au&nbsp;masque&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">$patterns&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$pattern&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$ttl</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #0000BB">$pattern</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"is_select(%45s):&nbsp;mise&nbsp;en&nbsp;cache\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$ttl</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"is_select(%45s):&nbsp;pas&nbsp;de&nbsp;mise&nbsp;en&nbsp;cache\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br />}<br /></span><span style="color: #FF8000">/*&nbsp;Installation&nbsp;de&nbsp;la&nbsp;fonction&nbsp;de&nbsp;rappel&nbsp;*/<br /></span><span style="color: #0000BB">mysqlnd_qc_set_is_select</span><span style="color: #007700">(</span><span style="color: #DD0000">"is_select"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion,&nbsp;création&nbsp;et&nbsp;peuplement&nbsp;de&nbsp;la&nbsp;table&nbsp;test&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"host"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"schema"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"port"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"socket"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT)"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1),&nbsp;(2),&nbsp;(3)"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Mise&nbsp;en&nbsp;cache&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;id&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;1"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;Récupération&nbsp;depuis&nbsp;le&nbsp;cache&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;id&nbsp;FROM&nbsp;test&nbsp;WHERE&nbsp;id&nbsp;=&nbsp;1"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;Mise&nbsp;en&nbsp;cache&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;test"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$stats&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_qc_get_core_stats</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Mise&nbsp;en&nbsp;cache&nbsp;:&nbsp;%d\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">[</span><span style="color: #DD0000">'cache_put'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Récupération&nbsp;depuis&nbsp;le&nbsp;cache&nbsp;:&nbsp;%d\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">[</span><span style="color: #DD0000">'cache_hit'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>Les exemples ci-dessus vont afficher :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
is_select(                    DROP TABLE IF EXISTS test): pas de mise en cache
is_select(                    CREATE TABLE test(id INT)): pas de mise en cache
is_select(    INSERT INTO test(id) VALUES (1), (2), (3)): pas de mise en cache
is_select(             SELECT id FROM test WHERE id = 1): mise en cache
is_select(             SELECT id FROM test WHERE id = 1): mise en cache
is_select(                           SELECT * FROM test): mise en cache
Mise en cache : 2
Récupération depuis le cache : 1
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   La fonction de rappel de cet exemple teste si une chaîne de requête
   correspond au masque. Si c&#039;est le cas, elle retournera soit <strong><code>TRUE</code></strong>
   pour mettre en cache la requête en utilisant le TTL par défaut,
   soit un TTL alternatif.
  </p>
  <p class="para">
   Pour minimiser les modifications de l&#039;application, la fonction
   de rappel peut être mise dans un fichier qui sera par la suite inclut
   dans le script.
  </p>
 </div></div></div></body></html>