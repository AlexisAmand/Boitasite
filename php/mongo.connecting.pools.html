<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>File d'attente de connexion (version 1.2.0-1.2.12 *seulement*)</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mongo.connecting.persistent.html">« Les connexions persistentes (version 1.3.0+)</a></li>
      <li style="float: right;"><a href="mongo.connecting.persistent.manual.html">Les connexions persistantes manuelles (version sup&eacute;rieure &agrave; 1.1.4 *uniquement*) »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mongo.connecting.html">Connection</a></li>
    <li>File d'attente de connexion (version 1.2.0-1.2.12 *seulement*)</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mongo.connecting.pools" class="section">
  <h2 class="title">File d&#039;attente de connexion (version 1.2.0-1.2.12 *seulement*)</h2>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    Cette section n&#039;est plus pertinente depuis la version 1.3.0 du driver,
    et n&#039;est plus présente que dans un but d&#039;historisation de l&#039;information
    sur la façon dont la mise en file d&#039;attente fonctionne.
   </p>
   <p class="para">
    The latest versions of the driver have no concept of pooling anymore and
    will maintain only one connection per process, for each connection type
    (ReplicaSet/standalone/mongos), for each credentials combination.
   </p>
  </p></blockquote>
  <p class="para">
   La création de connexions est une des actions les plus lourdes réalisées
   par le driver. Cela peut prendre plusieurs millisecondes pour définir correctement
   une connexion, y compris sur un réseau rapide. Aussi, le driver tente de
   minimiser le nombre de nouvelles connexions créées en réutilisant les connexions
   depuis la file d&#039;attente.
  </p>
  <p class="para">
   Lorsqu&#039;un utilisateur crée une nouvelle instance de la clase
   <a href="class.mongoclient.html" class="classname">MongoClient</a>, toutes les connexions nécessaires seront
   prises depuis leurs files d&#039;attente (les connexions pour le jeu de réplication
   peuvent nécessiter plusieurs connexions, une pour chaque membre du jeu).
   Lorsque l&#039;instance de la classe <a href="class.mongoclient.html" class="classname">MongoClient</a> sort du scope,
   les connexions seront remises dans la file d&#039;attente. Lorsque le processus PHP
   existe, toutes les connexions de la file d&#039;attente seront fermées.
  </p>
  <div class="section">
   <h2 class="title">&quot;Pourquoi dois-je avoir autant de connexions ouvertes ?&quot;</h2>
   <p class="para">
    La file d&#039;attente de connexions peut générer un nombre important de connexions.
    Ceci est voulu, et, en utilisant un peu d&#039;arithmétique, vous pouvez trouver
    le nombre de connexions qui sera créée. Il y a 3 facteurs qui affectent le
    nombre de connexions :
   </p>
   <ul class="itemizedlist">
    <li class="listitem">
     <p class="para">
      <code class="literal">
       connections_per_pool
      </code>
     </p>
     <p class="para">
      Chaque file d&#039;attente de connexions, créera, par défaut, un nombre illimité
      de connexions. Cela peut poser quelques soucis : si la file peut créer un
      nombre illimité de connexions, peut-elle en créer des centaines et ainsi,
      dépasser les descripteurs de fichiers du serveur ? En pratique, ceci est
      peu probable, sachant que chaque connexion inutilisée est replacée dans
      la file d&#039;attente pour une réutilisation ultérieure, aussi, les futures
      connexions utiliseront la même connexion au lieu d&#039;en créer une nouvelle.
      Sauf si vous créez volontairement des milliers de connexions à la fois
      sans les laisser sortir du scope, le nombre de connexions ouvertes devrait
      rester à un niveau raisonnable.
     </p>
     <p class="para">
      Vous pouvez voir le nombre de connexions présentes dans la file d&#039;attente
      en utilisant la méthode <span class="function"><a href="mongopool.info.html" class="function">MongoPool::info()</a></span>.
      Ajouter les champs &quot;in use&quot; et &quot;in pool&quot; pour un serveur donné.
      Ce sera le nombre total de connexions pour cette file d&#039;attente.
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      <code class="literal">
       pools_per_process
      </code>
     </p>
     <p class="para">
      Chaque adresse de serveur MongoDB sur lequel vous vous connectez
      utilise sa propre file d&#039;attente de connexions. Par exemple, si votre nom
      d&#039;hôte local est &quot;example.net&quot;, une connexion à &quot;example.net:27017&quot;, &quot;localhost:27017&quot;,
      et &quot;/tmp/mongodb-27017.sock&quot; créera 3 files d&#039;attente de connexions. Vous pouvez voir
      le nombre de files d&#039;attentes de connexions ouvertes en utilisant la méthode
      <span class="function"><a href="mongopool.info.html" class="function">MongoPool::info()</a></span>.
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      <code class="literal">
       processes
      </code>
     </p>
     <p class="para">
      Chaque processus PHP a un jeu de files d&#039;attente séparées. PHP-FPM et Apache
      créent généralement entre 6 et une douzaine de fils. Vérifiez votre configuration
      pour voir le nombre maximal de processus PHP pouvant être engendrés.
     </p>
     <p class="para">
      Si vous utilisez PHP-FPM, le fait d&#039;estimer le nombre de connexions peut être
      délicat car le processus va engendrer encore plus de fils à forte charge.
      Pour rester dans un contexte sécurisé, regardez le paramètre <code class="literal">max_children</code>
      et ajoutez-y <code class="literal">spare_servers</code> + <code class="literal">start_servers</code> (choisissez
      le nombre le plus important). Le résultat sera le nombre de processus PHP (et donc, le nombre
      de jeux de files d&#039;attente) dont vous pourrez vous attendre.
     </p>
    </li>
   </ul>
   <p class="para">
    Les trois variables ci-dessus peuvent être multipliés ensemble pour fournir
    le nombre maximal de connexions attendues :
    <code class="literal">connections_per_pool</code> *
    <code class="literal">pools_per_process</code> *
    <code class="literal">processes</code>.  Notez
    que <code class="literal">connections_per_pool</code> peut être différent suivant les files
    d&#039;attente, aussi, <code class="literal">connections_per_pool</code> devrait être le maximal.
   </p>
   <p class="para">
    Par exemple, supposez que vous avez 30 connexions par files d&#039;attentes,
    10 files d&#039;attente par processus PHP, et 128 processus PHP. Alors, vous pouvez
    vous attendre à 38400 connexions depuis cette machine. Aussi, vous devriez
    définir la limite des descripteurs de fichiers de cette machine à une valeur
    suffisante pour gérer toutes ces connexions, ou alors les descripteurs de fichiers
    ne seront pas suffisants.
   </p>
   <p class="para">
    Voir la méthode <a href="class.mongopool.html" class="classname">MongoPool</a> pour plus d&#039;informations sur les
    files d&#039;attente de connexions.
   </p>
  </div>
 </div></div></div></body></html>