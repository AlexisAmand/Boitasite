<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Interrogation</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mongo.writes.html">« &Eacute;critures</a></li>
      <li style="float: right;"><a href="mongo.updates.html">Mises &agrave; jour »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mongo.manual.html">Manuel</a></li>
    <li>Interrogation</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mongo.queries" class="chapter">
 <h1>Interrogation</h1>

 
 <div class="simplesect" id="mongo.queries.secondaries">
  <h3 class="title">Distribution des requêtes aux secondaires</h3>
  
  <p class="para">
   Toutes les requêtes (en lecture et en écriture) ne sont envoyées qu&#039;au membre
   primaire du jeu de réplication par défaut. Ce comportement est cependant
   facilement configurable en utilisant les
   <a href="mongo.readpreferences.html" class="link">préférences de lecture</a> qui
   vous permettent de définir quelques préférences de lecture génériques (comme
   l&#039;autorisation des lectures sur un secondaire du serveur le plus proche),
   mais aussi fournissent une façon de spécifier un serveur précis, dans un pays
   spécifique, un centre de données précis, ou même un matériel donné, en utilisant
   les <a href="mongo.readpreferences.html#mongo.readpreferences.tagsets" class="link">tags des jeux de réplication</a>.
  </p>
  <p class="para">
   Les préférences de lecture peuvent être configurées à tous les niveaux du driver.
   <ul class="simplelist">
    <li class="member">Sous la forme d&#039;un paramètre ou d&#039;une option à <span class="methodname"><a href="mongoclient.construct.html" class="methodname">MongoClient::__construct()</a></span></li>
    <li class="member">Spécifiquement, en appelant la méthode <span class="methodname"><a href="mongoclient.setreadpreference.html" class="methodname">MongoClient::setReadPreference()</a></span></li>
    <li class="member">Au niveau de la base de données, avec la méthode <span class="methodname"><a href="mongodb.setreadpreference.html" class="methodname">MongoDB::setReadPreference()</a></span></li>
    <li class="member">Au niveau de la collection, avec la méthode <span class="methodname"><a href="mongocollection.setreadpreference.html" class="methodname">MongoCollection::setReadPreference()</a></span></li>
    <li class="member">Au niveau du curseur, avec la méthode <span class="methodname"><a href="mongocursor.setreadpreference.html" class="methodname">MongoCursor::setReadPreference()</a></span> ou la méthode <span class="methodname"><a href="mongocommandcursor.setreadpreference.html" class="methodname">MongoCommandCursor::setReadPreference()</a></span></li>
   </ul>
   Chaque classe hérite de la configuration des préférences de lecture de le contexte appelant.
  </p>
  <div class="example" id="mongo.connecting.context.ssl">
   <p><strong>Exemple #1 Héritage des préférences de lecture depuis le niveau de la base de données vers le curseur</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setReadPreference</span><span style="color: #007700">(</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">::</span><span style="color: #0000BB">RP_SECONDARY_PREFERRED</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">myCollection</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  <p class="para">
   Dans cet exemple, la requête sera exécutée sur un secondaire. La collection hérite de
   <strong><code>MongoClient::RP_SECONDARY_PREFERRED</code></strong> depuis la base de données,
   et le curseur en hérite de la collection.
  </p>
 </div>
 
 
 <div class="simplesect" id="mongo.queries.choosing.secondary">
  <h3 class="title">Comment les secondaires sont-ils choisis ?</h3>
  
  <p class="para">
   Chaque instance de <a href="class.mongoclient.html" class="classname">MongoClient</a> choisit son secondaire
   en utilisant le secondaire ayant le ping le moins élevé. Ainsi, si nous
   avons un client PHP en Europe et un en Australie et que nous
   avons un secondaire dans chacun de ces data-centers, nous pouvons faire :
  </p>
  <div class="example" id="mongo.connecting.context.ssl.verify">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$options&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"replicaSet"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"setName"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"readPreference"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">::</span><span style="color: #0000BB">RP_SECONDARY_PREFERRED</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;sur&nbsp;un&nbsp;client&nbsp;Australien<br /></span><span style="color: #0000BB">$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"mongodb://primary,australianhost.secondary,europeanhost.secondary"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">foo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bar</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getNext</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">"Lecture&nbsp;depuis&nbsp;:&nbsp;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">info</span><span style="color: #007700">()[</span><span style="color: #DD0000">"server"</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;sur&nbsp;un&nbsp;client&nbsp;européen<br /></span><span style="color: #0000BB">$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">(</span><span style="color: #DD0000">"mongodb://primary,australianhost.secondary,europeanhost.secondary"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$options</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">foo</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bar</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getNext</span><span style="color: #007700">();<br />echo&nbsp;</span><span style="color: #DD0000">"Lecture&nbsp;depuis&nbsp;:&nbsp;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cursor</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">info</span><span style="color: #007700">()[</span><span style="color: #DD0000">"server"</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher quelque chose de similaire à :</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
Lecture depuis : australianHost
Lecture depuis : europeanHost
</pre></div>
    </div>
    <div class="example-contents"><p>
     Notez que nous devons exécuter une requête avant qu&#039;un secondaire
     ne soit choisi : les secondaires sont choisis par le driver et pour
     chaque requête, séparément.
    </p></div>
   </div>
   
   <p class="para">
    Vous pouvez voir le choix du driver, en analysant le statut courant
    du membres du jeu, en exécutant la méthode <span class="methodname"><a href="mongoclient.gethosts.html" class="methodname">MongoClient::getHosts()</a></span> ou
    la méthode <span class="methodname"><a href="mongoclient.getconnections.html" class="methodname">MongoClient::getConnections()</a></span>.
   </p>
   
   <p class="para">
    Si aucun secondaire n&#039;est lisible, le driver enverra les lectures au primaire,
    tel que nous l&#039;avons spécifié avec
    <strong><code>MongoClient::RP_SECONDARY_PREFERRED</code></strong>, qui aura comme comportement
    de repli que d&#039;exécuter une requete sur un primaire, si aucune secondaire n&#039;est
    disponible. Un serveur est considéré comme lisible si son état vaut 2 (secondaire)
    et sa santé vaut 1. Vous pouvez vérifier cela avec les méthodes
    <span class="methodname"><a href="mongoclient.gethosts.html" class="methodname">MongoClient::getHosts()</a></span> et
    <span class="methodname"><a href="mongoclient.getconnections.html" class="methodname">MongoClient::getConnections()</a></span>.
   </p>
   
 </div>
 <div class="simplesect" id="mongo.queries.notes">
  <h3 class="title">Diverses notes</h3>
   
   <p class="para">
    Les écritures sont toujours envoyées au serveur principal et par défaut,
    toutes les lectures sont aussi envoyées au primaire.
   </p>
   
 </div>
 
 
 <div class="simplesect" id="mongo.queries.querying">
  <h3 class="title">Interrogation sur un _id</h3>
  <p class="para">
   Chaque objet inséré se voit assigné automatiquement un champ unique <code class="literal">_id</code>,
   qui est bien utile pour être utilisé dans les requêtes. Ceci fonctionne de façon
   similaire à la fonctionalité &quot;donne moi le dernier ID inséré&quot;, excepté que
   <code class="literal">_id</code> est choisi par le <em class="emphasis">client</em>.
  </p>
 <p class="para">
  Supposez que vous voulez trouver un document que vous venez tout juste d&#039;insérer.
  L&#039;insertion ajoute un champ <code class="literal">_id</code> au document, aussi, vous pouvez
  effectuer votre requête de la sorte :
  
  <div class="example" id="mongo.connecting.context.ssl.certificate">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$person&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"name"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joe"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;Maintenant,&nbsp;$joe&nbsp;a&nbsp;un&nbsp;champ&nbsp;_id<br /></span><span style="color: #0000BB">$joe&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$person</span><span style="color: #007700">[</span><span style="color: #DD0000">'_id'</span><span style="color: #007700">]));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   Tant que l&#039;utilisateur ne l&#039;a pas spécifié autrement, le champ <code class="literal">_id</code>
   est un <a href="class.mongoid.html" class="classname">MongoId</a>. L&#039;erreur la plus courante
   est d&#039;essayer d&#039;utiliser une chaîne qui correspond à un
   <a href="class.mongoid.html" class="classname">MongoId</a>. Gardez à l&#039;esprit que cet identifiant
   a 2 types de données différents, et ne correspond pas l&#039;un l&#039;autre,
   de la même façon que la chaîne &quot;array()&quot; n&#039;est pas la même chose
   qu&#039;un tableau vide. Par exemple :
   
   <div class="example" id="mongo.connecting.authenticate.ssl.x509">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$person&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"name"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joe"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;Conversion&nbsp;de&nbsp;l'_id&nbsp;en&nbsp;une&nbsp;chaîne<br /></span><span style="color: #0000BB">$pid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$person</span><span style="color: #007700">[</span><span style="color: #DD0000">'_id'</span><span style="color: #007700">]&nbsp;.&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;ECHEC&nbsp;-&nbsp;$pid&nbsp;est&nbsp;une&nbsp;chaîne,&nbsp;et&nbsp;non&nbsp;un&nbsp;MongoId<br /></span><span style="color: #0000BB">$joe&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$people</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"_id"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$pid</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 <div class="simplesect" id="mongo.queries.arrays">
  <h3 class="title">Les tableaux</h3>
  <p class="para">
   Les tableaux sont spéciaux à plus d&#039;un titre. Tout d&#039;abord, il y a 2 types
   utilisés par MongoDB : des tableaux &quot;normaux&quot; et des tableaux associatifs.
   Les tableaux associatifs peuvent avoir plusieurs types de clés et de valeurs.
   Les tableaux &quot;normaux&quot; sont définis comme tableaux dans ces indices numériques
   ascendants, en commençant par 0 et s&#039;incrémentant de 1 pour chaque élément.
   Ces 2 types correspondent à ce que vous connaissez déjà comme type en PHP.
  </p>
  
  <p class="para">
   Actuellement, si vous voulez sauvegarder la liste des récompenses
   dans un document, vous pouvez :
  </p>

  <div class="example" id="mongo.connecting.auth-example">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"silver"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"bronze"</span><span style="color: #007700">)));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  
 <p class="para">
  Les requêtes peuvent effectuer des recherches directement dans les éléments.
  Supposez que nous souhaitons trouver tous les documents dont l&#039;élément du
  tableau est à une valeur fournie. Par exemple, les documents dont la
  récompense est l&#039;or, comme ceci :
 </p>
  
 <div class="example-contents screen">
<div class="cdata"><pre>
{ &quot;_id&quot; : ObjectId(&quot;4b06c282edb87a281e09dad9&quot;), &quot;awards&quot; : [&quot;gold&quot;, &quot;silver&quot;, &quot;bronze&quot;]}
</pre></div>
 </div>
  
 <p class="para">
  Ceci peut être effectué avec une requête simple, en ignorant le fait que &quot;awards&quot;
  est un tableau :
 </p>
  
 <div class="example" id="mongo.connecting.auth-db-example">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 
 <p class="para">
  Supposez que vous interrogiez la base de données avec un objet plus complexe,
  dont chaque élément du tableau sont eux-mêmes des objets, comme ceci :
 </p>
 
 <div class="example-contents screen">
<div class="cdata"><pre>
{ 
     &quot;_id&quot; : ObjectId(&quot;4b06c282edb87a281e09dad9&quot;), 
     &quot;awards&quot; : 
     [
        {
            &quot;first place&quot; : &quot;gold&quot;
        },
        {
            &quot;second place&quot; : &quot;silver&quot; 
        },
        {
            &quot;third place&quot; :  &quot;bronze&quot;
        }
     ]
}
</pre></div>
 </div>
  
 <p class="para">
  Continuons d&#039;ignorer que c&#039;est un tableau. Nous pouvons utiliser
  la notation basée sur les points pour interroger le sous-objet :
 </p>
  
   <div class="example" id="mongo.connecting.rs-example">
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards.first&nbsp;place"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 <p class="para">
  Notez qu&#039;il importe peu qu&#039;il y ait un espace dans le nom du champ
  (bien qu&#039;il convient de ne pas en mettre, juste pour rendre le code
  plus lisible).
 </p>
 
 <p class="para">
  Vous pouvez également utiliser un tableau contenant plusieurs valeurs
  à chercher. Actuellement, si nous cherchons les documents &quot;gold&quot; et &quot;copper&quot;,
  nous pouvons le faire comme ceci :
 </p>

  <div class="example" id="mongo.connecting.rs-example-wrong-replset">
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$cursor&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">find</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"awards"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">'$in'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"gold"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"copper"</span><span style="color: #007700">))));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </div>

 <div class="simplesect">
  <h3 class="title">Historique</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>Version</th>
      <th>Description</th>
     </tr>

    </thead>

    <tbody class="tbody">

     <tr>
      <td>1.3.0</td>
      <td>
       Introduction du framework pour les <a href="mongo.readpreferences.html" class="link">préférence
       de lecture</a> permettant une contrôle fin des lectures sur les secondaires.
      </td>
     </tr>

     <tr>
      <td>1.3.0</td>
      <td>
       L&#039;utilisation de <code class="literal">slaveOkay</code> devient obsolète ; l&#039;alternative est <a href="mongo.readpreferences.html" class="link">les préférences de lecture</a>.
      </td>
     </tr>

     <tr>
      <td>1.1.0</td>
      <td>
       Introduction de la possibilité de router les lectures vers les secondaires
       des membres du jeu de réplication, en utilisant la méthode
       <span class="methodname"><a href="mongo.setslaveokay.html" class="methodname">Mongo::setSlaveOkay()</a></span>.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>

</div>
</div></div></body></html>