<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>S&eacute;curit&eacute; des fichiers</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="security.sessions.html">« S&eacute;curit&eacute; des Sessions</a></li>
      <li style="float: right;"><a href="security.filesystem.nullbytes.html">Issue lors de l'utilisation des octets nuls »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="security.html">S&eacute;curit&eacute;</a></li>
    <li>S&eacute;curit&eacute; des fichiers</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="security.filesystem" class="chapter">
 <h1>Sécurité des fichiers</h1>
<h2>Sommaire</h2><ul class="chunklist chunklist_chapter"><li><a href="security.filesystem.nullbytes.html">Issue lors de l'utilisation des octets nuls</a></li></ul>

 <p class="simpara">
  <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> est soumis aux règles de sécurité
  intrinsèques de la plupart des systèmes serveurs :
  il respecte notamment les droits des fichiers et des dossiers.
  Une attention particulière doit être portée aux
  fichiers ou dossiers qui sont accessibles à tout le monde, afin de
  s&#039;assurer qu&#039;ils ne divulguent pas d&#039;informations critiques.
 </p>
 <p class="simpara">
  Puisque <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> a été fait pour permettre aux utilisateurs
  d&#039;accéder aux fichiers, il est possible de créer un
  script <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> qui vous permet de lire des fichiers tels que /etc/password,
  de modifier les connexions ethernet, lancer des impressions de documents,
  etc. Cela implique notamment que vous devez vous assurer que les fichiers
  manipulés par les scripts sont bien ceux qu&#039;il faut.
 </p>
 <p class="simpara">
  Considérez le script suivant, où l&#039;utilisateur indique
  qu&#039;il souhaite effacer un fichier dans son dossier racine. Nous
  supposons que <acronym title="PHP: Hypertext Preprocessor">PHP</acronym> est utilisé comme interface web pour
  gérer les fichiers, et que l&#039;utilisateur Apache est
  autorisé à effacer les fichiers dans le dossier racine des
  utilisateurs.
 </p>
 <p class="para">
  <div class="example" id="context.zip.example-password">
   <p><strong>Exemple #1 Une erreur de vérification de variable conduit à un gros problème</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;Efface&nbsp;un&nbsp;fichier&nbsp;dans&nbsp;un&nbsp;dossier&nbsp;racine<br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$userfile&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$homedir&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br />echo&nbsp;</span><span style="color: #DD0000">"Ce&nbsp;fichier&nbsp;a&nbsp;été&nbsp;effacé&nbsp;!"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  Étant donné que le nom de l&#039;utilisateur et le nom du fichier sont fournis, des intrus peuvent
  envoyer un nom d&#039;utilisateur et un nom de fichier autres que les leurs, et effacer des
  documents dans les comptes des autres utilisateurs.
  Dans ce cas, vous souhaiterez utiliser une autre forme d&#039;identification.
  Considérez ce qui pourrait se passer si les utilisateurs passent
  <code class="literal">../etc/</code> et <code class="literal">passwd</code> comme arguments!
  Le code serait exécuté tel que :
  <div class="example" id="wrappers.http.example.basic">
   <p><strong>Exemple #2 Une attaque du système de fichiers!</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;efface&nbsp;un&nbsp;fichier&nbsp;n'importe&nbsp;où&nbsp;sur&nbsp;le&nbsp;disque&nbsp;dur,<br />//&nbsp;où&nbsp;l'utilisateur&nbsp;PHP&nbsp;a&nbsp;accès.&nbsp;Si&nbsp;PHP&nbsp;a&nbsp;un&nbsp;accès&nbsp;root&nbsp;:<br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_name'</span><span style="color: #007700">];&nbsp;</span><span style="color: #FF8000">//&nbsp;"../etc"<br /></span><span style="color: #0000BB">$userfile&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];&nbsp;</span><span style="color: #FF8000">//&nbsp;"passwd"<br /></span><span style="color: #0000BB">$homedir&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;"/home/../etc"<br /><br /></span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;"/home/../etc/passwd"<br /><br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #DD0000">"Ce&nbsp;fichier&nbsp;a&nbsp;été&nbsp;effacé&nbsp;!"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  Il y a deux mesures primordiales à prendre pour éviter
  ces manoeuvres :
  <ul class="itemizedlist">
   <li class="listitem">
    <span class="simpara">
     Limiter les permissions de l&#039;utilisateur web <acronym title="PHP: Hypertext Preprocessor">PHP</acronym>.
    </span>
   </li>
   <li class="listitem">
    <span class="simpara">
     Vérifier toutes les variables liées aux chemins et aux fichiers
     qui sont fournis.
    </span>
   </li>
  </ul>
  Voici un script renforcé :
  <div class="example" id="example-378">
   <p><strong>Exemple #3 Une vérification renforcée</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;Efface&nbsp;un&nbsp;fichier&nbsp;sur&nbsp;le&nbsp;disque&nbsp;où&nbsp;l'utilisateur&nbsp;a&nbsp;le&nbsp;droit&nbsp;d'aller<br /></span><span style="color: #0000BB">$username&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">];&nbsp;</span><span style="color: #FF8000">//&nbsp;utilisation&nbsp;d'un&nbsp;mécanisme&nbsp;d'identification<br /></span><span style="color: #0000BB">$userfile&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">basename</span><span style="color: #007700">(</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">]);<br /></span><span style="color: #0000BB">$homedir&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$filepath&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br />if&nbsp;(</span><span style="color: #0000BB">file_exists</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">)&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filepath</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$logstring&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">&nbsp;effacé\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$logstring&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"Échec&nbsp;lors&nbsp;de&nbsp;l'effacement&nbsp;de&nbsp;</span><span style="color: #0000BB">$filepath</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/home/logging/filedelete.log"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"a"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br />echo&nbsp;</span><span style="color: #0000BB">htmlentities</span><span style="color: #007700">(</span><span style="color: #0000BB">$logstring</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">ENT_QUOTES</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  Cependant, même cette technique n&#039;est pas sans faille.
  Si votre système d&#039;identification permet aux utilisateurs
  de créer leur propre login, et qu&#039;un utilisateur choisi
  le login <code class="literal">../etc/</code>, le système est de nouveau exposé. Pour
  cette raison, vous pouvez essayez d&#039;écrire un script renforcé :
  <div class="example" id="example-379">
   <p><strong>Exemple #4 Vérification renforcée de noms de fichiers</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$username&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_SERVER</span><span style="color: #007700">[</span><span style="color: #DD0000">'REMOTE_USER'</span><span style="color: #007700">];&nbsp;</span><span style="color: #FF8000">//&nbsp;utilisation&nbsp;d'un&nbsp;mécanisme&nbsp;d'identification<br /></span><span style="color: #0000BB">$userfile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$_POST</span><span style="color: #007700">[</span><span style="color: #DD0000">'user_submitted_filename'</span><span style="color: #007700">];<br /></span><span style="color: #0000BB">$homedir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"/home/</span><span style="color: #0000BB">$username</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$filepath&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$homedir</span><span style="color: #DD0000">/</span><span style="color: #0000BB">$userfile</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br /><br />if&nbsp;(!</span><span style="color: #0000BB">ctype_alnum</span><span style="color: #007700">(</span><span style="color: #0000BB">$username</span><span style="color: #007700">)&nbsp;||&nbsp;!</span><span style="color: #0000BB">preg_match</span><span style="color: #007700">(</span><span style="color: #DD0000">'/^(?:[a-z0-9_-]|\.(?!\.))+$/iD'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$userfile</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">"Mauvais&nbsp;utilisateur/nom&nbsp;de&nbsp;fichier"</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">//etc...<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </p>
 <p class="para">
  Suivant votre système d&#039;exploitation, vous devrez protéger
  un grand nombre de fichiers, notamment les entrées de périphériques,
  (<code class="literal">/dev/</code> ou <code class="literal">COM1</code>), les fichiers de
  configuration (fichiers <code class="literal">/etc/</code> et
  <code class="literal">.ini</code>), les lieux de stockage d&#039;informations
  (<code class="literal">/home/</code>, <code class="literal">My Documents</code>), etc.
  Pour cette raison, il est généralement plus sûr d&#039;établir une
  politique qui interdit TOUT sauf ce que vous autorisez.
 </p>
 
</div>
</div></div></body></html>