<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Partitionnement et fragmentation</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.quickstart.failover.html">« Failover</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.quickstart.mysql_fabric.html">MySQL Fabric »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.quickstart.html">Exemples et d&eacute;marrage rapide</a></li>
    <li>Partitionnement et fragmentation</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.quickstart.partitioning" class="section">
  <h2 class="title">Partitionnement et fragmentation</h2>
  <p class="para">
   Les clusters de base de données sont mis en place pour plusieurs raisons.
   Les clusters peuvent améliorer la disponibilité, la tolérance aux pannes
   mais aussi améliorer les performances en suivant une approche du type
   &quot;diviser pour mieux reigner&quot;, sachant que le travail est distribué sur plusieurs
   machines. Le clustering est quelques fois combiné avec le partitionnement
   et la fragmentation pour ensuite diviser une énorme tâche complexe en
   des tâches plus petites et donc plus gérables.
  </p>
  <p class="para">
   Le plugin mysqlnd_ms a été conçu pour supporter une grande variété de clusters
   de base de données MySQL. Certaines sortes de clusters de bases de données
   ont des méthodes internes pour le partitionnement et la fragmentation,
   les rendant ainsi transparentes à l&#039;utilisation : le filtrage sur les tables
   de réplication MySQL, et la fragmentation (application basée sur le partitionnement).
  </p>
  <p class="para">
   La réplication MySQL supporte le partitionnement sous la forme de filtres
   qui vous permettent de créer des esclaves qui répliquent toutes les bases de
   données ou une seule base de données (ou des tables) du maîtres. Il est ensuite
   de la responsabilité de l&#039;application de choisir un esclabe suivant les règles
   du filtre. Vous pouvez utiliser soit le filtre
   mysqlnd_ms <code class="literal"><a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.filter-node-groups" class="link">node_groups</a></code>
   pour supporter manuellement ce comportement, ou utiliser le filtre de table expérimental.
  </p>
  <p class="para">
   Le partitionnement ou la fragmentation manuelle est supporté via le filtre de groupage
   des noeuds, ainsi qu&#039;avec les astuces SQL depuis la version 1.5.0. Le filtre
   node_groups vous permet d&#039;assigner un nom symbolique à un groupe de serveurs maîtres ou esclabes.
   Dans l&#039;exemple, le maître <code class="literal">master_0</code> et <code class="literal">slave_0</code>
   forment un groupe dont le nom est <code class="literal">Partition_A</code>. Il est ensuite
   entièrement de votre responsabilité que de décider le contenu du groupe. Par exemple,
   vous pouvez utiliser des groupes de noeuds pour la fragmentation, et utiliser
   les noms des groupes pour adresse une fragmentation comme
   like <code class="literal">Shard_A_Range_0_100</code>.
  </p>
  <p class="para">
   <div class="example" id="example-2196">
    <p><strong>Exemple #1 Cluster de groupes de noeuds</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
  &quot;myapp&quot;: {
       &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;simulate_slave_failure&quot;,
                &quot;port&quot;: &quot;0&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;127.0.0.1&quot;,
                &quot;port&quot;: 3311
            }
        },
        &quot;filters&quot;: {
            &quot;node_groups&quot;: {
                &quot;Partition_A&quot; : {
                    &quot;master&quot;: [&quot;master_0&quot;],
                    &quot;slave&quot;: [&quot;slave_0&quot;]
                }
            },
           &quot;roundrobin&quot;: []
        }
    }
}</pre>
</div>
    </div>

  </div>
  </p>
  <p class="para">
   <div class="example" id="example-2197">
    <p><strong>Exemple #2 Partitionnement manuelle en utilisant des astuces SQL</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$msg</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$hint&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Note&nbsp;:&nbsp;test&nbsp;faible,&nbsp;deux&nbsp;connexions&nbsp;vers&nbsp;deux&nbsp;serveurs&nbsp;peuvent&nbsp;avoir&nbsp;le&nbsp;même&nbsp;identifiant&nbsp;de&nbsp;thread&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;CONNECTION_ID()&nbsp;AS&nbsp;_thread,&nbsp;'%s'&nbsp;AS&nbsp;_hint&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$msg</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$hint</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$hint&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%d&nbsp;-&nbsp;%s&nbsp;-&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_thread'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_hint'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;évidemment,&nbsp;votre&nbsp;gestionnaire&nbsp;d'erreurs&nbsp;est&nbsp;meilleur...&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Tous&nbsp;les&nbsp;esclaves&nbsp;sont&nbsp;autorisés&nbsp;*/<br /></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"slave_0"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"slave_1"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;seuls&nbsp;les&nbsp;serveurs&nbsp;du&nbsp;groupe&nbsp;de&nbsp;noeuds&nbsp;"Partition_A"&nbsp;sont&nbsp;autorisés&nbsp;*/<br /></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"slave_1"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"/*Partition_A*/"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"slave_1"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"/*Partition_A*/"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents screen">
<div class="cdata"><pre>
6804 - slave_0 - SELECT CONNECTION_ID() AS _thread, &#039;slave1&#039; AS _hint FROM DUAL
2442 - slave_1 - SELECT CONNECTION_ID() AS _thread, &#039;slave2&#039; AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, &#039;slave1&#039; AS _hint FROM DUAL
6804 - slave_0 - /*Partition_A*/SELECT CONNECTION_ID() AS _thread, &#039;slave1&#039; AS _hint FROM DUAL
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Par défaut, le plugin utilisera tous les serveurs maîtres et esclaves configurés
   pour l&#039;exécution de la requête. Mais si une requête commence avec une astuce SQL
   comme <code class="literal">/*node_group*/</code>, le plugin ne va considérer que les serveurs
   listés dans le <code class="literal">node_group</code> lors de l&#039;exécution de la requête.
   Aussi, les requêtes de type <code class="literal">SELECT</code> préfixées avec
   <code class="literal">/*Partition_A*/</code> seront exécutées uniquement sur
   <code class="literal">slave_0</code>.
  </p>
  
 </div></div></div></body></html>