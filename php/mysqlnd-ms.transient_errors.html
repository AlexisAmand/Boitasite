<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Les erreurs passag&egrave;res</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.errorhandling.html">« Gestion des erreurs</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.failover.html">Gestion des incidents (Failover) »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.concepts.html">Concepts</a></li>
    <li>Les erreurs passag&egrave;res</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.transient_errors" class="section">
  <h2 class="title">Les erreurs passagères</h2>
  <p class="para">
   Quelques clusters de bases de données utilisent les erreurs passagères.
   Une erreur passagère est une erreur temporaire qui normalement doit
   disparaître rapidement. Par définition, il est sécurisé pour un client
   d&#039;ignorer une erreur passagère et de re-tenter l&#039;opération en échec
   sur le même serveur de base de données. La nouvelle tentative n&#039;a
   aucun effet secondaire. Les clients ne sont pas obligés de stopper
   leurs travaux ou de basculer sur un autre serveur de base de données
   immédiatement. Ils doivent plutôt entrer dans une boucle de tentatives
   pour attendre que l&#039;erreur disparaisse avant d&#039;abandonner le serveur de
   base de données au profit d&#039;un autre. Les erreurs passagères peuvent
   être observées, par exemple, lors de l&#039;utilisation d&#039;un cluster MySQL.
   Mais elles ne sont pas liées à une solution de clusters spécifique.
  </p>
  <p class="para">
   <code class="literal">PECL/mysqlnd_ms</code> peut lancer une boucle de tentatives
   automatiquement dans le cas d&#039;erreurs passagères. Ce mécanisme permet de rendre
   encore plus transparent la distribution, et ainsi, rend simple la migration
   d&#039;une application fonctionnant sur un seul serveur de base de données sur
   un cluster de serveurs de bases de données sans avoir à changer le source
   de l&#039;application.
  </p>
  <p class="para">
   La boucle de tentatives automatique va répéter l&#039;opération demandée
   autant de fois que le nombre configuré, et effectuera une pause entre
   les tentatives pendant une durée configurée. Si l&#039;erreur disparaît pendant
   la boucle, l&#039;application ne la verra jamais. Sinon, l&#039;erreur sera envoyée
   à l&#039;application afin qu&#039;elle la gère.
  </p>
  <p class="para">
   Dans l&#039;exemple ci-dessous, une erreur concernant une clé dupliquée
   est provoquée pour que le plugin entre dans un cycle de deux nouvelles
   tentatives avant de passer l&#039;erreur à l&#039;application. Entre les deux
   tentatives, le plugin va attendre 100 millisecondes.
  </p>
  <p class="para">
   <div class="example" id="example-2204">
    <p><strong>Exemple #1 Provoque une erreur passagère</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1</pre>
</div>
    </div>

    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
       },
       &quot;transient_error&quot;: {
          &quot;mysql_error_codes&quot;: [
            1062
          ],
          &quot;max_retries&quot;: 2,
          &quot;usleep_retry&quot;: 100
       }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-2205">
    <p><strong>Exemple #2 Boucle de tentative pour une erreur passagère</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;évidemment,&nbsp;votre&nbsp;gestionnaire&nbsp;d'erreurs&nbsp;est&nbsp;bien&nbsp;meilleur...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br />if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test"</span><span style="color: #007700">)&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT&nbsp;PRIMARY&nbsp;KEY)"</span><span style="color: #007700">)&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1))"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;La&nbsp;boucle&nbsp;de&nbsp;tentatives&nbsp;est&nbsp;totalement&nbsp;transparente.<br />&nbsp;&nbsp;&nbsp;La&nbsp;vérification&nbsp;des&nbsp;statistiques&nbsp;est&nbsp;la&nbsp;seule&nbsp;façon&nbsp;de<br />&nbsp;&nbsp;&nbsp;voir&nbsp;les&nbsp;tentatives&nbsp;implicites&nbsp;*/<br /></span><span style="color: #0000BB">$stats&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Tentatives&nbsp;sur&nbsp;l'erreur&nbsp;passagère&nbsp;avant&nbsp;de&nbsp;lancer&nbsp;l'erreur&nbsp;:&nbsp;%d\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">[</span><span style="color: #DD0000">'transient_error_retries'</span><span style="color: #007700">]);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Provoque&nbsp;une&nbsp;erreur&nbsp;concernant&nbsp;une&nbsp;clé&nbsp;dupliquée&nbsp;pour&nbsp;voir&nbsp;les&nbsp;statistiques&nbsp;changer&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1))"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$stats&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Tentatives&nbsp;sur&nbsp;l'erreur&nbsp;passagère&nbsp;après&nbsp;le&nbsp;lancement&nbsp;de&nbsp;l'erreur&nbsp;:&nbsp;%d\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$stats</span><span style="color: #007700">[</span><span style="color: #DD0000">'transient_error_retries'</span><span style="color: #007700">]);<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher quelque chose de similaire à :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Tentatives sur l&#039;erreur passagère avant de lancer l&#039;erreur : 0
[1062] Duplicate entry &#039;1&#039; for key &#039;PRIMARY&#039;
Tentatives sur l&#039;erreur passagère après le lancement de l&#039;erreur : 2
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   En raison du fait de l&#039;exécution transparente d&#039;un point de vue utilisateur
   de la boucle de tentatives, l&#039;exemple vérifie les
   <a href="function.mysqlnd-ms-get-stats.html" class="link">statistiques</a> fournies par
   le plugin pour en savoir plus.
  </p>
  <p class="para">
   Comme l&#039;exemple le montre, le plugin peut considérer toutes les erreurs
   comme passagères au regard de la sémantique des erreurs des serveurs
   de base de données. La seule erreur que le serveur MySQL considère comme
   temporaire est l&#039;erreur code <strong><code>1297</code></strong>. Lorsque vous configurez
   d&#039;autres codes erreurs autre que la <strong><code>1297</code></strong>, assurez-vous
   que votre configuration reflète la sémantique des codes erreurs de votre cluster.
  </p>
  <p class="para">
   Les appels mysqlnd C API suivants sont surveillés par le plugin pour vérifier
   les erreurs passagères : <code class="literal">query()</code>,
   <code class="literal">change_user()</code>, <code class="literal">select_db()</code>,
   <code class="literal">set_charset()</code>, <code class="literal">set_server_option()</code>
   <code class="literal">prepare()</code>, <code class="literal">execute()</code>,
   <code class="literal">set_autocommit()</code>,
   <code class="literal">tx_begin()</code>, <code class="literal">tx_commit()</code>,
   <code class="literal">tx_rollback()</code>, <code class="literal">tx_commit_or_rollback()</code>.
   Les appels API utilisateur ont des noms similaires.
  </p>
  <p class="para">
   La durée d&#039;attente du plugin entre plusieurs tentatives dans la boucle
   dépend de la fonction en question. Dans une boucle de tentative pour
   <code class="literal">query()</code>, <code class="literal">prepare()</code> ou <code class="literal">execute()</code>,
   la durée d&#039;attente sera <code class="literal">max_retries * usleep_retry</code> millisecondes.
  </p>
  <p class="para">
   Cependant, les fonctions qui
   <a href="mysqlnd-ms.pooling.html" class="link">contrôle le statut de la connexion</a>
   sont dispatchées pour toutes les connexions. La configuration de la boucle
   de tentative est appliquée à chaque connexion sur laquelle la commande est exécutée.
   Aussi, une fonction peut interrompre l&#039;exécution du programme plus longtemps qu&#039;une
   fonction qui est exécutée sur un seul serveur. Par exemple, <code class="literal">set_autocommit()</code>
   est dispatché sur l&#039;ensemble des connexions, et peut attendre
   <code class="literal">(max_retries * usleep_retry) * nombre_de_connexions_ouvertes)</code>
   millisecondes. Veuillez garder cela à l&#039;esprit lorsque vous définissez une durée
   élevée ainsi qu&#039;un grand nombre de tentatives. L&#039;utilisation de la configuration
   par défaut (<code class="literal">max_retries=1</code>, <code class="literal">usleep_retry=100</code> et
   <code class="literal">lazy_connections=1</code>) est vivement conseillé, car vous n&#039;aurez jamais
   de délai supérieur à 1 seconde.
  </p>
 </div></div></div></body></html>