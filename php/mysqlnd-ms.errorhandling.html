<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Gestion des erreurs</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

 </head>
 <body class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqlnd-ms.transaction.html">« Gestion des transactions locales</a></li>
      <li style="float: right;"><a href="mysqlnd-ms.transient_errors.html">Les erreurs passag&egrave;res »</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="mysqlnd-ms.concepts.html">Concepts</a></li>
    <li>Gestion des erreurs</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqlnd-ms.errorhandling" class="section">
  <h2 class="title">Gestion des erreurs</h2>
  <p class="para">
   Les applications utilisant PECL/mysqlnd_ms doivent gérer proprement
   les erreurs pouvant survenir de tous les appels API utilisateur.
   En raison du fait que le plugin modifie la sémantique d&#039;un gestionnaire
   de connexion, les appels API peuvent retourner des erreurs inattendues.
   Si vous utilisez le plugin, un gestionnaire de connexion ne représente
   plus une connexion réseau individuelle mais un groupe de connexions.
   Un code erreur et un message d&#039;erreur peuvent être définis sur le gestionnaire
   de connexion, que l&#039;erreur survienne sur n&#039;importe quelle connexion
   réseau du groupe.
  </p>
  <p class="para">
   Si vous utilisez les connexions paresseuses, (ce qui est le comportement
   par défaut), les connexions ne sont pas ouvertes tant qu&#039;elle n&#039;est pas
   nécessaire pour l&#039;exécution d&#039;une requête. Toutefois, il peut survenir
   qu&#039;un appel API pour l&#039;exécution d&#039;une requête retourne une erreur
   de connexion. Dans l&#039;exemple suivant, une erreur est provoquée lorsque
   l&#039;on tente d&#039;exécuter une requête sur un esclave. L&#039;ouverture de la
   connexion esclave échoue car le fichier de configuration du plugin
   liste un nom d&#039;hôte invalide pour l&#039;esclave.
  </p>
  <p class="para">
   <div class="example" id="example-2200">
    <p><strong>Exemple #1 On provoque une erreur de connexion</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;invalid_host_name&quot;,
            }
        },
        &quot;lazy_connections&quot;: 1
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   L&#039;activation explicite des connexions paresseuses est effectuée ici
   que dans un but de démonstration.
  </p>
  <p class="para">
   <div class="example" id="example-2201">
    <p><strong>Exemple #2 Erreur de connexion sur l&#039;exécution d&#039;une requête</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Bien&nbsp;sûr,&nbsp;votre&nbsp;gestion&nbsp;des&nbsp;erreurs&nbsp;est&nbsp;bien&nbsp;meilleure...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion&nbsp;1,&nbsp;la&nbsp;connexion&nbsp;lie&nbsp;la&nbsp;variable&nbsp;SQL&nbsp;;&nbsp;ce&nbsp;n'est&nbsp;pas&nbsp;un&nbsp;SELECT,&nbsp;la&nbsp;requête&nbsp;sera&nbsp;donc&nbsp;exécuté&nbsp;sur&nbsp;le&nbsp;maître&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SET&nbsp;@myrole='master'"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion&nbsp;2,&nbsp;exécution&nbsp;sur&nbsp;l'esclave&nbsp;car&nbsp;SELECT&nbsp;provoque&nbsp;une&nbsp;erreur&nbsp;de&nbsp;connexion&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;@myrole&nbsp;AS&nbsp;_role"</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}&nbsp;else&nbsp;{<br />&nbsp;</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"@myrole&nbsp;=&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_role'</span><span style="color: #007700">]);<br />}<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher quelque chose de similaire à :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
[2002] php_network_getaddresses: getaddrinfo failed: Name or service not known
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Les applications doivent être capables de gérer les erreurs de connexions.
   au moyen d&#039;un gestionnaire d&#039;erreurs correct.
  </p>
  <p class="para">
   Suivant le cas rencontré, les applications peuvent vouloir gérer les erreurs
   de connexions différemment des autres erreurs. Typiquement, les erreurs
   de connexions sont
   <code class="literal">2002 (CR_CONNECTION_ERROR) - Can&#039;t connect to local MySQL server through socket &#039;%s&#039; (%d)</code>,
   <code class="literal">2003 (CR_CONN_HOST_ERROR) - Can&#039;t connect to MySQL server on &#039;%s&#039; (%d)</code> et
   <code class="literal">2005 (CR_UNKNOWN_HOST) - Unknown MySQL server host &#039;%s&#039; (%d)</code>.
   Par exemple, l&#039;application doit tester les codes erreurs et manuellement exécuter
   une fonction appropriée. La philosophie du plugin n&#039;est pas d&#039;offrir
   de fonction adéquate lors d&#039;un échec du maître, car ces échecs ne sont
   pas des opérations transparentes.
  </p>
  <p class="para">
   <div class="example" id="example-2202">
    <p><strong>Exemple #3 On provoque une erreur de connexion</strong></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;invalid_host_name&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;
            }
        },
        &quot;lazy_connections&quot;: 1,
        &quot;filters&quot;: {
            &quot;roundrobin&quot;: [

            ]
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   L&#039;activation explicite des connexions paresseuses est effectuée ici
   uniquement dans un but démonstratif. Notez que la balance de charge
   round robin est utilisée en lieu et place de la méthode par défaut
   <code class="literal">random once</code>
  </p>
  <p class="para">
   <div class="example" id="example-2203">
    <p><strong>Exemple #4 Échec les plus courants</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Évidemment,&nbsp;votre&nbsp;gestionnaire&nbsp;d'erreur&nbsp;est&nbsp;bien&nbsp;meilleur...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion&nbsp;1,&nbsp;la&nbsp;connexion&nbsp;lie&nbsp;la&nbsp;variable&nbsp;SQL&nbsp;user&nbsp;;&nbsp;pas&nbsp;de&nbsp;SELECT,&nbsp;la&nbsp;requête&nbsp;peut&nbsp;se&nbsp;faire&nbsp;sur&nbsp;le&nbsp;maître&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SET&nbsp;@myrole='master'"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;Connexion&nbsp;2,&nbsp;d'abord,&nbsp;sur&nbsp;l'esclave&nbsp;*/<br /></span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;VERSION()&nbsp;AS&nbsp;_version"</span><span style="color: #007700">);<br /></span><span style="color: #FF8000">/*&nbsp;Échec&nbsp;manuel&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">2002&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno&nbsp;</span><span style="color: #007700">||&nbsp;</span><span style="color: #0000BB">2003&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno&nbsp;</span><span style="color: #007700">||&nbsp;</span><span style="color: #0000BB">2004&nbsp;</span><span style="color: #007700">==&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Connexion&nbsp;3,&nbsp;la&nbsp;première&nbsp;connexion&nbsp;à&nbsp;l'esclave&nbsp;échoue,&nbsp;tentative&nbsp;du&nbsp;prochain&nbsp;esclave&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;VERSION()&nbsp;AS&nbsp;_version"</span><span style="color: #007700">);<br />}<br /><br />if&nbsp;(!</span><span style="color: #0000BB">$res</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"ERROR,&nbsp;[%d]&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />}&nbsp;else&nbsp;{<br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;Les&nbsp;messages&nbsp;d'erreur&nbsp;sont&nbsp;récupérés&nbsp;de&nbsp;la&nbsp;connexion&nbsp;3,&nbsp;et&nbsp;donc,&nbsp;aucune&nbsp;erreur&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"SUCCESS,&nbsp;[%d]&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_assoc</span><span style="color: #007700">();<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"version&nbsp;=&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #DD0000">'_version'</span><span style="color: #007700">]);<br />}<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>L&#039;exemple ci-dessus va afficher quelque chose de similaire à :</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
[1045] Access denied for user &#039;username&#039;@&#039;localhost&#039; (using password: YES)
PHP Warning:  mysqli::query(): php_network_getaddresses: getaddrinfo failed: Name or service not known in %s on line %d
PHP Warning:  mysqli::query(): [2002] php_network_getaddresses: getaddrinfo failed: Name or service not known (trying to connect via tcp://invalid_host_name:3306) in %s on line %d
SUCCESS, [0] &#039;&#039;
version = 5.6.2-m5-log
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Dans quelques cas, il n&#039;est pas possible facilement de récupérer toutes
   les erreurs qui surviennent sur toutes les connexions réseaux via le gestionnaire
   de connexions. Supposons qu&#039;un groupe de connexions contient 3 connexions ; une
   vers le maître et deux autres vers des esclaves. L&#039;application modifie la base
   de données courante en utilisant l&#039;appel API <span class="function"><a href="mysqli.select-db.html" class="function">mysqli_select_db()</a></span>,
   qui appelle la fonction de la bibliothèque mysqlnd pour modifier le schéma.
   mysqlnd_ms surveille la fonction et tente de changer la base de données
   courante sur toutes les connexions afin d&#039;harmoniser leurs statuts.
   Supposons que le maître arrive à changer la base de données, mais que les
   esclaves échouent. Lors de la première erreur depuis le premier esclave,
   le plugin définira une erreur appropriée sur le gestionnaire de connexions.
   La même chose est effectuée lorsque le second esclave échoue. Le message
   d&#039;erreur depuis le premier esclave est alors perdu.
  </p>
  <p class="para">
   Un tel cas peut être débogué soit en vérifiant les erreurs de type
   <code class="literal">E_WARNING</code> (voir ci-dessus), ou soit, s&#039;il n&#039;y a
   pas d&#039;autres options, en investiguant les
   <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.debugging" class="link">traces et l&#039;historique de déboguage mysqlnd_ms</a>.
  </p>
 </div></div></div></body></html>